---
- name: Check current domain membership
  ansible.windows.win_shell: |
    $cs = Get-WmiObject Win32_ComputerSystem
    $obj = [PSCustomObject]@{
      PartOfDomain = [bool]$cs.PartOfDomain
      Domain       = [string]$cs.Domain
      Name         = [string]$cs.Name
    }
    $obj | ConvertTo-Json -Compress
  register: ad_domain_state_raw
  changed_when: false

- name: Parse domain membership
  ansible.builtin.set_fact:
    ad_domain_state: "{{ ad_domain_state_raw.stdout | from_json }}"

- name: Configure DNS to point to DC (Windows)
  ansible.windows.win_shell: |
    $if = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' } | Select-Object -First 1
    if (-not $if) { throw "No active network adapter found" }
    Set-DnsClientServerAddress -InterfaceAlias $if.Name -ServerAddresses @("{{ ad_dc_ip }}")
  when:
    - ad_configure_dns | bool

- name: Join to domain (Windows) (no reboot)
  ansible.windows.win_shell: |
    $user = "{{ ad_join_user }}"
    $pass = ConvertTo-SecureString "{{ ad_join_password }}" -AsPlainText -Force
    $cred = New-Object System.Management.Automation.PSCredential($user, $pass)
    Add-Computer -DomainName "{{ ad_domain_name }}" -Credential $cred -Force -Restart:$false
  when:
    - not ad_domain_state.PartOfDomain

- name: Reboot after domain join (Windows)
  ansible.windows.win_reboot:
    reboot_timeout: 1800
  when:
    - not ad_domain_state.PartOfDomain
