---
- name: Ensure ActiveDirectory module is available (best-effort)
  ansible.windows.win_shell: |
    try { Import-Module ActiveDirectory -ErrorAction Stop; "OK" } catch { "NOAD" }
  register: ad_module
  changed_when: false

- name: Create test domain user (best-effort)
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    $u = "{{ vuln_ad_test_user }}"
    $pwd = ConvertTo-SecureString "{{ vuln_ad_weak_password }}" -AsPlainText -Force
    if (-not (Get-ADUser -Filter "SamAccountName -eq '$u'" -ErrorAction SilentlyContinue)) {
      New-ADUser -Name $u -SamAccountName $u -Enabled $true -AccountPassword $pwd -PasswordNeverExpires $true
      "CREATED"
    } else {
      "EXISTS"
    }
  when: ad_module.stdout is search("OK")
  failed_when: false

- name: Add test user to Domain Admins (insecure) (best-effort)
  ansible.windows.win_shell: |
    Import-Module ActiveDirectory
    $u = "{{ vuln_ad_test_user }}"
    try {
      Add-ADGroupMember -Identity "Domain Admins" -Members $u -ErrorAction Stop
      "ADDED"
    } catch {
      "SKIP/ERR"
    }
  when: ad_module.stdout is search("OK")
  failed_when: false

