---
# Ansible роль: Настройка файлового сервера с открытыми шарами

- name: Установка Samba
  apt:
    name:
      - samba
      - samba-common-bin
    state: present
    update_cache: yes
  become: yes

- name: Создание директорий для шаров
  file:
    path: "{{ item.path }}"
    state: directory
    mode: '0777'
    owner: nobody
    group: nogroup
  loop:
    - { path: "/srv/public-share" }
    - { path: "/srv/documents" }
    - { path: "/srv/sensitive-data" }
  become: yes

- name: Создание тестовых файлов
  copy:
    content: |
      This is a public share accessible to everyone.
      No authentication required!
      
      Database credentials:
      Host: 192.168.20.30
      User: root
      Password: root123
      Database: sensitive_data
    dest: /srv/public-share/database_credentials.txt
    mode: '0666'
    owner: nobody
    group: nogroup
  become: yes

- name: Создание небезопасной конфигурации Samba
  copy:
    content: |
      [global]
      workgroup = WORKGROUP
      server string = File Server
      security = user
      map to guest = Bad User
      dns proxy = no
      
      # Небезопасные настройки для обучения
      guest ok = yes
      guest account = nobody
      
      [public-share]
      comment = Public Share (Open to Everyone)
      path = /srv/public-share
      browseable = yes
      writable = yes
      guest ok = yes
      guest only = yes
      create mask = 0666
      directory mask = 0777
      
      [documents]
      comment = Company Documents
      path = /srv/documents
      browseable = yes
      writable = yes
      guest ok = yes
      valid users = @users
      force group = users
      create mask = 0664
      directory mask = 0775
      
      [sensitive-data]
      comment = Sensitive Data (Should be protected!)
      path = /srv/sensitive-data
      browseable = yes
      writable = yes
      guest ok = yes
      force user = nobody
      create mask = 0666
      directory mask = 0777
    dest: /etc/samba/smb.conf
    mode: '0644'
    backup: yes
  become: yes
  notify: restart samba

- name: Создание пользователя Samba с слабым паролем
  user:
    name: shareuser
    password: "{{ 'share123' | password_hash('sha512') }}"
    shell: /bin/bash
    groups: users
    append: yes
  become: yes

- name: Установка пароля Samba для пользователя
  command: echo -e "share123\nshare123" | smbpasswd -a -s shareuser
  become: yes
  no_log: true

- name: Включение SMBv1 (уязвимый протокол)
  lineinfile:
    path: /etc/samba/smb.conf
    regexp: "^\[global\]"
    line: "[global]\nserver min protocol = NT1"
    insertafter: "^\[global\]"
  become: yes
  notify: restart samba

- name: Открытие портов Samba
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "139"
    - "445"
  become: yes
  ignore_errors: yes

- name: Запуск и включение Samba
  systemd:
    name: smbd
    state: started
    enabled: yes
  become: yes

- name: Запуск и включение NetBIOS
  systemd:
    name: nmbd
    state: started
    enabled: yes
  become: yes

- name: Создание информационного файла об уязвимости
  copy:
    content: |
      # Уязвимости файлового сервера
      
      1. Открытые файловые шары без аутентификации
      2. Слабые пароли пользователей
      3. SMBv1 включен (уязвим к EternalBlue)
      4. Широкие права доступа (777)
      5. Чувствительные данные в открытом доступе
      
      Для тестирования:
      - smbclient //192.168.20.10/public-share -N
      - nmap --script smb-vuln-* 192.168.20.10
    dest: /srv/public-share/VULNERABILITY_INFO.txt
    mode: '0666'
    owner: nobody
    group: nogroup
  become: yes

