- name: Create/update Windows users
  ansible.windows.win_user:
    name: "{{ item.name }}"
    password: "{{ item.password | default(omit) }}"
    state: present
  loop: "{{ accounts_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Add users to local groups (Windows)
  ansible.windows.win_group_membership:
    name: "{{ item.1 }}"
    members:
      - "{{ item.0.name }}"
    state: present
  loop: "{{ accounts_users | subelements('groups', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.name }} -> {{ item.1 }}"
  failed_when: false

- name: Ensure admin users are in Administrators (Windows)
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ item.name }}"
    state: present
  loop: "{{ accounts_users }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.admin | default(false)
  failed_when: false

- name: Configure SSH authorized_keys for Windows users (best-effort)
  ansible.windows.win_shell: |
    $user = "{{ item.0.name }}"
    $key  = @"
{{ item.1 }}
"@.Trim()
    if (-not $key) { return }
    $home = (Get-LocalUser -Name $user | ForEach-Object { $_.Name }) | Out-Null
    $profile = "C:\Users\{0}" -f $user
    $sshDir = Join-Path $profile ".ssh"
    New-Item -Force -ItemType Directory -Path $sshDir | Out-Null
    $ak = Join-Path $sshDir "authorized_keys"
    Set-Content -Force -Path $ak -Value $key
    icacls $ak /inheritance:r /grant "$user:(R,W)" | Out-Null
  loop: "{{ accounts_users | subelements('ssh_public_keys', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.name }}"
  failed_when: false

