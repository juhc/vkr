- name: Check firewall active state (ufw/firewalld) (best-effort)
  ansible.builtin.shell: |
    active=0
    if command -v ufw >/dev/null 2>&1; then
      if ufw status 2>/dev/null | grep -qi "Status: active"; then active=1; fi
    fi
    if command -v systemctl >/dev/null 2>&1; then
      systemctl is-active --quiet firewalld && active=1 || true
      systemctl is-active --quiet ufw && active=1 || true
    fi
    echo "$active"
  register: firewall_active
  changed_when: false
  failed_when: >-
    (verify_mode == "enabled" and firewall_active.stdout | trim != "0") or
    (verify_mode == "disabled" and firewall_active.stdout | trim == "0")
