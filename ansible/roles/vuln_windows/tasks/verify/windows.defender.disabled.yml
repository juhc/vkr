- name: Check Defender realtime monitoring
  ansible.windows.win_shell: |
    try {
      $val = (Get-MpPreference).DisableRealtimeMonitoring
      if ($val -eq $true) { "DISABLED" } else { "ENABLED" }
    } catch {
      "SKIP"
    }
  register: defender_state
  changed_when: false

- name: Verify Defender state (best-effort)
  ansible.builtin.assert:
    that:
      - (verify_mode == "enabled" and defender_state.stdout | trim == "DISABLED")
        or
        (verify_mode == "disabled" and defender_state.stdout | trim == "ENABLED")
        or
        (defender_state.stdout | trim == "SKIP")
    fail_msg: >-
      Defender check failed for mode {{ verify_mode }}.
