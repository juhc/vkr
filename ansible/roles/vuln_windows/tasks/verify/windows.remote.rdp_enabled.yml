- name: Check RDP setting
  ansible.windows.win_shell: |
    $val = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server").fDenyTSConnections
    if ($val -eq 0) { "ENABLED" } else { "DISABLED" }
  register: rdp_state
  changed_when: false

- name: Verify RDP state
  ansible.builtin.assert:
    that:
      - (verify_mode == "enabled" and rdp_state.stdout | trim == "ENABLED")
        or
        (verify_mode == "disabled" and rdp_state.stdout | trim == "DISABLED")
    fail_msg: >-
      RDP check failed for mode {{ verify_mode }}.
