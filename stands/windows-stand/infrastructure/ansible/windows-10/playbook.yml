---
# Ansible playbook для настройки уязвимостей на рабочей станции Windows
# Поддерживаемые ОС: Windows XP, Windows 7, Windows 10, Windows 11

- name: Настройка уязвимостей на рабочей станции Windows
  hosts: windows_workstation
  gather_facts: yes
  tasks:
    - name: Проверка версии Windows
      ansible.windows.win_shell: |
        (Get-WmiObject Win32_OperatingSystem).Caption
      register: windows_version
      changed_when: false

    - name: Вывод версии Windows
      ansible.builtin.debug:
        msg: "Обнаружена ОС: {{ windows_version.stdout }}"

    - name: Настроить сетевые параметры Windows WS (gateway + DNS)
      ansible.windows.win_shell: |
        $desiredGateway = "{{ windows_gateway }}"
        $dnsServers = '{{ windows_dns_servers | to_json }}' | ConvertFrom-Json
        if ($dnsServers -is [string]) { $dnsServers = @($dnsServers) }

        $cfg = Get-NetIPConfiguration |
          Where-Object { $_.IPv4Address -and $_.NetAdapter.Status -eq 'Up' -and $_.InterfaceAlias -notmatch 'Loopback|vEthernet' } |
          Select-Object -First 1

        if (-not $cfg) {
          throw "No active network adapter with IPv4 found."
        }

        if (-not $cfg.IPv4DefaultGateway -and $desiredGateway -ne "") {
          New-NetRoute -DestinationPrefix "0.0.0.0/0" -InterfaceIndex $cfg.InterfaceIndex -NextHop $desiredGateway -RouteMetric 10 -ErrorAction SilentlyContinue | Out-Null
        }

        if ($dnsServers.Count -gt 0) {
          Set-DnsClientServerAddress -InterfaceIndex $cfg.InterfaceIndex -ServerAddresses $dnsServers
        }

        $gw = (Get-NetIPConfiguration -InterfaceIndex $cfg.InterfaceIndex).IPv4DefaultGateway.NextHop
        $dns = (Get-DnsClientServerAddress -InterfaceIndex $cfg.InterfaceIndex -AddressFamily IPv4).ServerAddresses
        Write-Output ("Gateway={0}; DNS={1}" -f $gw, ($dns -join ","))
      vars:
        windows_gateway: "{{ ((windows_network | default({})).gateway | default('192.168.101.1')) }}"
        windows_external_dns: "{{ ((windows_network | default({})).external_dns_servers | default(['1.1.1.1', '8.8.8.8'])) }}"
        windows_dns_servers: "{{ ([ad_dc_ip] if ((ad_join_profiles.windows_workstation | default(false)) | bool) else []) + windows_external_dns }}"
      changed_when: false
      failed_when: false

    - name: Настроить пользователей/группы (Windows WS)
      ansible.builtin.import_role:
        name: accounts
      vars:
        accounts_users: "{{ ((accounts_profiles | default({})).windows_workstation.users | default([])) }}"

    - name: Присоединить Windows WS к домену AD
      ansible.builtin.import_role:
        name: ad_join
      vars:
        ad_join_enabled: "{{ (ad_join_profiles.windows_workstation | default(false)) | bool }}"

    - name: Force gpupdate after domain join (best-effort)
      ansible.windows.win_shell: |
        gpupdate /force
      changed_when: false
      failed_when: false

    - name: Применить профиль уязвимостей (Windows WS)
      ansible.builtin.import_role:
        name: vuln_windows
      vars:
        vuln_enabled: "{{ vuln_profiles.windows_workstation | default([]) }}"
