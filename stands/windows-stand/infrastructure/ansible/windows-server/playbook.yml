---
# Ansible playbook для настройки уязвимостей на Windows Server
# Поддерживаемые версии: Windows Server 2016, 2019, 2022

- name: Настройка уязвимостей на Windows Server
  hosts: windows_server
  gather_facts: yes
  tasks:
    - name: Проверка версии Windows Server
      ansible.windows.win_shell: |
        (Get-WmiObject Win32_OperatingSystem).Caption
      register: windows_version
      changed_when: false

    - name: Вывод версии Windows Server
      ansible.builtin.debug:
        msg: "Обнаружена ОС: {{ windows_version.stdout }}"

    - name: Настроить пользователей/группы (Windows Server)
      ansible.builtin.import_role:
        name: vkr_accounts
      vars:
        vkr_accounts_users: "{{ ((accounts_profiles | default({})).windows_server.users | default([])) }}"

    - name: Присоединить Windows Server к домену AD
      ansible.builtin.import_role:
        name: vkr_ad_join
      vars:
        vkr_ad_join_enabled: "{{ (vkr_ad_join_profiles.windows_server | default(false)) | bool }}"

    - name: Force gpupdate after domain join (best-effort)
      ansible.windows.win_shell: |
        gpupdate /force
      changed_when: false
      failed_when: false

    - name: Применить профиль уязвимостей (Windows Server)
      ansible.builtin.import_role:
        name: vkr_vuln_windows
      vars:
        vuln_enabled: "{{ vuln_profiles.windows_server | default([]) }}"
