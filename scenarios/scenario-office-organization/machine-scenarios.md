# Сценарии для виртуальных машин организации

## Обзор сценариев

Каждый сервер в инфраструктуре организации настроен с определенными уязвимостями и ошибками конфигурации для практического обучения. Ниже описаны сценарии для каждой машины.

## DMZ серверы

### 1. Web Server (192.168.10.10)

#### Описание
Основной веб-сервер организации, на котором размещен корпоративный сайт и веб-приложения.

#### Конфигурация
- **ОС**: Ubuntu 20.04 LTS
- **Веб-сервер**: Apache 2.4.29 (уязвимая версия)
- **PHP**: 7.4
- **Приложение**: Java веб-приложение с Log4j 2.14.1

#### Уязвимости
1. **Log4Shell (CVE-2021-44228)**
   - Уязвимая версия Log4j 2.14.1
   - JNDI lookup включен
   - Возможность удаленного выполнения кода

2. **Устаревший Apache**
   - Версия 2.4.29 с известными уязвимостями
   - Отсутствие обновлений безопасности

3. **Небезопасная конфигурация Apache**
   - `ServerTokens Full` - раскрытие версии
   - `ServerSignature On` - раскрытие информации о сервере
   - Открытые директории без индексов

4. **Открытые порты**
   - Порт 80 (HTTP)
   - Порт 443 (HTTPS)
   - Порт 8080 (Веб-приложение)

#### Сценарий обучения
1. **Обнаружение уязвимости**
   - Сканирование версий Apache и зависимостей
   - Обнаружение Log4j 2.14.1 через анализ JAR файлов
   - Использование сканеров уязвимостей (Nmap, Nuclei)

2. **Эксплуатация**
   - Создание JNDI payload
   - Получение обратной оболочки через Log4Shell
   - Повышение привилегий на сервере

3. **Устранение**
   - Обновление Log4j до версии 2.17.0+
   - Обновление Apache до последней версии
   - Исправление конфигурации Apache

#### Упражнения
- Обнаружение уязвимости Log4Shell
- Эксплуатация уязвимости для получения доступа
- Анализ логов на предмет попыток эксплуатации
- Устранение уязвимости и валидация исправления

---

### 2. Mail Server (192.168.10.20)

#### Описание
Корпоративный почтовый сервер для внутренней и внешней переписки.

#### Конфигурация
- **ОС**: Ubuntu 20.04 LTS
- **MTA**: Postfix 3.4
- **MDA**: Dovecot 2.3
- **SMTP**: Порт 25, 587
- **IMAP/POP3**: Порт 993, 995

#### Уязвимости
1. **Небезопасная конфигурация SMTP**
   - Открытый релей для всех доменов
   - Отсутствие аутентификации для локальных пользователей
   - Слабые пароли для почтовых ящиков

2. **Открытые порты**
   - SMTP порты доступны из интернета без ограничений
   - Отсутствие rate limiting

3. **Устаревшие протоколы**
   - Поддержка TLS 1.0 и 1.1
   - Слабые cipher suites

#### Сценарий обучения
1. **Обнаружение**
   - Тестирование конфигурации SMTP
   - Проверка возможности открытого релея
   - Анализ конфигурационных файлов

2. **Эксплуатация**
   - Использование открытого релея для рассылки спама
   - Перехват почтового трафика
   - Брутфорс паролей почтовых ящиков

3. **Устранение**
   - Настройка правильной конфигурации SMTP
   - Включение аутентификации
   - Обновление TLS до версии 1.2+

---

### 3. DNS Server (192.168.10.30)

#### Описание
Внутренний DNS сервер для разрешения имен в домене techservice.local.

#### Конфигурация
- **ОС**: Ubuntu 20.04 LTS
- **DNS**: BIND9 9.16
- **Порт**: 53 UDP/TCP

#### Уязвимости
1. **Открытый рекурсивный DNS**
   - Рекурсивные запросы разрешены для всех
   - Возможность использования для DNS amplification атак

2. **Небезопасная конфигурация**
   - Отсутствие rate limiting
   - Открытая зона для перечисления

#### Сценарий обучения
1. **Обнаружение**
   - Тестирование рекурсивных запросов
   - Проверка конфигурации BIND

2. **Эксплуатация**
   - Использование для DNS amplification
   - Перечисление внутренних хостов
   - DNS cache poisoning

3. **Устранение**
   - Ограничение рекурсивных запросов
   - Настройка rate limiting
   - Защита зон

---

## Внутренние серверы

### 4. File Server (192.168.20.10)

#### Описание
Файловый сервер для хранения общих документов и файлов организации.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **Samba**: 4.11
- **NFS**: v4
- **Порты**: 139, 445, 2049

#### Уязвимости
1. **Открытые файловые шары**
   - Шары с правами записи для всех (`guest ok = yes`)
   - Отсутствие аутентификации
   - Публичные директории с чувствительными данными

2. **Слабые пароли**
   - Пароли по умолчанию
   - Простые пароли пользователей

3. **Небезопасные протоколы**
   - SMBv1 включен
   - Отсутствие шифрования

#### Сценарий обучения
1. **Обнаружение**
   - Перечисление файловых шаров
   - Проверка прав доступа
   - Поиск чувствительных данных

2. **Эксплуатация**
   - Доступ к файлам без аутентификации
   - Модификация файлов
   - Кража данных

3. **Устранение**
   - Настройка правильных прав доступа
   - Включение аутентификации
   - Отключение SMBv1

---

### 5. Domain Controller (192.168.20.20)

#### Описание
Контроллер домена Active Directory для централизованной аутентификации.

#### Конфигурация
- **ОС**: Windows Server 2019
- **AD DS**: Установлен
- **DNS**: Встроенный
- **DHCP**: Встроенный
- **Порты**: 53, 88, 135, 389, 445, 636

#### Уязвимости
1. **SMBv1 включен**
   - Устаревший протокол с известными уязвимостями
   - Возможность использования EternalBlue

2. **Слабые пароли администраторов**
   - Простые пароли для учетных записей администраторов
   - Отсутствие политики сложности паролей

3. **Небезопасная конфигурация LDAP**
   - LDAP без SSL/TLS
   - Анонимный доступ разрешен

#### Сценарий обучения
1. **Обнаружение**
   - Перечисление пользователей домена
   - Обнаружение SMBv1
   - Тестирование паролей

2. **Эксплуатация**
   - Использование слабых паролей для получения доступа
   - Перечисление домена
   - Повышение привилегий

3. **Устранение**
   - Отключение SMBv1
   - Настройка политики паролей
   - Включение LDAPS

---

### 6. Database Server (192.168.20.30)

#### Описание
Основной сервер базы данных для веб-приложений и внутренних систем.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **MySQL**: 5.7
- **Порт**: 3306

#### Уязвимости
1. **Слабый пароль root**
   - Пароль: `root123`
   - Удаленный доступ разрешен

2. **Отсутствие шифрования**
   - Соединения без SSL/TLS
   - Данные передаются в открытом виде

3. **Избыточные привилегии**
   - Пользователи с правами ALL
   - Отсутствие разделения привилегий

#### Сценарий обучения
1. **Обнаружение**
   - Сканирование портов MySQL
   - Тестирование подключения
   - Брутфорс паролей

2. **Эксплуатация**
   - Подключение с учетными данными по умолчанию
   - Извлечение данных
   - SQL инъекции (если есть уязвимые приложения)

3. **Устранение**
   - Изменение пароля root
   - Ограничение удаленного доступа
   - Включение SSL/TLS

---

### 7. Backup Server (192.168.20.40)

#### Описание
Сервер резервного копирования для хранения бэкапов всех систем.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **Rsync**: Последняя версия
- **BackupPC**: Установлен
- **Порты**: 22, 873

#### Уязвимости
1. **SSH доступ по паролю**
   - Отключена аутентификация по ключам
   - Слабые пароли

2. **Нешифрованные бэкапы**
   - Бэкапы хранятся без шифрования
   - Доступны в открытом виде

3. **Отсутствие контроля доступа**
   - Широкий доступ к бэкапам
   - Отсутствие аудита

#### Сценарий обучения
1. **Обнаружение**
   - Поиск сервера резервного копирования
   - Тестирование SSH доступа
   - Перечисление бэкапов

2. **Эксплуатация**
   - Доступ к бэкапам через SSH
   - Извлечение данных из бэкапов
   - Компрометация других систем через бэкапы

3. **Устранение**
   - Включение аутентификации по ключам
   - Шифрование бэкапов
   - Ограничение доступа

---

### 8. Monitoring Server (192.168.20.50)

#### Описание
Сервер мониторинга инфраструктуры с Prometheus, Grafana и Nagios.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **Prometheus**: 2.30
- **Grafana**: 8.0
- **Nagios**: 4.4
- **Порты**: 9090, 3000, 5666

#### Уязвимости
1. **Открытый веб-интерфейс**
   - Grafana без аутентификации
   - Prometheus доступен без пароля
   - Раскрытие метрик и логов

2. **Слабые пароли**
   - Простые пароли для администраторов
   - Пароли по умолчанию

3. **Раскрытие информации**
   - Метрики содержат чувствительную информацию
   - Логи доступны без ограничений

#### Сценарий обучения
1. **Обнаружение**
   - Поиск серверов мониторинга
   - Доступ к веб-интерфейсам
   - Анализ метрик

2. **Эксплуатация**
   - Извлечение информации из метрик
   - Изменение конфигурации через Grafana
   - Использование информации для дальнейших атак

3. **Устранение**
   - Включение аутентификации
   - Ограничение доступа
   - Шифрование трафика

---

## Серверы разработки

### 9. Development Server (192.168.30.10)

#### Описание
Сервер разработки с GitLab, Docker и тестовыми приложениями.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **GitLab**: 14.0
- **Docker**: 20.10
- **Порты**: 80, 443, 22, 2375

#### Уязвимости
1. **Открытый Docker API**
   - Docker API доступен без аутентификации (порт 2375)
   - Возможность удаленного управления контейнерами

2. **Открытые Git репозитории**
   - Публичные репозитории с учетными данными
   - Учетные данные в открытом виде в коде

3. **Уязвимые версии Docker**
   - Известные уязвимости в версии Docker
   - Устаревшие образы контейнеров

#### Сценарий обучения
1. **Обнаружение**
   - Обнаружение открытого Docker API
   - Поиск учетных данных в репозиториях
   - Анализ конфигурации

2. **Эксплуатация**
   - Управление контейнерами через API
   - Извлечение учетных данных из репозиториев
   - Компрометация контейнеров

3. **Устранение**
   - Защита Docker API
   - Удаление учетных данных из репозиториев
   - Обновление Docker

---

### 10. Test Server (192.168.30.20)

#### Описание
Сервер тестирования с тестовыми приложениями и базами данных.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **PostgreSQL**: 12
- **Тестовые приложения**: Различные версии
- **Порты**: 80, 5432

#### Уязвимости
1. **Тестовые данные в открытом виде**
   - Производственные данные в тестовой среде
   - Отсутствие анонимизации данных

2. **Слабые пароли**
   - Простые пароли для тестовых БД
   - Пароли по умолчанию

3. **Отсутствие изоляции**
   - Тестовая среда имеет доступ к production
   - Общие учетные данные

#### Сценарий обучения
1. **Обнаружение**
   - Доступ к тестовой среде
   - Анализ тестовых данных
   - Поиск связей с production

2. **Эксплуатация**
   - Извлечение тестовых данных
   - Использование данных для атак на production
   - Компрометация через тестовую среду

3. **Устранение**
   - Изоляция тестовой среды
   - Анонимизация данных
   - Отдельные учетные данные

---

### 11. CI/CD Server (192.168.30.30)

#### Описание
Сервер непрерывной интеграции и развертывания с Jenkins и GitLab CI.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **Jenkins**: 2.303
- **GitLab CI**: Runner установлен
- **Порты**: 8080, 22

#### Уязвимости
1. **Открытый интерфейс Jenkins**
   - Jenkins доступен без аутентификации
   - Возможность выполнения произвольных команд

2. **Credentials в открытом виде**
   - Учетные данные хранятся в конфигурационных файлах
   - Пароли в логах сборки

3. **Небезопасные pipeline**
   - Pipeline выполняются с высокими привилегиями
   - Отсутствие проверок безопасности

#### Сценарий обучения
1. **Обнаружение**
   - Доступ к Jenkins без аутентификации
   - Поиск credentials в конфигурации
   - Анализ pipeline

2. **Эксплуатация**
   - Выполнение команд через Jenkins
   - Извлечение credentials
   - Компрометация через CI/CD

3. **Устранение**
   - Включение аутентификации
   - Безопасное хранение credentials
   - Ограничение привилегий

---

## Управляющие серверы

### 12. Jump Server (192.168.40.10)

#### Описание
Jump-сервер для безопасного доступа администраторов к инфраструктуре.

#### Конфигурация
- **ОС**: Ubuntu Server 20.04
- **SSH**: OpenSSH 8.2
- **OpenVPN**: Установлен
- **Порты**: 22, 1194

#### Уязвимости
1. **Доступ по паролю**
   - SSH доступ по паролю разрешен
   - Отсутствие аутентификации по ключам

2. **Отсутствие 2FA**
   - Двухфакторная аутентификация не настроена
   - Только парольная аутентификация

3. **Широкий доступ**
   - Доступ к jump-серверу без ограничений
   - Отсутствие аудита сессий

#### Сценарий обучения
1. **Обнаружение**
   - Поиск jump-сервера
   - Тестирование SSH доступа
   - Брутфорс паролей

2. **Эксплуатация**
   - Доступ к jump-серверу
   - Использование как плацдарма для дальнейших атак
   - Компрометация всей инфраструктуры

3. **Устранение**
   - Включение аутентификации по ключам
   - Настройка 2FA
   - Ограничение доступа и аудит

---

## Комплексные сценарии

### Сценарий A: Компрометация через веб-сервер
1. Эксплуатация Log4Shell на web-server
2. Получение обратной оболочки
3. Перемещение к db-server через скомпрометированные учетные данные
4. Извлечение данных из базы данных
5. Использование данных для дальнейших атак

### Сценарий B: Распространение через файловый сервер
1. Доступ к file-server через открытые шары
2. Кража учетных данных из файлов
3. Использование учетных данных для доступа к другим системам
4. Компрометация всей инфраструктуры

### Сценарий C: Инсайдерская угроза
1. Злоупотребление привилегиями пользователя
2. Доступ к чувствительным данным
3. Утечка данных через открытые сервисы
4. Обнаружение и расследование инцидента

## Методические рекомендации

### Для начинающих
- Начните с простых сценариев (слабые пароли, открытые порты)
- Используйте готовые инструменты для сканирования
- Фокусируйтесь на обнаружении уязвимостей

### Для среднего уровня
- Комбинируйте несколько уязвимостей
- Используйте цепочки атак
- Фокусируйтесь на эксплуатации и пост-эксплуатации

### Для продвинутых
- Создавайте собственные эксплойты
- Проводите комплексные пентесты
- Фокусируйтесь на обнаружении и реагировании на инциденты

