# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã ISP –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ Proxmox

–≠—Ç–æ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ Proxmox VE.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ Proxmox

1. **Proxmox VE 6.0+** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
2. **API –¥–æ—Å—Ç—É–ø** –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —Ç–æ–∫–µ–Ω–æ–º
3. **–®–∞–±–ª–æ–Ω—ã –í–ú** —Å–æ–∑–¥–∞–Ω—ã:
   - Ubuntu 20.04 template (–¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤)
   - Kali Linux template (–¥–ª—è –º–∞—à–∏–Ω—ã –∞—Ç–∞–∫—É—é—â–µ–≥–æ)

### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **Terraform 1.0+**
2. **–î–æ—Å—Ç—É–ø –∫ API Proxmox** (—Ç–æ–∫–µ–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–ø–∞—Ä–æ–ª—å)

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Proxmox

### 1. –°–æ–∑–¥–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞

1. –í–æ–π–¥–∏—Ç–µ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Proxmox
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Datacenter ‚Üí Permissions ‚Üí API Tokens**
3. –ù–∞–∂–º–∏—Ç–µ **Add**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **Token ID**: `terraform@pve!terraform-token`
   - **User**: –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ)
   - **Privilege Separation**: –≤–∫–ª—é—á–∏—Ç–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ **Token Secret** (–æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ Ubuntu

```bash
# –ù–∞ Proxmox —Å–µ—Ä–≤–µ—Ä–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

# 1. –°–∫–∞—á–∞–π—Ç–µ Ubuntu Cloud Image
wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img

# 2. –°–æ–∑–¥–∞–π—Ç–µ –í–ú —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ CLI:
qm create 9000 --name ubuntu-20.04-template --memory 2048 --net0 virtio,bridge=vmbr0
qm importdisk 9000 focal-server-cloudimg-amd64.img local-lvm
qm set 9000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0
qm set 9000 --ide2 local-lvm:cloudinit
qm set 9000 --boot c --bootdisk scsi0
qm set 9000 --serial0 socket --vga serial0
qm template 9000
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ Kali Linux

```bash
# –°–∫–∞—á–∞–π—Ç–µ –æ–±—Ä–∞–∑ Kali Linux
wget https://cdimage.kali.org/kali-2023.4/kali-linux-2023.4-qemu-amd64.qcow2

# –°–æ–∑–¥–∞–π—Ç–µ –í–ú –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –≤ —à–∞–±–ª–æ–Ω –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Ubuntu
```

## –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

**üìñ –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–º—É —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É**: [FIRST_RUN.md](FIRST_RUN.md)

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –≤–∫–ª—é—á–∞–µ—Ç:
- –ü–æ—à–∞–≥–æ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É Proxmox
- –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π–∫—É Terraform
- –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –º–∞—à–∏–Ω—ã
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

### 1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
cd scenarios/scenario-isp-company/infrastructure/terraform/proxmox
cp terraform.tfvars.example terraform.tfvars
```

### 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ terraform.tfvars

–û—Ç–∫—Ä–æ–π—Ç–µ `terraform.tfvars` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```hcl
proxmox_api_url          = "https://your-proxmox-server:8006/api2/json"
proxmox_api_token_id     = "terraform@pve!terraform-token"
proxmox_api_token_secret = "your-secret-here"
proxmox_target_node      = "proxmox-node-1"
proxmox_template_name    = "ubuntu-20.04-template"
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å SSH –∫–ª—é—á:

```bash
# –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ:
ssh-keygen -t ed25519 -C "terraform@proxmox"

# –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤ terraform.tfvars:
ssh_public_key = file("~/.ssh/id_ed25519.pub")
```

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform

```bash
terraform init
```

### 2. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
terraform plan
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
terraform apply
```

Terraform —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã –Ω–∞ Proxmox.

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –í–ú

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å IP –∞–¥—Ä–µ—Å–∞
terraform output vm_ips

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–∞ –í–ú
terraform output vm_names
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å Ansible

–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Terraform, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–≤–æ–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Ansible inventory:

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è inventory –∏–∑ Terraform outputs
terraform output -json vm_ips | jq -r '
  to_entries | .[] | 
  "\(.key) ansible_host=\(.value)"
' > ../../ansible/inventory.ini
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π inventory –Ω–∞ –æ—Å–Ω–æ–≤–µ Terraform state.

## –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
terraform destroy
```

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ**: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã!

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏

–ï—Å–ª–∏ —É –≤–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∞—à–∏–Ω—ã –ø–æ –æ–¥–Ω–æ–π:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
   ```bash
   ./deploy-single-vm.sh
   ```

2. **–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ä—É—á–Ω—É—é** –≤ `terraform.tfvars`:
   ```hcl
   enable_radius_server    = true
   enable_billing_server   = false
   enable_web_server       = false
   # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ false
   ```

–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: [TESTING.md](TESTING.md)

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –ø–æ—Ä—Ç (–æ–±—ã—á–Ω–æ 8006)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
3. –î–ª—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `proxmox_tls_insecure = true`

### –í–ú –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —à–∞–±–ª–æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É–∑–µ–ª —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ç–µ–≤–æ–π –º–æ—Å—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VLAN (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ IP –∞–¥—Ä–µ—Å–∞ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ Proxmox](https://registry.terraform.io/providers/telmate/proxmox/latest/docs)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Proxmox VE](https://pve.proxmox.com/pve-docs/)
- [–û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è](../DEPLOYMENT.md)

