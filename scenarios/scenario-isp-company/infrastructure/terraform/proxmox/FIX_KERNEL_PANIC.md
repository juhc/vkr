# Исправление Kernel Panic: IO-APIC + timer doesn't work

## Проблема

Ошибка при загрузке виртуальной машины:
```
Kernel panic - not syncing: IO-APIC + timer doesn't work
```

Эта ошибка возникает при использовании эмуляции QEMU (без KVM) с типом CPU `qemu64`.

## Решение 1: Изменение типа CPU (автоматически применено)

В конфигурации Terraform изменен тип CPU с `qemu64` на `kvm64`:

```hcl
cpu {
  cores  = var.cpu
  sockets = 1
  type   = "kvm64"  # Используем kvm64 для лучшей совместимости
}
```

Это должно решить проблему для большинства случаев.

## Решение 2: Ручная настройка через веб-интерфейс Proxmox

Если автоматическое решение не помогло:

1. **Откройте веб-интерфейс Proxmox**
2. **Перейдите**: Datacenter → pve → VMs → [ваша машина]
3. **Остановите машину** (если запущена)
4. **Нажмите на машину → Hardware → Options**
5. **Измените настройки**:
   - **Machine**: `q35` (вместо `i440fx`)
   - **BIOS**: `SeaBIOS` (если не установлено)
   - **Qemu Guest Agent**: можно отключить временно
6. **Перейдите в Hardware → Processors**:
   - **Type**: `kvm64` или `host`
7. **Сохраните изменения**
8. **Запустите машину**

## Решение 3: Добавление аргументов QEMU (требует root)

Если у вас есть права root, можно добавить аргументы QEMU:

1. **Через веб-интерфейс Proxmox**:
   - Datacenter → pve → VMs → [машина] → Options → QEMU Guest Agent
   - В разделе "Advanced" добавьте аргументы:
     ```
     -no-hpet -no-acpi
     ```

2. **Через командную строку Proxmox** (SSH):
   ```bash
   qm set <VMID> --args "-no-hpet -no-acpi -machine type=q35,accel=tcg"
   ```

**Важно**: Параметр `args` требует прав root, поэтому через Terraform API токен это не работает.

## Решение 4: Включение KVM (если доступно)

Если на хосте доступен KVM:

1. **Проверьте поддержку KVM**:
   ```bash
   # На хосте Proxmox
   lsmod | grep kvm
   ```

2. **Измените в Terraform**:
   ```hcl
   kvm = true  # Вместо false
   cpu {
     type = "host"  # Используем тип хоста
   }
   ```

## Решение 5: Использование другого шаблона

Проблема может быть в шаблоне. Попробуйте:

1. **Создать новый шаблон** с правильными настройками
2. **Использовать готовый шаблон** из Proxmox (если доступен)
3. **Создать VM вручную** с правильными настройками, затем преобразовать в шаблон

## Проверка после исправления

После применения исправлений:

1. **Остановите машину** в Proxmox
2. **Запустите машину снова**
3. **Проверьте консоль** - Kernel panic должен исчезнуть
4. **Проверьте загрузку** - система должна загрузиться нормально

## Дополнительные настройки

Если проблема сохраняется, попробуйте:

- **Изменить BIOS**: `seabios` вместо `ovmf`
- **Изменить Machine**: `q35` вместо `i440fx`
- **Отключить QEMU Guest Agent** временно
- **Использовать меньше CPU**: иногда помогает уменьшить количество ядер

---

**Примечание**: В текущей конфигурации Terraform автоматически используется тип CPU `kvm64`, что должно решить проблему для большинства случаев.

