# Скрипт автоматической проверки исправлений уязвимостей

## Описание

Скрипт `verify-fixes.sh` автоматически проверяет исправления уязвимостей на всех машинах сценария ISP компании. Он выполняет проверки через SSH и выводит результаты в удобном формате.

## Требования

- **Bash** 4.0 или новее
- **SSH доступ** ко всем машинам сценария
- **SSH ключ** для аутентификации
- **curl** (для проверки веб-серверов)

## Установка

1. Сделайте скрипт исполняемым:
```bash
chmod +x verify-fixes.sh
```

2. Убедитесь, что SSH ключ настроен:
```bash
ssh-add ~/.ssh/id_rsa
```

## Использование

### Базовое использование

```bash
# Проверить все машины
./verify-fixes.sh

# Проверить только RADIUS сервер
./verify-fixes.sh -m radius-server

# Подробный вывод
./verify-fixes.sh -v

# Только результаты (минимальный вывод)
./verify-fixes.sh -q

# Сохранить результаты в файл
./verify-fixes.sh -o results.txt
```

### Опции

| Опция | Описание |
|-------|----------|
| `-h, --help` | Показать справку |
| `-v, --verbose` | Подробный вывод (показывает все проверки) |
| `-q, --quiet` | Только результаты (минимальный вывод) |
| `-m, --machine MACHINE` | Проверить только указанную машину |
| `-o, --output FILE` | Сохранить результаты в файл |
| `-u, --user USER` | Пользователь SSH (по умолчанию: ubuntu) |
| `-k, --key KEY` | Путь к SSH ключу (по умолчанию: ~/.ssh/id_rsa) |

### Примеры

```bash
# Проверка всех машин с подробным выводом
./verify-fixes.sh -v

# Проверка только биллингового сервера
./verify-fixes.sh -m billing-server

# Проверка с сохранением результатов
./verify-fixes.sh -o student1-results.txt

# Проверка с другим пользователем SSH
./verify-fixes.sh -u admin -k ~/.ssh/admin_key

# Комбинирование опций
./verify-fixes.sh -v -m web-server -o web-results.txt
```

## Что проверяет скрипт

### RADIUS сервер (192.168.10.10)

- ✅ SSH подключение
- ✅ Пароль MySQL изменен (слабый пароль не работает)
- ✅ MySQL доступ только с localhost
- ✅ Rate limiting в FreeRADIUS настроен
- ✅ Системные обновления установлены
- ✅ Пароли клиентов зашифрованы

### Биллинговый сервер (192.168.20.10)

- ✅ SSH подключение
- ✅ Защита от SQL инъекций (попытка эксплуатации)
- ✅ Пароль PostgreSQL изменен
- ✅ Использование prepared statements
- ✅ Системные обновления установлены

### Веб-сервер (192.168.20.20)

- ✅ SSH подключение
- ✅ Версия WordPress обновлена
- ✅ Защита от XSS
- ✅ Конфигурация Apache безопасна
- ✅ Системные обновления установлены

### Сервер мониторинга (192.168.30.10)

- ✅ SSH подключение
- ✅ SNMP community strings изменены
- ✅ Zabbix требует аутентификацию
- ✅ Системные обновления установлены

### Jump-сервер (192.168.30.20)

- ✅ SSH подключение
- ✅ SSH аутентификация по паролю отключена
- ✅ Защита от брутфорса настроена (fail2ban)
- ✅ Системные обновления установлены

### Компьютер администратора (192.168.30.30)

- ✅ SSH подключение
- ✅ SMB папки защищены
- ✅ Антивирус установлен
- ✅ Системные обновления установлены

## Формат вывода

### Пример успешной проверки

```
╔══════════════════════════════════════════════════════════╗
║  Автоматическая проверка исправлений уязвимостей         ║
╚══════════════════════════════════════════════════════════╝

=== Проверка RADIUS сервера (192.168.10.10) ===
✓ SSH подключение
✓ Пароль MySQL изменен
✓ MySQL доступ только с localhost
✓ Rate limiting в FreeRADIUS
✓ Системные обновления установлены
✓ Пароли клиентов зашифрованы

╔══════════════════════════════════════════════════════════╗
║  Итоговая статистика                                      ║
╚══════════════════════════════════════════════════════════╝

Всего проверок: 30
Успешно: 28
Провалено: 2
Процент успешных проверок: 93%
Оценка: Отлично (5)
```

### Пример с ошибками

```
=== Проверка RADIUS сервера (192.168.10.10) ===
✓ SSH подключение
✗ Пароль MySQL изменен
  → Слабый пароль 'radius123' все еще работает
✓ MySQL доступ только с localhost
✗ Rate limiting в FreeRADIUS
  → Rate limiting не настроен
✓ Системные обновления установлены
✓ Пароли клиентов зашифрованы
```

## Коды возврата

- `0` - Все проверки пройдены успешно
- `1` - Обнаружены ошибки или проблемы

## Использование в автоматизации

Скрипт можно использовать в CI/CD или для массовой проверки:

```bash
# Проверка всех студентов
for student in student1 student2 student3; do
    echo "Проверка студента: $student"
    ./verify-fixes.sh -o "${student}-results.txt"
done

# Проверка с отправкой результатов
./verify-fixes.sh -o results.txt && mail -s "Результаты проверки" teacher@example.com < results.txt
```

## Расширение скрипта

Для добавления новых проверок:

1. Создайте функцию проверки:
```bash
check_new_server() {
    local host="new-server"
    local ip="192.168.40.10"
    
    log "\n${BLUE}=== Проверка нового сервера ($ip) ===${NC}"
    
    if ! check_ssh_connection "$host"; then
        check_result "SSH подключение" "FAIL"
        return 1
    fi
    check_result "SSH подключение" "PASS"
    
    # Ваши проверки здесь
    check_result "Новая проверка" "PASS" "Детали проверки"
}
```

2. Добавьте вызов в главную функцию:
```bash
case "$machine" in
    "new-server")
        check_new_server
        ;;
esac
```

## Устранение проблем

### Ошибка: "Permission denied (publickey)"

**Решение**: Проверьте SSH ключ и права доступа:
```bash
chmod 600 ~/.ssh/id_rsa
ssh-add ~/.ssh/id_rsa
```

### Ошибка: "Connection timeout"

**Решение**: Убедитесь, что машины запущены и доступны:
```bash
ping 192.168.10.10
ssh ubuntu@192.168.10.10
```

### Ошибка: "Command not found"

**Решение**: Установите необходимые инструменты:
```bash
# На машинах сценария
sudo apt update
sudo apt install -y mysql-client postgresql-client curl
```

## Интеграция с другими инструментами

### Ansible

Используйте скрипт в Ansible playbook:

```yaml
- name: Проверка исправлений
  shell: ./verify-fixes.sh -o /tmp/results.txt
  args:
    chdir: /path/to/scripts
```

### Jenkins

Добавьте в Jenkins pipeline:

```groovy
stage('Verify Fixes') {
    steps {
        sh './infrastructure/scripts/verify-fixes.sh -o results.txt'
        archiveArtifacts 'results.txt'
    }
}
```

## Дополнительные ресурсы

- **[HOW_TO_EVALUATE.md](../../docs/assessment/HOW_TO_EVALUATE.md)** - Полное руководство по проверке результатов
- **[CHECKLISTS.md](../../docs/assessment/CHECKLISTS.md)** - Детальные чек-листы
- **[SOLUTIONS.md](../../docs/assessment/SOLUTIONS.md)** - Правильные решения

---

**Примечание**: Скрипт предназначен для использования преподавателями для проверки исправлений студентов. Не предоставляйте студентам доступ к исходному коду скрипта, чтобы они не могли обойти проверки.

