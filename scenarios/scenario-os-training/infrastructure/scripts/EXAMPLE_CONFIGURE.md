# Пример использования configure-vulnerabilities.sh

## Сценарий: Настройка уязвимостей для начинающих

Данный пример демонстрирует пошаговую настройку уязвимостей через интерактивный скрипт для уровня "Начинающий".

---

## Шаг 1: Запуск скрипта

```bash
cd infrastructure/scripts
chmod +x configure-vulnerabilities.sh
./configure-vulnerabilities.sh
```

**Вывод:**
```
========================================
  Настройка уязвимостей учебной инфраструктуры
========================================

Выберите действие:

  1) Настроить уязвимости Ubuntu Server
  2) Настроить уязвимости Windows Server 2016
  3) Настроить уязвимости Windows 10 Pro
  4) Предустановленные профили (Начинающий/Средний/Продвинутый)
  5) Просмотр текущей конфигурации
  6) Предпросмотр конфигурации
  7) Сохранить конфигурацию
  8) Выход

Ваш выбор: 
```

---

## Шаг 2: Использование предустановленного профиля

**Ввод:** `4`

**Вывод:**
```
========================================
  Настройка уязвимостей учебной инфраструктуры
========================================

Предустановленные профили

  1) Начинающий (базовые уязвимости)
     - Ubuntu: категории 1-4 (Аутентификация, SSH, Сеть, Обновления)
     - Windows Server: категории 1-2 (Аутентификация, GPO)
     - Windows Client: уязвимости 1-4

  2) Средний уровень
     - Ubuntu: категории 1-8 (все кроме сложных)
     - Windows Server: категории 1-6
     - Windows Client: все уязвимости

  3) Продвинутый (все уязвимости)
     - Ubuntu: все 12 категорий
     - Windows Server: все 10 категорий
     - Windows Client: все 8 уязвимостей

  0) Вернуться в главное меню

Выберите профиль (1-3) или 0 для возврата: 
```

**Ввод:** `1`

**Вывод:**
```
Профиль 'Начинающий' применен!
```

---

## Шаг 3: Просмотр текущей конфигурации

**Ввод:** `5`

**Вывод:**
```
========================================
  Настройка уязвимостей учебной инфраструктуры
========================================

Текущая конфигурация уязвимостей

Ubuntu Server:
  Категория 1: ✅ Включено
  Категория 2: ✅ Включено
  Категория 3: ✅ Включено
  Категория 4: ✅ Включено
  Категория 5: ❌ Отключено
  Категория 6: ❌ Отключено
  Категория 7: ❌ Отключено
  Категория 8: ❌ Отключено
  Категория 9: ❌ Отключено
  Категория 10: ❌ Отключено
  Категория 11: ❌ Отключено
  Категория 12: ❌ Отключено

Windows Server 2016:
  Категория 1: ✅ Включено
  Категория 2: ✅ Включено
  Категория 3: ❌ Отключено
  Категория 4: ❌ Отключено
  Категория 5: ❌ Отключено
  Категория 6: ❌ Отключено
  Категория 7: ❌ Отключено
  Категория 8: ❌ Отключено
  Категория 9: ❌ Отключено
  Категория 10: ❌ Отключено

Windows 10 Pro:
  Уязвимость 1: ✅ Включено
  Уязвимость 2: ✅ Включено
  Уязвимость 3: ✅ Включено
  Уязвимость 4: ✅ Включено
  Уязвимость 5: ❌ Отключено
  Уязвимость 6: ❌ Отключено
  Уязвимость 7: ❌ Отключено
  Уязвимость 8: ❌ Отключено

Итого:
  Ubuntu Server: 4/12 категорий
  Windows Server 2016: 2/10 категорий
  Windows 10 Pro: 4/8 уязвимостей

Нажмите Enter для продолжения...
```

---

## Шаг 4: Просмотр описания категории

**Ввод:** `1` (для настройки Ubuntu Server)

**Вывод:**
```
========================================
  Настройка уязвимостей Ubuntu Server
========================================

Категории уязвимостей Ubuntu Server:

  1)  Аутентификация и управление аккаунтами
  2)  Уязвимости SSH
  3)  Ошибки конфигурации сети и firewall
  4)  Ошибки обновлений и пакетов
  5)  Ошибки управления службами
  6)  Ошибки прав доступа и файлов
  7)  Уязвимости веб-сервисов
  8)  Ошибки логирования
  9)  Уязвимости контейнеризации
  10) Ошибки резервного копирования
  11) Ошибки безопасности ядра
  12) Физическая безопасность

  0)  Вернуться в главное меню

Текущий статус:
  Категория 1: ✅
  Категория 2: ✅
  Категория 3: ✅
  Категория 4: ✅
  Категория 5: ❌
  Категория 6: ❌
  ...

Команды:
  • Введите номер категории (1-12) для включения/отключения
  • Введите 'd' + номер для просмотра описания
  • Введите 0 для возврата в главное меню

Ваш выбор: 
```

**Ввод:** `d1` (просмотр описания категории 1)

**Вывод:**
```
========================================
  Настройка уязвимостей Ubuntu Server
========================================

Описание категории 1

1. ОШИБКИ В УПРАВЛЕНИИ АККАУНТАМИ И АУТЕНТИФИКАЦИЕЙ

Что будет настроено:
  • Создание пользователей со слабыми паролями:
    - admin/admin123
    - user1/password123
    - user2/123456
    - root/root123
  • Отключение PAM-ограничений (minlen = 1)
  • Отключение блокировки после неверных попыток
  • Пароли никогда не истекают (chage -M -1)
  • Широкие sudo права (NOPASSWD для всех)
  • Отсутствие MFA

Риски: Легкий брутфорс паролей, компрометация аккаунтов

Нажмите Enter для продолжения...
```

**Ввод:** `Enter` (возврат к меню категорий)

**Ввод:** `0` (возврат в главное меню)

---

## Шаг 5: Добавление дополнительной категории вручную

**Ввод:** `1` (настройка Ubuntu Server)

**Ввод:** `6` (включить категорию 6 - Ошибки прав доступа и файлов)

**Вывод:**
```
Категория 6 включена
```

**Ввод:** `d6` (просмотр описания категории 6)

**Вывод:**
```
========================================
  Настройка уязвимостей Ubuntu Server
========================================

Описание категории 6

6. ОШИБКИ С ПРАВАМИ ДОСТУПА И ФАЙЛАМИ

Что будет настроено:
  • Неправильные права на директории:
    - /etc с правами 777
    - /var с правами 777
    - /home с правами 777
  • /etc/shadow с неправильными правами
  • Небезопасные cron задачи
  • 10 подкатегорий уязвимостей /etc/shadow:
    1. Неправильные права доступа
    2. Утечки через бэкапы
    3. Ошибки в конфигурации PAM
    4. Уязвимые алгоритмы хеширования
    5. Неправильные настройки shadow aging
    6. Доступ через SUID-приложения
    7. Недостаточная защита от локального пользователя
    8. Утечка через web-приложения
    9. Смешивание system и application accounts
    10. Ошибки при клонировании систем

Риски: КРИТИЧНО - утечка хешей паролей, компрометация системы

Нажмите Enter для продолжения...
```

**Ввод:** `Enter` → `0` (возврат в главное меню)

---

## Шаг 6: Предпросмотр конфигурации

**Ввод:** `6`

**Вывод:**
```
========================================
  Настройка уязвимостей учебной инфраструктуры
========================================

Предпросмотр конфигурации

Ubuntu Server - выбранные категории:
  ✅ Категория 1
  ✅ Категория 2
  ✅ Категория 3
  ✅ Категория 4
  ✅ Категория 6

Windows Server 2016 - выбранные категории:
  ✅ Категория 1
  ✅ Категория 2

Windows 10 Pro - выбранные уязвимости:
  ✅ Уязвимость 1
  ✅ Уязвимость 2
  ✅ Уязвимость 3
  ✅ Уязвимость 4

Итого будет настроено:
  Ubuntu Server: 5/12 категорий
  Windows Server 2016: 2/10 категорий
  Windows 10 Pro: 4/8 уязвимостей

Нажмите Enter для продолжения...
```

---

## Шаг 7: Сохранение конфигурации

**Ввод:** `7`

**Вывод:**
```
========================================
  Настройка уязвимостей учебной инфраструктуры
========================================

Сохранение конфигурации

[Показывается предпросмотр конфигурации]

Вы уверены, что хотите сохранить эту конфигурацию? (y/n)
Ваш выбор: 
```

**Ввод:** `y`

**Вывод:**
```
✓ Конфигурация сохранена в: ../ansible/group_vars/all/vulnerabilities.yml

Следующие шаги:
  1. Проверьте конфигурацию:
     cat ../ansible/group_vars/all/vulnerabilities.yml

  2. Запустите Ansible playbook для настройки уязвимостей:
     cd ../ansible
     ansible-playbook -i inventory.yml playbook.yml

⚠ ВАЖНО: После применения playbook будут настроены выбранные уязвимости!

Нажмите Enter для продолжения...
```

---

## Шаг 8: Просмотр сохраненной конфигурации

```bash
cat ../ansible/group_vars/all/vulnerabilities.yml
```

**Вывод:**
```yaml
---
# Конфигурация уязвимостей для учебной инфраструктуры
# Сгенерировано автоматически через configure-vulnerabilities.sh
# Дата: Fri Dec 20 10:30:00 MSK 2024
# Уровень сложности: beginner
# Всего категорий: 11/30

# ============================================
# UBUNTU SERVER - УЯЗВИМОСТИ LINUX
# ============================================

ubuntu_vulnerabilities:
  # 1. ОШИБКИ В УПРАВЛЕНИИ АККАУНТАМИ И АУТЕНТИФИКАЦИЕЙ
  auth_weak_passwords: true
  auth_no_pam_restrictions: true
  auth_no_account_lockout: true
  auth_no_password_expiry: true
  auth_wide_sudo_rights: true
  auth_no_mfa: true
  
  # 2. УЯЗВИМОСТИ ПРИ КОНФИГУРАЦИИ SSH
  ssh_password_auth: true
  ssh_root_login: true
  ssh_weak_algorithms: true
  ssh_no_fail2ban: true
  
  # 3. ОШИБКИ КОНФИГУРАЦИИ СЕТИ И FIREWALL
  network_firewall_off: true
  network_open_ports: true
  network_no_segmentation: true
  
  # 4. ОШИБКИ ПРИ НАСТРОЙКЕ ОБНОВЛЕНИЙ И ПАКЕТОВ
  updates_disabled: true
  updates_untrusted_repos: true
  updates_no_integrity_check: true
  
  # 5. ОШИБКИ В УПРАВЛЕНИИ СЛУЖБАМИ И ДЕМОНАМИ
  services_unnecessary_enabled: false
  services_root_privileges: false
  
  # 6. ОШИБКИ С ПРАВАМИ ДОСТУПА И ФАЙЛАМИ
  files_wrong_permissions: true
  files_wide_sudo: true
  files_unsafe_cron: true
  files_shadow_vulnerabilities: true
  
  # 7. УЯЗВИМОСТИ ВЕБ-СЕРВИСОВ И ПРИЛОЖЕНИЙ
  web_directory_listing: false
  web_server_tokens: false
  
  # 8. ОШИБКИ В ЛОГИРОВАНИИ И МОНИТОРИНГЕ
  logging_no_centralized: false
  logging_no_monitoring: false
  
  # 9. УЯЗВИМОСТИ КОНТЕЙНЕРИЗАЦИИ
  docker_no_protection: false
  
  # 10. ОШИБКИ РЕЗЕРВНОГО КОПИРОВАНИЯ
  backup_unreliable: false
  
  # 11. ОШИБКИ БЕЗОПАСНОСТИ ЯДРА И ОС
  kernel_no_hardening: false
  kernel_outdated: false
  
  # 12. ФИЗИЧЕСКАЯ БЕЗОПАСНОСТЬ
  physical_no_encryption: false

# ============================================
# WINDOWS SERVER 2016 - УЯЗВИМОСТИ WINDOWS
# ============================================

windows_server_vulnerabilities:
  # 1. УЯЗВИМОСТИ АУТЕНТИФИКАЦИИ И УПРАВЛЕНИЯ УЧЁТНЫМИ ЗАПИСЯМИ
  auth_weak_passwords: true
  auth_no_password_policy: true
  auth_no_password_history: true
  auth_no_password_expiry: true
  auth_domain_admin_abuse: true
  auth_no_mfa: true
  
  # 2. ОШИБКИ В НАСТРОЙКЕ ПОЛИТИК БЕЗОПАСНОСТИ (GPO)
  gpo_powershell_unrestricted: true
  gpo_audit_disabled: true
  gpo_passwords_in_gpp: true
  gpo_no_driver_signing: true
  
  # 3. ОШИБКИ В УПРАВЛЕНИИ ПРАВАМИ
  rights_wide_ad_permissions: false
  rights_excessive_privileged_groups: false
  rights_unconstrained_delegation: false
  
  # 4. УЯЗВИМОСТИ ИЗ-ЗА НЕПРАВИЛЬНОЙ КОНФИГУРАЦИИ СЕТИ
  network_dns_insecure: false
  network_firewall_wide_rules: false
  network_smbv1_enabled: false
  network_ntlmv1_allowed: false
  network_ldap_no_tls: false
  
  # 5. ОШИБКИ ПРИ НАСТРОЙКЕ КОНТРОЛЛЕРОВ ДОМЕНА
  dc_used_as_regular_server: false
  dc_insecure_replication: false
  dc_no_physical_control: false
  
  # 6. ОШИБКИ В РАБОТЕ С ОБНОВЛЕНИЯМИ И АНТИВИРУСОМ
  updates_no_wsus: false
  antivirus_wrong_config: false
  
  # 7. УЯЗВИМОСТИ ЛОГИРОВАНИЯ, МОНИТОРИНГА И АУДИТА
  logging_minimal: false
  logging_no_anomaly_monitoring: false
  
  # 8. ОШИБКИ В РЕЗЕРВНОМ КОПИРОВАНИИ
  backup_in_domain: false
  backup_no_critical_objects: false
  
  # 9. ОШИБКИ ПРИ РАБОТЕ С СЕРВИСНЫМИ АККАУНТАМИ
  service_accounts_domain_admin: false
  service_accounts_no_rotation: false
  service_accounts_wrong_spn: false
  
  # 10. УСТАРЕВШИЕ И НЕБЕЗОПАСНЫЕ ТЕХНОЛОГИИ
  legacy_ntlm_instead_kerberos: false
  legacy_frs_instead_dfsr: false
  legacy_smb_no_signing: false

# ============================================
# WINDOWS 10 PRO - КЛИЕНТСКИЕ УЯЗВИМОСТИ
# ============================================

windows_client_vulnerabilities:
  auth_weak_passwords: true
  auth_uac_disabled: true
  updates_disabled: true
  antivirus_disabled: true
  network_smbv1_enabled: false
  files_wrong_permissions: false
  network_firewall_disabled: false
  network_rdp_enabled: false

# ============================================
# ОБЩИЕ НАСТРОЙКИ
# ============================================

# Включить все уязвимости по умолчанию (для быстрого развертывания)
enable_all_vulnerabilities: false

# Уровень сложности (beginner, intermediate, advanced)
difficulty_level: "beginner"  # beginner, intermediate, advanced
```

---

## Шаг 9: Применение конфигурации через Ansible

```bash
cd ../ansible
ansible-playbook -i inventory.yml playbook.yml
```

**Результат:** На машинах будут настроены выбранные уязвимости согласно конфигурации.

---

## Альтернативный сценарий: Ручная настройка всех категорий

### Пример: Настройка только критических уязвимостей Ubuntu

1. **Запуск:** `./configure-vulnerabilities.sh`
2. **Выбор:** `1` (Ubuntu Server)
3. **Включение категорий:**
   - `1` (Аутентификация) → ✅
   - `2` (SSH) → ✅
   - `6` (Права доступа) → ✅
   - `4` (Обновления) → ✅
4. **Возврат:** `0` → `7` (Сохранение)

**Результат:** Только 4 критические категории будут включены.

---

## Альтернативный сценарий: Использование профиля "Продвинутый"

1. **Запуск:** `./configure-vulnerabilities.sh`
2. **Выбор:** `4` (Профили)
3. **Выбор:** `3` (Продвинутый)
4. **Проверка:** `5` (Просмотр конфигурации)
5. **Сохранение:** `7` → `y`

**Результат:** Все 30 категорий уязвимостей будут включены (12 Ubuntu + 10 Windows Server + 8 Windows Client).

---

## Полезные советы

### Быстрая настройка для тестирования

```bash
# Использовать профиль "Начинающий"
./configure-vulnerabilities.sh
# Выбрать: 4 → 1 → 7 → y
```

### Просмотр описания перед выбором

```bash
# Всегда используйте команду 'd' + номер для просмотра описания
# Например: d1, d2, d6
```

### Проверка перед сохранением

```bash
# Всегда используйте предпросмотр (пункт 6) перед сохранением
# Это позволит убедиться, что выбраны правильные категории
```

### Откат изменений

Если нужно изменить конфигурацию:
1. Запустите скрипт снова
2. Выберите нужные категории
3. Сохраните новую конфигурацию (старая будет перезаписана)

---

## Структура файла конфигурации

После сохранения создается файл:
```
infrastructure/ansible/group_vars/all/vulnerabilities.yml
```

Этот файл используется Ansible playbook для настройки уязвимостей на машинах.

---

## Следующие шаги

После настройки уязвимостей:

1. **Применить конфигурацию:**
   ```bash
   cd ../ansible
   ansible-playbook -i inventory.yml playbook.yml
   ```

2. **Проверить результат:**
   ```bash
   cd ../scripts
   ./verify-fixes.sh
   ```

3. **Документация:**
   - Полное описание уязвимостей: `../../docs/overview/machine-scenarios.md`
   - Руководство по обновлению playbook: `../ansible/PLAYBOOK_UPDATE_GUIDE.md`

