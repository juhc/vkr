# Скрипты проверки исправлений уязвимостей

## Обзор

Для проверки исправлений уязвимостей студентами доступны два инструмента:

1. **Bash скрипт** (`verify-fixes.sh`) - быстрая проверка через SSH и ping
2. **Ansible playbook** (`verify-fixes.yml`) - детальная проверка всех уязвимостей

## Способ 1: Bash скрипт (быстрая проверка)

### Использование

```bash
cd infrastructure/scripts
chmod +x verify-fixes.sh
./verify-fixes.sh
```

### Что проверяет

**Ubuntu Server:**
- Доступность через SSH
- Root login отключен
- Парольная аутентификация отключена
- PAM ограничения включены
- Fail2ban запущен
- UFW включен
- Небезопасные порты закрыты
- Автоматические обновления включены
- Правильные права доступа
- AppArmor включен
- Лишние службы отключены
- Directory listing отключен
- rsyslog включен
- Пользователи не в группе docker
- ASLR включен

**Windows Server 2016 и Windows 10 Pro:**
- Доступность через ping
- Открытые порты (RDP, WinRM)

### Преимущества
- Быстрый запуск
- Не требует настройки WinRM
- Цветной вывод результатов

### Недостатки
- Ограниченная проверка Windows (только доступность)
- Требует SSH ключ для Ubuntu

## Способ 2: Ansible playbook (детальная проверка)

### Использование

```bash
cd infrastructure/ansible
ansible-playbook -i inventory.yml verify-fixes.yml
```

### Что проверяет

**Ubuntu Server (детально):**
- Все проверки из bash скрипта
- Дополнительные проверки прав доступа
- Проверка конфигурации служб
- Проверка веб-сервисов

**Windows Server 2016:**
- Политика паролей (минимальная длина >= 12)
- Политика сложности паролей
- PowerShell Remoting ограничен
- SMBv1 отключен
- NTLMv1 отключен (LmCompatibilityLevel >= 5)
- Брандмауэр включен
- Автоматические обновления включены

**Windows 10 Pro:**
- UAC включен
- Windows Defender включен
- SMBv1 отключен

### Преимущества
- Детальная проверка всех машин
- Проверка Windows через WinRM
- Структурированный вывод
- Легко расширяемый

### Недостатки
- Требует настроенный WinRM для Windows
- Требует Ansible с модулями для Windows

## Настройка для проверки

### Ubuntu Server

Скрипт использует SSH ключ по умолчанию (`~/.ssh/id_rsa`). Если используется другой ключ, отредактируйте переменную в скрипте:

```bash
UBUNTU_SSH_KEY="${HOME}/.ssh/id_ed25519"  # или другой путь
```

### Windows машины

Для детальной проверки Windows через Ansible требуется:

1. **Настроенный WinRM** на Windows машинах
2. **Ansible с модулями Windows:**
   ```bash
   pip install pywinrm
   ```

3. **Правильные учетные данные** в `inventory.yml`

## Примеры использования

### Быстрая проверка только Ubuntu

```bash
./verify-fixes.sh | grep -A 50 "Ubuntu Server"
```

### Детальная проверка через Ansible

```bash
# Только Ubuntu Server
ansible-playbook -i inventory.yml verify-fixes.yml --limit ubuntu-server

# Только Windows машины
ansible-playbook -i inventory.yml verify-fixes.yml --limit windows

# Все машины
ansible-playbook -i inventory.yml verify-fixes.yml
```

### Проверка с выводом в файл

```bash
./verify-fixes.sh > verification-report.txt 2>&1
```

## Интерпретация результатов

### Успешная проверка

```
✓ Все проверки пройдены успешно!
```

### Частично успешная

```
⚠ Некоторые проверки пропущены, но все выполненные пройдены.
```

### Неуспешная проверка

```
✗ Обнаружены неисправленные уязвимости.
```

## Рекомендации

1. **Для быстрой проверки:** Используйте `verify-fixes.sh`
2. **Для детальной проверки:** Используйте `verify-fixes.yml`
3. **Для автоматизации:** Интегрируйте в CI/CD или систему оценки
4. **Для студентов:** Предоставьте оба скрипта для самопроверки

## Расширение скриптов

Для добавления новых проверок:

1. **Bash скрипт:** Добавьте новую функцию `check()` с соответствующими командами
2. **Ansible playbook:** Добавьте новые задачи в соответствующий playbook

## Документация

- Полное описание уязвимостей: `../../docs/overview/machine-scenarios.md`
- Чек-лист для студентов: `../../docs/assessment/CHECKLIST.md`
- Тестирование уязвимостей: `../../docs/assessment/TESTING.md`

