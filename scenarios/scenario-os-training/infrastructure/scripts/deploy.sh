#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —É—á–µ–±–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
#
# –í–ê–ñ–ù–û: –í—Å–µ —Ç—Ä–∏ –º–∞—à–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ 192.168.100.0/24
# - Ubuntu Server:      192.168.100.10
# - Windows Server 2016: 192.168.100.20
# - Windows 10 Pro:     192.168.100.30
#
# –í—Å–µ –º–∞—à–∏–Ω—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å –∑–∞–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_DIR="$(dirname "$SCRIPT_DIR")"
TERRAFORM_DIR="$INFRA_DIR/terraform"
ANSIBLE_DIR="$INFRA_DIR/ansible"

echo "=========================================="
echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã"
echo "=========================================="
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –í—Å–µ –º–∞—à–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ 192.168.100.0/24"
echo "   - Ubuntu Server:      192.168.100.10"
echo "   - Windows Server 2016: 192.168.100.20"
echo "   - Windows 10 Pro:     192.168.100.30"
echo ""
echo "–í—Å–µ –º–∞—à–∏–Ω—ã –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å –∑–∞–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏"
echo "–¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∑–∞—â–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º."
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
command -v terraform >/dev/null 2>&1 || { echo "–û—à–∏–±–∫–∞: terraform –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }
command -v ansible-playbook >/dev/null 2>&1 || { echo "–û—à–∏–±–∫–∞: ansible –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }
command -v virsh >/dev/null 2>&1 || { echo "–û—à–∏–±–∫–∞: libvirt –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–∞
if [ ! -f ~/.ssh/id_rsa.pub ] && [ ! -f ~/.ssh/id_ed25519.pub ]; then
    echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: SSH –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–°–æ–∑–¥–∞–Ω–∏–µ SSH –∫–ª—é—á–∞..."
    ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
fi

SSH_KEY=$(cat ~/.ssh/id_ed25519.pub 2>/dev/null || cat ~/.ssh/id_rsa.pub 2>/dev/null)

# –®–∞–≥ 1: Terraform
echo ""
echo "–®–∞–≥ 1: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Ubuntu Server —á–µ—Ä–µ–∑ Terraform..."
cd "$TERRAFORM_DIR"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
export TF_VAR_ssh_public_key="$SSH_KEY"
export TF_VAR_base_image_path="${TF_VAR_base_image_path:-/var/lib/libvirt/images/focal-server-cloudimg-amd64.img}"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
terraform init

# –ü–ª–∞–Ω
echo "–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
terraform plan

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    terraform apply -auto-approve
    UBUNTU_IP=$(terraform output -raw ubuntu_server_ip)
    echo "Ubuntu Server —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç: $UBUNTU_IP"
else
    echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
    exit 0
fi

# –®–∞–≥ 2: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
echo ""
echo "–®–∞–≥ 2: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Ubuntu Server..."
echo "–û–∂–∏–¥–∞–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã..."
sleep 60

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
MAX_RETRIES=10
RETRY=0
while [ $RETRY -lt $MAX_RETRIES ]; do
    if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@$UBUNTU_IP "echo 'OK'" 2>/dev/null; then
        echo "–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω!"
        break
    fi
    echo "–ü–æ–ø—ã—Ç–∫–∞ $((RETRY+1))/$MAX_RETRIES..."
    sleep 10
    RETRY=$((RETRY+1))
done

if [ $RETRY -eq $MAX_RETRIES ]; then
    echo "–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é."
    exit 1
fi

# –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏
echo ""
echo "–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏..."
echo "‚ö†Ô∏è  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –º–∞—à–∏–Ω—ã –≤ —Å–µ—Ç–∏ 192.168.100.0/24"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Ubuntu Server..."
if ping -c 3 192.168.100.10 >/dev/null 2>&1; then
    echo "‚úì Ubuntu Server (192.168.100.10) –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚úó Ubuntu Server (192.168.100.10) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Windows –º–∞—à–∏–Ω..."
if ping -c 1 192.168.100.20 >/dev/null 2>&1; then
    echo "‚úì Windows Server 2016 (192.168.100.20) –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö† Windows Server 2016 (192.168.100.20) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é)"
fi

if ping -c 1 192.168.100.30 >/dev/null 2>&1; then
    echo "‚úì Windows 10 Pro (192.168.100.30) –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö† Windows 10 Pro (192.168.100.30) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é)"
fi

# –®–∞–≥ 4: Ansible
echo ""
echo "–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Ansible..."
cd "$ANSIBLE_DIR"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä–∞–º —á–µ—Ä–µ–∑ Ansible..."
ansible all -i inventory.yml -m ping || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Ansible"

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Ubuntu
echo ""
echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –Ω–∞ Ubuntu Server..."
ansible-playbook -i inventory.yml playbook.yml --limit ubuntu-server

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Windows (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
echo ""
read -p "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –Ω–∞ Windows –º–∞—à–∏–Ω–∞—Ö? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–∞ Windows –º–∞—à–∏–Ω–∞—Ö..."
    ansible-playbook -i inventory.yml playbook.yml --limit windows || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: Windows –º–∞—à–∏–Ω—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é –≤ —Å–µ—Ç–∏ 192.168.100.0/24"
fi

echo ""
echo "=========================================="
echo "–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "=========================================="
echo ""
echo "üìã –°–µ—Ç–µ–≤–∞—è —Ç–æ–ø–æ–ª–æ–≥–∏—è (–≤—Å–µ –º–∞—à–∏–Ω—ã –≤ —Å–µ—Ç–∏ 192.168.100.0/24):"
echo ""
echo "  Ubuntu Server:      192.168.100.10  ‚úì –†–∞–∑–≤–µ—Ä–Ω—É—Ç"
echo "  Windows Server 2016: 192.168.100.20  (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ —Ç–æ–π –∂–µ —Å–µ—Ç–∏)"
echo "  Windows 10 Pro:     192.168.100.30  (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ —Ç–æ–π –∂–µ —Å–µ—Ç–∏)"
echo ""
echo "‚ö†Ô∏è  –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:"
echo "   - –í—Å–µ –º–∞—à–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ 192.168.100.0/24"
echo "   - Windows –º–∞—à–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞ (20 –∏ 30)"
echo "   - –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Windows –º–∞—à–∏–Ω –∑–∞–ø—É—Å—Ç–∏—Ç–µ Ansible –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:"
echo "     cd $ANSIBLE_DIR"
echo "     ansible-playbook -i inventory.yml playbook.yml --limit windows"
echo ""
echo "üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–∞—à–∏–Ω–∞–º:"
echo "  ssh ubuntu@192.168.100.10          # Ubuntu Server"
echo "  rdp://192.168.100.20               # Windows Server 2016"
echo "  rdp://192.168.100.30               # Windows 10 Pro"
echo ""
echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
echo "  - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: ../../docs/deployment/DEPLOYMENT.md"
echo "  - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:      ../../docs/deployment/QUICKSTART.md"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏:"
echo "  # –° Ubuntu Server –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Windows –º–∞—à–∏–Ω:"
echo "  ping -c 3 192.168.100.20  # Windows Server 2016"
echo "  ping -c 3 192.168.100.30  # Windows 10 Pro"
echo ""

