---
# Ansible playbook для настройки уязвимостей ОС в учебной инфраструктуре
# Фокус только на уязвимостях операционных систем

- name: Настройка Ubuntu Server с уязвимостями ОС Linux
  hosts: ubuntu-server
  become: yes
  gather_facts: yes
  
  tasks:
    # ============================================
    # 1. ОШИБКИ В УПРАВЛЕНИИ АККАУНТАМИ И АУТЕНТИФИКАЦИЕЙ
    # ============================================
    
    - name: Установка базовых пакетов
      apt:
        name:
          - openssh-server
          - samba
          - mysql-server
          - apache2
          - fail2ban
          - docker.io
          - cups
          - avahi-daemon
        state: present
        update_cache: yes
    
    - name: Создание пользователей со слабыми паролями (без PAM-ограничений)
      user:
        name: "{{ item.name }}"
        password: "{{ item.password | password_hash('sha512') }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        password_expire_max: -1
      loop:
        - { name: "admin", password: "admin123" }
        - { name: "user1", password: "password123" }
        - { name: "user2", password: "123456" }
        - { name: "root", password: "root123" }
    
    - name: Отключение PAM-ограничений для паролей
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: "^minlen", line: "minlen = 1" }
        - { regexp: "^dcredit", line: "dcredit = 0" }
        - { regexp: "^ucredit", line: "ucredit = 0" }
        - { regexp: "^lcredit", line: "lcredit = 0" }
        - { regexp: "^ocredit", line: "ocredit = 0" }
        - { regexp: "^minclass", line: "minclass = 1" }
    
    - name: Отключение политики блокировки после неверных попыток
      lineinfile:
        path: /etc/pam.d/common-auth
        regexp: "^auth.*pam_tally2"
        state: absent
      ignore_errors: yes
    
    - name: Настройка паролей без срока действия
      shell: chage -M -1 {{ item }}
      loop:
        - admin
        - user1
        - user2
      ignore_errors: yes
    
    - name: Настройка широких sudo прав (NOPASSWD для всех)
      copy:
        content: |
          admin ALL=(ALL) NOPASSWD: ALL
          user1 ALL=(ALL) NOPASSWD: ALL
          user2 ALL=(ALL) NOPASSWD: ALL
        dest: /etc/sudoers.d/vulnerable
        mode: '0440'
    
    # ============================================
    # 2. УЯЗВИМОСТИ ПРИ КОНФИГУРАЦИИ SSH
    # ============================================
    
    - name: Настройка SSH с небезопасными параметрами
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: "^#?PermitRootLogin", line: "PermitRootLogin yes" }
        - { regexp: "^#?PasswordAuthentication", line: "PasswordAuthentication yes" }
        - { regexp: "^#?PubkeyAuthentication", line: "PubkeyAuthentication yes" }
        - { regexp: "^#?Protocol", line: "Protocol 2" }
        - { regexp: "^#?MaxAuthTries", line: "MaxAuthTries 1000" }
        - { regexp: "^#?ClientAliveInterval", line: "ClientAliveInterval 0" }
        - { regexp: "^#?PermitEmptyPasswords", line: "PermitEmptyPasswords yes" }
      notify: restart ssh
    
    - name: Использование слабых алгоритмов SSH
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: "^#?KexAlgorithms", line: "KexAlgorithms +diffie-hellman-group1-sha1,diffie-hellman-group14-sha1" }
        - { regexp: "^#?Ciphers", line: "Ciphers +aes128-cbc,3des-cbc,blowfish-cbc" }
        - { regexp: "^#?MACs", line: "MACs +hmac-md5,hmac-sha1" }
      notify: restart ssh
    
    - name: Отключение fail2ban для SSH
      systemd:
        name: fail2ban
        state: stopped
        enabled: no
      ignore_errors: yes
    
    - name: Создание старых SSH ключей для демонстрации
      copy:
        content: |
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... old_key@server
        dest: /home/admin/.ssh/authorized_keys
        mode: '0644'
        owner: admin
        group: admin
    
    # ============================================
    # 3. ОШИБКИ КОНФИГУРАЦИИ СЕТИ И FIREWALL
    # ============================================
    
    - name: Полное отключение UFW
      shell: ufw --force disable
      ignore_errors: yes
    
    - name: Отключение iptables
      shell: iptables -F && iptables -X && iptables -t nat -F && iptables -t nat -X
      ignore_errors: yes
    
    - name: Открытие всех портов (небезопасно)
      shell: |
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT
      ignore_errors: yes
    
    - name: Включение небезопасных сервисов (Telnet, FTP, Rlogin)
      apt:
        name:
          - telnetd
          - vsftpd
          - rsh-server
        state: present
      ignore_errors: yes
    
    - name: Запуск небезопасных сервисов
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - telnet
        - vsftpd
        - rsh
      ignore_errors: yes
    
    # ============================================
    # 4. ОШИБКИ ПРИ НАСТРОЙКЕ ОБНОВЛЕНИЙ И ПАКЕТОВ
    # ============================================
    
    - name: Отключение автоматических обновлений безопасности
      lineinfile:
        path: /etc/apt/apt.conf.d/50unattended-upgrades
        regexp: "^Unattended-Upgrade::Automatic-Reboot"
        line: "Unattended-Upgrade::Automatic-Reboot \"false\";"
        insertafter: "^//Unattended-Upgrade::Automatic-Reboot"
      ignore_errors: yes
    
    - name: Отключение автоматических обновлений
      file:
        path: /etc/apt/apt.conf.d/20auto-upgrades
        state: absent
      ignore_errors: yes
    
    - name: Добавление небезопасных PPA репозиториев
      apt_repository:
        repo: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - "ppa:untrusted/ppa"
        - "deb http://untrusted-repo.example.com/ubuntu focal main"
      ignore_errors: yes
    
    - name: Отключение проверки подписей пакетов
      lineinfile:
        path: /etc/apt/apt.conf.d/99unauthenticated
        line: "APT::Get::AllowUnauthenticated \"true\";"
        create: yes
      ignore_errors: yes
    
    # ============================================
    # 5. ОШИБКИ В УПРАВЛЕНИИ СЛУЖБАМИ И ДЕМОНАМИ
    # ============================================
    
    - name: Включение лишних служб по умолчанию
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - cups
        - avahi-daemon
        - bluetooth
        - nfs-server
      ignore_errors: yes
    
    - name: Настройка служб для работы от root
      copy:
        content: |
          [Service]
          User=root
          Group=root
        dest: /etc/systemd/system/apache2.service.d/override.conf
        mode: '0644'
      ignore_errors: yes
    
    - name: Отключение AppArmor для демонстрации
      shell: |
        systemctl stop apparmor
        systemctl disable apparmor
        update-rc.d apparmor disable
      ignore_errors: yes
    
    # ============================================
    # 6. ОШИБКИ С ПРАВАМИ ДОСТУПА И ФАЙЛАМИ
    # ============================================
    
    - name: Создание директорий с неправильными правами доступа
      file:
        path: "{{ item.path }}"
        state: directory
        mode: '{{ item.mode }}'
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
      loop:
        - { path: "/srv/public", mode: '0777', owner: "nobody", group: "nogroup" }
        - { path: "/srv/sensitive", mode: '0777', owner: "nobody", group: "nogroup" }
        - { path: "/home/admin/credentials", mode: '0777', owner: "admin", group: "admin" }
        - { path: "/etc/cron.d", mode: '0777', owner: "root", group: "root" }
        - { path: "/var/log", mode: '0777', owner: "root", group: "root" }
        - { path: "/usr/local/bin", mode: '0777', owner: "root", group: "root" }
    
    - name: Неправильные права на системные директории
      shell: |
        chmod 777 /etc
        chmod 777 /var
        chmod 777 /home
      ignore_errors: yes
    
    - name: Создание небезопасных cron задач от root
      copy:
        content: |
          * * * * * root /bin/bash /tmp/unsafe_script.sh
          0 2 * * * root /usr/bin/backup.sh
        dest: /etc/cron.d/vulnerable
        mode: '0777'
        owner: root
        group: root
    
    - name: Создание небезопасных скриптов
      copy:
        content: |
          #!/bin/bash
          # Небезопасный скрипт без проверки путей
          export PATH=/tmp:$PATH
          /usr/bin/mysql -u root -proot123
        dest: /usr/local/bin/unsafe_script.sh
        mode: '0777'
        owner: root
        group: root
    
    - name: Создание файлов с учетными данными в открытом виде
      copy:
        content: |
          Database credentials:
          Host: localhost
          User: root
          Password: root123
          
          SSH credentials:
          User: admin
          Password: admin123
        dest: "/home/admin/credentials/database.txt"
        mode: '0666'
        owner: admin
        group: admin
    
    # ============================================
    # УЯЗВИМОСТИ /etc/shadow И УПРАВЛЕНИЯ ПАРОЛЯМИ
    # ============================================
    
    - name: Неправильные права доступа на /etc/shadow (слишком широкие)
      file:
        path: /etc/shadow
        mode: '0644'
        owner: root
        group: shadow
      ignore_errors: yes
    
    - name: Добавление лишних пользователей в группу shadow
      user:
        name: "{{ item }}"
        groups: shadow
        append: yes
      loop:
        - admin
        - user1
        - user2
      ignore_errors: yes
    
    - name: Создание копии /etc/shadow в доступных каталогах (утечка через бэкапы)
      shell: |
        cp /etc/shadow /tmp/shadow_backup
        cp /etc/shadow /home/admin/shadow_backup.txt
        cp /etc/shadow /var/www/html/shadow_backup.txt
        chmod 644 /tmp/shadow_backup
        chmod 644 /home/admin/shadow_backup.txt
        chmod 644 /var/www/html/shadow_backup.txt
      ignore_errors: yes
    
    - name: Настройка PAM для разрешения пустых паролей (nullok)
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: "^password.*pam_unix.so"
        line: "password        [success=1 default=ignore]      pam_unix.so obscure sha512 nullok"
        backup: yes
      ignore_errors: yes
    
    - name: Отключение проверок сложности паролей в PAM
      lineinfile:
        path: /etc/pam.d/common-password
        regexp: "^password.*pam_pwquality.so"
        state: absent
      ignore_errors: yes
    
    - name: Создание пользователей с уязвимыми алгоритмами хеширования (MD5)
      shell: |
        # Создание пользователя с MD5 хешем (демонстрация)
        useradd -m -s /bin/bash weakuser
        echo 'weakuser:$1$salt$hash12345678901234567890' | chpasswd -e
      ignore_errors: yes
    
    - name: Настройка паролей без срока действия (shadow aging)
      shell: |
        chage -M 99999 admin
        chage -M 99999 user1
        chage -M 99999 user2
        chage -m 0 admin
        chage -m 0 user1
        chage -m 0 user2
      ignore_errors: yes
    
    - name: Создание уязвимого SUID скрипта для чтения shadow
      copy:
        content: |
          #!/bin/bash
          # Уязвимый SUID скрипт, который может читать /etc/shadow
          cat /etc/shadow
        dest: /usr/local/bin/read_shadow
        mode: '4755'
        owner: root
        group: root
      ignore_errors: yes
    
    - name: Настройка веб-сервера для утечки shadow (directory traversal)
      copy:
        content: |
          <VirtualHost *:80>
              ServerName vulnerable.local
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  Options Indexes FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              Alias /etc /etc
              <Directory /etc>
                  Options Indexes FollowSymLinks
                  Require all granted
              </Directory>
          </VirtualHost>
        dest: /etc/apache2/sites-available/shadow-leak.conf
        mode: '0644'
      ignore_errors: yes
    
    - name: Включение сайта с утечкой shadow
      shell: |
        a2ensite shadow-leak.conf
        systemctl reload apache2
      ignore_errors: yes
    
    - name: Создание прикладных пользователей в системе (смешивание system и application accounts)
      user:
        name: "{{ item.name }}"
        password: "{{ item.password | password_hash('sha512') }}"
        shell: /bin/bash
        system: no
        create_home: yes
      loop:
        - { name: "app_user", password: "app123" }
        - { name: "db_user", password: "db123" }
        - { name: "web_user", password: "web123" }
      ignore_errors: yes
    
    - name: Создание скрипта автоматического создания пользователей без политик
      copy:
        content: |
          #!/bin/bash
          # Небезопасный скрипт автоматического создания пользователей
          for user in test1 test2 test3; do
              useradd -m -s /bin/bash -p $(openssl passwd -1 "default123") $user
          done
        dest: /usr/local/bin/auto_create_users.sh
        mode: '0755'
        owner: root
        group: root
      ignore_errors: yes
    
    - name: Создание демонстрации клонирования систем с одинаковыми хешами
      copy:
        content: |
          # ВНИМАНИЕ: Этот сервер был клонирован из тестовой среды
          # Все пароли идентичны тестовой среде
          # Это критическая уязвимость безопасности
          
          Проблема: Клонирование VM вместе с /etc/shadow приводит к одинаковым хешам на нескольких серверах.
          Риск: Один взлом ведёт к цепочке компрометаций.
        dest: /root/CLONING_WARNING.txt
        mode: '0644'
      ignore_errors: yes
    
    - name: Настройка низкого количества rounds для SHA-512 (уязвимое хеширование)
      shell: |
        # Демонстрация: использование низкого количества rounds для SHA-512
        # Стандарт: rounds=5000, здесь используется rounds=1000
        sed -i 's/rounds=5000/rounds=1000/' /etc/pam.d/common-password 2>/dev/null || true
      ignore_errors: yes
    
    - name: Настройка Samba с уязвимостями
      copy:
        content: |
          [global]
          workgroup = WORKGROUP
          server min protocol = NT1
          security = user
          map to guest = Bad User
          
          [public]
          path = /srv/public
          browseable = yes
          writable = yes
          guest ok = yes
          guest only = yes
          create mask = 0666
          directory mask = 0777
        dest: /etc/samba/smb.conf
        mode: '0644'
        backup: yes
      notify: restart samba
    
    - name: Запуск и включение сервисов
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - ssh
        - smbd
        - nmbd
        - apache2
        - mysql
    
    # ============================================
    # 7. УЯЗВИМОСТИ ВЕБ-СЕРВИСОВ И ПРИЛОЖЕНИЙ
    # ============================================
    
    - name: Настройка Apache с небезопасными параметрами
      lineinfile:
        path: /etc/apache2/apache2.conf
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: "^ServerTokens", line: "ServerTokens Full" }
        - { regexp: "^ServerSignature", line: "ServerSignature On" }
        - { regexp: "^Options", line: "Options +Indexes" }
      notify: restart apache
    
    - name: Включение directory listing в Apache
      lineinfile:
        path: /etc/apache2/apache2.conf
        line: "Options Indexes FollowSymLinks"
        insertafter: "^<Directory /var/www/>"
      notify: restart apache
    
    - name: Неправильные права на виртуальные хосты
      shell: chmod 777 /etc/apache2/sites-available/* /etc/apache2/sites-enabled/*
      ignore_errors: yes
    
    - name: Неправильные права на логи Apache
      shell: chmod 777 /var/log/apache2/*
      ignore_errors: yes
    
    # ============================================
    # 8. ОШИБКИ В ЛОГИРОВАНИИ И МОНИТОРИНГЕ
    # ============================================
    
    - name: Отключение ротации логов
      lineinfile:
        path: /etc/logrotate.d/rsyslog
        regexp: "^rotate"
        line: "rotate 0"
      ignore_errors: yes
    
    - name: Настройка journald для переполнения
      lineinfile:
        path: /etc/systemd/journald.conf
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: "^SystemMaxUse", line: "SystemMaxUse=10M" }
        - { regexp: "^SystemKeepFree", line: "SystemKeepFree=1M" }
      notify: restart systemd-journald
    
    - name: Отключение отправки логов в syslog
      systemd:
        name: rsyslog
        state: stopped
        enabled: no
      ignore_errors: yes
    
    # ============================================
    # 9. УЯЗВИМОСТИ КОНТЕЙНЕРИЗАЦИИ И ВИРТУАЛИЗАЦИИ
    # ============================================
    
    - name: Настройка Docker без защиты
      copy:
        content: |
          {
            "hosts": ["tcp://0.0.0.0:2375", "unix:///var/run/docker.sock"]
          }
        dest: /etc/docker/daemon.json
        mode: '0644'
      notify: restart docker
    
    - name: Добавление пользователей в группу docker (небезопасно)
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop:
        - admin
        - user1
        - user2
    
    - name: Создание контейнеров в привилегированном режиме
      shell: |
        docker run -d --privileged --name vulnerable-container ubuntu:20.04 sleep infinity
      ignore_errors: yes
    
    # ============================================
    # 10. ОШИБКИ РЕЗЕРВНОГО КОПИРОВАНИЯ
    # ============================================
    
    - name: Создание нешифрованных бэкапов на том же сервере
      copy:
        content: |
          #!/bin/bash
          mysqldump -u root -proot123 --all-databases > /home/admin/backup.sql
          tar -czf /home/admin/backup.tar.gz /etc /var/www
        dest: /usr/local/bin/backup.sh
        mode: '0777'
        owner: root
        group: root
    
    - name: Настройка cron для небезопасных бэкапов
      cron:
        name: "Unsafe backup"
        minute: "0"
        hour: "2"
        job: "/bin/bash /usr/local/bin/backup.sh"
        user: root
    
    # ============================================
    # 11. ОШИБКИ БЕЗОПАСНОСТИ ЯДРА И ОС
    # ============================================
    
    - name: Отключение AppArmor
      shell: |
        systemctl stop apparmor
        systemctl disable apparmor
        aa-complain /etc/apparmor.d/*
      ignore_errors: yes
    
    - name: Отключение kernel hardening параметров
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: yes
        reload: yes
      loop:
        - { name: "kernel.dmesg_restrict", value: "0" }
        - { name: "kernel.kptr_restrict", value: "0" }
        - { name: "net.ipv4.ip_forward", value: "1" }
        - { name: "net.ipv4.conf.all.send_redirects", value: "1" }
        - { name: "net.ipv4.conf.all.accept_redirects", value: "1" }
        - { name: "net.ipv4.conf.all.accept_source_route", value: "1" }
    
    - name: Отключение ASLR
      sysctl:
        name: "kernel.randomize_va_space"
        value: "0"
        state: present
        sysctl_set: yes
        reload: yes
    
    # ============================================
    # 12. ФИЗИЧЕСКАЯ БЕЗОПАСНОСТЬ И ДОСТУП
    # ============================================
    
    - name: Отключение шифрования дисков (если было включено)
      shell: |
        # Демонстрация отсутствия LUKS
        echo "Диски не зашифрованы"
      ignore_errors: yes
    
    - name: Настройка GRUB для загрузки без пароля
      lineinfile:
        path: /etc/default/grub
        regexp: "^GRUB_CMDLINE_LINUX"
        line: 'GRUB_CMDLINE_LINUX=""'
      notify: update grub
    
    - name: Создание информационного файла об уязвимостях
      copy:
        content: |
          # Уязвимости операционной системы Ubuntu Server
          
          Этот сервер настроен с типичными ошибками администраторов для обучения:
          
          КАТЕГОРИЯ 1: Управление аккаунтами и аутентификацией
          - Слабые пароли без PAM-ограничений
          - Нет политики блокировки после неверных попыток
          - Пароли без срока действия
          - Широкие sudo права (NOPASSWD для всех)
          
          КАТЕГОРИЯ 2: Конфигурация SSH
          - Разрешен root login
          - Парольная аутентификация без ограничений
          - Слабые алгоритмы шифрования
          - Нет fail2ban
          
          КАТЕГОРИЯ 3: Сеть и firewall
          - UFW полностью отключен
          - Все порты открыты
          - Включены небезопасные сервисы (Telnet, FTP)
          
          КАТЕГОРИЯ 4: Обновления и пакеты
          - Автоматические обновления отключены
          - Небезопасные PPA репозитории
          - Проверка подписей отключена
          
          КАТЕГОРИЯ 5: Управление службами
          - Лишние службы включены (CUPS, Avahi)
          - Службы работают от root
          - AppArmor отключен
          
          КАТЕГОРИЯ 6: Права доступа
          - Неправильные права на /etc, /var, /home
          - Небезопасные cron задачи
          - Скрипты с широкими правами
          
          КАТЕГОРИЯ 6.1: Уязвимости /etc/shadow и управления паролями
          - Неправильные права доступа на /etc/shadow (слишком широкие разрешения)
          - Утечки /etc/shadow через неверные бэкапы или временные файлы
          - Ошибки в конфигурации PAM (nullok, отсутствие проверок сложности)
          - Использование уязвимых алгоритмов хеширования (MD5, низкие rounds)
          - Неправильные настройки парольной политики (shadow aging fields)
          - Доступ к /etc/shadow через уязвимости SUID-приложений
          - Недостаточная защита от локального пользователя
          - Утечка shadow через web-приложения или CGI (directory traversal)
          - Смешивание system accounts и application accounts
          - Ошибки при миграции или клонировании систем (одинаковые хеши)
          
          КАТЕГОРИЯ 7: Веб-сервисы
          - Directory listing включен
          - Неправильные права на конфигурации
          
          КАТЕГОРИЯ 8: Логирование
          - Ротация логов отключена
          - journald переполняется
          - Нет централизованного логирования
          
          КАТЕГОРИЯ 9: Контейнеризация
          - Docker socket доступен пользователям
          - Контейнеры в привилегированном режиме
          
          КАТЕГОРИЯ 10: Резервное копирование
          - Бэкапы не шифруются
          - Бэкапы на том же сервере
          
          КАТЕГОРИЯ 11: Безопасность ядра
          - AppArmor отключен
          - Kernel hardening отключен
          - ASLR отключен
          
          КАТЕГОРИЯ 12: Физическая безопасность
          - Диски не зашифрованы
          - GRUB без пароля
        dest: /root/VULNERABILITY_INFO.txt
        mode: '0644'
    
    handlers:
      - name: restart ssh
        systemd:
          name: ssh
          state: restarted
      
      - name: restart samba
        systemd:
          name: smbd
          state: restarted
      
      - name: restart apache
        systemd:
          name: apache2
          state: restarted
      
      - name: restart docker
        systemd:
          name: docker
          state: restarted
      
      - name: restart systemd-journald
        systemd:
          name: systemd-journald
          state: restarted
      
      - name: update grub
        shell: update-grub
        ignore_errors: yes

- name: Настройка Windows Server 2016 с уязвимостями ОС Windows
  hosts: windows-server-2016
  gather_facts: yes
  
  tasks:
    # ============================================
    # 1. УЯЗВИМОСТИ АУТЕНТИФИКАЦИИ И УПРАВЛЕНИЯ УЧЁТНЫМИ ЗАПИСЯМИ
    # ============================================
    
    - name: Установка слабого пароля администратора
      win_user:
        name: Administrator
        password: "Admin123!"
        password_never_expires: yes
        state: present
    
    - name: Создание пользователей со слабыми паролями
      win_user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        password_never_expires: yes
        groups:
          - Administrators
        state: present
      loop:
        - { name: "admin", password: "admin123" }
        - { name: "user1", password: "password123" }
        - { name: "domainadmin", password: "Domain123!" }
    
    - name: Отключение политики сложности паролей
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
        name: MinimumPasswordLength
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Отключение требования сложности паролей
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
        name: PasswordComplexity
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Отключение запрета повторяющихся паролей
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
        name: PasswordHistoryLength
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Использование одного пароля на всех серверах (демонстрация)
      win_copy:
        content: |
          Все серверы используют пароль Admin123!
          Это типичная ошибка администратора
        dest: C:\Public\password_reuse.txt
    
    - name: Работа под Domain Admin для обычных задач (демонстрация)
      win_copy:
        content: |
          Пользователь domainadmin работает под Domain Admin для всех задач
          Это нарушает принцип минимальных привилегий
        dest: C:\Public\domain_admin_usage.txt
    
    # ============================================
    # 2. ОШИБКИ В НАСТРОЙКЕ ПОЛИТИК БЕЗОПАСНОСТИ (GPO)
    # ============================================
    
    - name: Разрешение WMI/PowerShell Remoting без ограничений
      win_shell: |
        Enable-PSRemoting -Force
        Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*" -Force
      ignore_errors: yes
    
    - name: Отключение аудита событий безопасности
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Eventlog\Security
        name: Retention
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Создание GPP с паролями (уязвимость CVE-2014-1812)
      win_copy:
        content: |
          Демонстрация: пароли в GPP хранятся в открытом виде в SYSVOL
          Это критическая уязвимость
        dest: C:\Public\gpp_passwords.txt
    
    - name: Разрешение установки неподписанных драйверов
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Driver Signing
        name: Policy
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Слишком широкие права "Allow log on locally"
      win_shell: |
        # Демонстрация: все пользователи могут логиниться локально
        Write-Host "GPO настроен на разрешение локального входа для всех"
      ignore_errors: yes
    
    # ============================================
    # 3. ОШИБКИ В УПРАВЛЕНИИ ПРАВАМИ (ACL, ДЕЛЕГИРОВАНИЕ, ГРУППЫ)
    # ============================================
    
    - name: Создание демонстрации широких прав на AD объекты
      win_copy:
        content: |
          Authenticated Users имеют права на изменение критичных AD объектов
          Это позволяет компрометировать всю инфраструктуру
        dest: C:\Public\ad_acl_issues.txt
    
    - name: Чрезмерное использование привилегированных групп
      win_shell: |
        # Демонстрация: пользователи в Domain Admins для всего
        Write-Host "Пользователи остаются в Domain Admins без необходимости"
      ignore_errors: yes
    
    - name: Включение Unconstrained Delegation (демонстрация)
      win_copy:
        content: |
          У хостов включено "Trust this computer for delegation to any service"
          Это позволяет компрометировать учетные данные Kerberos
        dest: C:\Public\unconstrained_delegation.txt
    
    # ============================================
    # 4. УЯЗВИМОСТИ ИЗ-ЗА НЕПРАВИЛЬНОЙ КОНФИГУРАЦИИ СЕТИ
    # ============================================
    
    - name: Разрешение динамического обновления DNS без ограничений
      win_shell: |
        # Демонстрация: DNS разрешает обновления от всех
        Write-Host "DNS настроен на разрешение динамических обновлений без ограничений"
      ignore_errors: yes
    
    - name: Открытый DNS к внешней сети (демонстрация)
      win_copy:
        content: |
          DNS сервер доступен из внешней сети
          Это может привести к DNS poisoning
        dest: C:\Public\dns_issues.txt
    
    - name: Широкие правила брандмауэра Any → Any
      win_shell: |
        New-NetFirewallRule -DisplayName "Unsafe Rule" -Direction Inbound -Action Allow -Protocol Any -RemoteAddress Any -LocalAddress Any
      ignore_errors: yes
    
    - name: Отключение брандмауэра Windows
      win_shell: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
      ignore_errors: yes
    
    - name: Включение SMBv1 (уязвимый протокол)
      win_shell: |
        Enable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart
      ignore_errors: yes
    
    - name: Разрешение NTLMv1
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: LmCompatibilityLevel
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: LDAP без TLS (демонстрация)
      win_copy:
        content: |
          LDAP работает без TLS
          Это позволяет перехватывать учетные данные
        dest: C:\Public\ldap_no_tls.txt
    
    # ============================================
    # 5. ОШИБКИ ПРИ НАСТРОЙКЕ КОНТРОЛЛЕРОВ ДОМЕНА (DC)
    # ============================================
    
    - name: Установка ролей на DC (демонстрация)
      win_copy:
        content: |
          На DC развернуты роли: DHCP, SQL, файловый сервер
          Это нарушает принцип разделения ролей
        dest: C:\Public\dc_roles.txt
    
    - name: Разрешение локального входа на DC
      win_shell: |
        # Демонстрация: пользователи могут заходить на DC локально
        Write-Host "Локальный вход на DC разрешен"
      ignore_errors: yes
    
    - name: Разрешение RDP на DC
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Небезопасная репликация (демонстрация)
      win_copy:
        content: |
          RPC разрешен во все стороны для репликации
          DFSR и SYSVOL не защищены надлежащими разрешениями
        dest: C:\Public\replication_issues.txt
    
    # ============================================
    # 6. ОШИБКИ В РАБОТЕ С ОБНОВЛЕНИЯМИ И АНТИВИРУСОМ
    # ============================================
    
    - name: Отключение автоматических обновлений Windows
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: NoAutoUpdate
        data: 1
        type: dword
      ignore_errors: yes
    
    - name: Отсутствие WSUS/SCCM (демонстрация)
      win_copy:
        content: |
          Нет WSUS или SCCM для управления патчами
          DC и критичные сервисы не обновляются месяцами
        dest: C:\Public\no_patch_management.txt
    
    - name: Отключение Windows Defender
      win_shell: |
        Set-MpPreference -DisableRealtimeMonitoring $true
      ignore_errors: yes
    
    - name: Слишком много исключений в антивирусе
      win_shell: |
        Add-MpPreference -ExclusionPath "C:\", "D:\", "E:\"
      ignore_errors: yes
    
    - name: Отключение ASR правил
      win_shell: |
        Set-MpPreference -AttackSurfaceReductionRules_Ids @{0="Disabled"} -AttackSurfaceReductionRules_Actions @{0="Disable"}
      ignore_errors: yes
    
    # ============================================
    # 7. УЯЗВИМОСТИ ЛОГИРОВАНИЯ, МОНИТОРИНГА И АУДИТА
    # ============================================
    
    - name: Автоматическая очистка Event logs
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Eventlog\Application
        name: Retention
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Отсутствие отправки логов на SIEM (демонстрация)
      win_copy:
        content: |
          Логи не отправляются на SIEM или централизованный лог-сервер
          Нет централизованного мониторинга
        dest: C:\Public\no_siem.txt
    
    - name: Отключение аудита
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
        name: AuditBaseObjects
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Отсутствие мониторинга входов администраторов (демонстрация)
      win_copy:
        content: |
          Не отслеживаются входы администраторов
          Не отслеживаются изменения в чувствительных группах
          Нет мониторинга NTDS.dit
        dest: C:\Public\no_monitoring.txt
    
    # ============================================
    # 8. ОШИБКИ В РЕЗЕРВНОМ КОПИРОВАНИИ
    # ============================================
    
    - name: Бэкапы в домене и не защищены (демонстрация)
      win_copy:
        content: |
          Бэкапы лежат в домене и не защищены
          Нет offline/immutable backup
          Бэкапы не зашифрованы
        dest: C:\Public\backup_issues.txt
    
    - name: Отсутствие бэкапов критичных объектов (демонстрация)
      win_copy:
        content: |
          Не делаются бэкапы:
          - SYSVOL
          - DNS
          - GPO
          - Образы DC
        dest: C:\Public\no_backups.txt
    
    # ============================================
    # 9. ОШИБКИ ПРИ РАБОТЕ С СЕРВИСНЫМИ АККАУНТАМИ
    # ============================================
    
    - name: Сервисные аккаунты с привилегиями Domain Admin (демонстрация)
      win_copy:
        content: |
          Приложения работают от имени Domain Admin
          Это критическая ошибка безопасности
        dest: C:\Public\service_accounts.txt
    
    - name: Пароли сервисных аккаунтов не меняются годами (демонстрация)
      win_copy:
        content: |
          Пароли сервисных аккаунтов не меняются годами
          Нет автоматизации (gMSA)
        dest: C:\Public\service_passwords.txt
    
    - name: Некорректные SPN (демонстрация)
      win_copy:
        content: |
          У счетов с SPN слишком широкие разрешения
          SPN настроены некорректно
        dest: C:\Public\spn_issues.txt
    
    # ============================================
    # 10. УСТАРЕВШИЕ И НЕБЕЗОПАСНЫЕ ТЕХНОЛОГИИ
    # ============================================
    
    - name: Использование NTLM вместо Kerberos (демонстрация)
      win_copy:
        content: |
          NTLM используется вместо Kerberos
          Это устаревшая и небезопасная технология
        dest: C:\Public\ntlm_usage.txt
    
    - name: FRS вместо DFSR для SYSVOL (демонстрация)
      win_copy:
        content: |
          Используется FRS вместо DFSR для SYSVOL
          FRS устарел и небезопасен
        dest: C:\Public\frs_usage.txt
    
    - name: Открытые SMB-сервера без подписывания
      win_shell: |
        Set-SmbServerConfiguration -RequireSecuritySignature $false -Force
      ignore_errors: yes
    
    # ============================================
    # ДОПОЛНИТЕЛЬНЫЕ УЯЗВИМОСТИ
    # ============================================
    
    - name: Создание директорий с неправильными правами доступа
      win_file:
        path: "{{ item.path }}"
        state: directory
      loop:
        - "C:\Public"
        - "C:\Sensitive"
        - "C:\Backup"
    
    - name: Установка неправильных прав доступа
      win_acl:
        path: "{{ item.path }}"
        user: "{{ item.user }}"
        rights: "{{ item.rights }}"
        type: allow
        state: present
      loop:
        - { path: "C:\Public", user: "Everyone", rights: "FullControl" }
        - { path: "C:\Sensitive", user: "Everyone", rights: "FullControl" }
        - { path: "C:\Backup", user: "Everyone", rights: "FullControl" }
    
    - name: Создание файлов с учетными данными
      win_copy:
        content: |
          Database credentials:
          Host: localhost
          User: sa
          Password: Admin123!
          
          Domain credentials:
          User: Administrator
          Password: Admin123!
          
          Service Account:
          User: svc_app
          Password: Service123!
        dest: C:\Public\credentials.txt
    
    - name: Включение RDP без ограничений
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword
    
    - name: Отключение Network Level Authentication для RDP
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
        name: UserAuthentication
        data: 0
        type: dword
      ignore_errors: yes
    
    - name: Создание информационного файла об уязвимостях Windows
      win_copy:
        content: |
          # Уязвимости операционной системы Windows Server 2016
          
          Этот сервер настроен с типичными ошибками администраторов для обучения:
          
          КАТЕГОРИЯ 1: Аутентификация и управление учётными записями
          - Слабые пароли без политики сложности
          - Использование одного пароля на всех серверах
          - Работа под Domain Admin для обычных задач
          - Нет MFA для критичных учётных записей
          
          КАТЕГОРИЯ 2: Ошибки в настройке политик безопасности (GPO)
          - Разрешены WMI/PowerShell Remoting без ограничений
          - Отключён аудит событий безопасности
          - Разрешено хранение паролей в GPP
          - Нет ограничения на установку неподписанных драйверов
          
          КАТЕГОРИЯ 3: Ошибки в управлении правами (ACL, делегирование, группы)
          - Слишком широкие права на AD-объекты
          - Чрезмерное использование привилегированных групп
          - Unconstrained Delegation включено
          
          КАТЕГОРИЯ 4: Уязвимости из-за неправильной конфигурации сети
          - Ошибки DNS (динамическое обновление без ограничений)
          - Широкие правила брандмауэра (Any → Any)
          - SMBv1 включён
          - NTLMv1 разрешён
          - LDAP без TLS
          
          КАТЕГОРИЯ 5: Ошибки при настройке контроллеров домена (DC)
          - DC используются как обычные рабочие сервера
          - Не настроена безопасная репликация
          - Отсутствие контроля за физическим доступом
          
          КАТЕГОРИЯ 6: Ошибки в работе с обновлениями и антивирусом
          - Отсутствие регулярного обновления (нет WSUS/SCCM)
          - Антивирус настроен неправильно (много исключений, ASR отключен)
          
          КАТЕГОРИЯ 7: Уязвимости логирования, мониторинга и аудита
          - Логирование минимальное или отсутствует
          - Нет мониторинга аномалий
          
          КАТЕГОРИЯ 8: Ошибки в резервном копировании
          - Бэкапы лежат в домене и не защищены
          - Не делаются бэкапы критичных объектов
          
          КАТЕГОРИЯ 9: Ошибки при работе с сервисными аккаунтами
          - Сервисные аккаунты с привилегиями Domain Admin
          - Пароли сервисных аккаунтов не меняются годами
          - SPN настроены некорректно
          
          КАТЕГОРИЯ 10: Устаревшие и небезопасные технологии
          - NTLM вместо Kerberos
          - FRS вместо DFSR для SYSVOL
          - Открытые SMB-сервера без подписывания
        dest: C:\Public\VULNERABILITY_INFO.txt

- name: Настройка Windows 10 Pro с уязвимостями ОС рабочих станций
  hosts: windows-10-pro
  gather_facts: yes
  
  tasks:
    - name: Создание пользователей со слабыми паролями
      win_user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        password_never_expires: yes
        state: present
      loop:
        - { name: "user", password: "User123!" }
        - { name: "admin", password: "admin123" }
    
    - name: Отключение UAC (User Account Control)
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
        name: EnableLUA
        data: 0
        type: dword
    
    - name: Отключение автоматических обновлений Windows
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: NoAutoUpdate
        data: 1
        type: dword
      ignore_errors: yes
    
    - name: Отключение Windows Defender
      win_shell: |
        Set-MpPreference -DisableRealtimeMonitoring $true
      ignore_errors: yes
    
    - name: Включение SMBv1
      win_shell: |
        Enable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol -NoRestart
      ignore_errors: yes
    
    - name: Создание директорий с неправильными правами
      win_file:
        path: "{{ item.path }}"
        state: directory
      loop:
        - "C:\Users\Public\Documents"
        - "C:\Temp"
    
    - name: Установка неправильных прав доступа
      win_acl:
        path: "{{ item.path }}"
        user: "{{ item.user }}"
        rights: "{{ item.rights }}"
        type: allow
        state: present
      loop:
        - { path: "C:\Users\Public\Documents", user: "Everyone", rights: "FullControl" }
        - { path: "C:\Temp", user: "Everyone", rights: "FullControl" }
    
    - name: Отключение брандмауэра Windows
      win_shell: |
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
      ignore_errors: yes
    
    - name: Включение RDP
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword

