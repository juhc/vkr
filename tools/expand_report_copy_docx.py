import os
import re
from dataclasses import dataclass
from pathlib import Path

from docx import Document
from docx.oxml import OxmlElement
from docx.shared import Pt
from docx.text.paragraph import Paragraph


ROOT = Path(__file__).resolve().parents[1]


def read_text(rel_path: str) -> str:
    return (ROOT / rel_path).read_text(encoding="utf-8")


def is_generated_docx(name: str) -> bool:
    n = name.lower()
    return (
        n.startswith("~$")  # MS Word temp files
        or "__generated" in n
        or "report__generated" in n
    )


def pick_target_docx() -> Path:
    """
    Prefer the user's manually edited copy: `Отчет — копия.docx`.
    Fallbacks:
      - any non-generated docx with spaces in the name (typical for "копия")
      - `Отчет.docx`
      - first non-generated docx (newest mtime)
    """
    env = os.getenv("REPORT_DOCX", "").strip()
    if env:
        p = (ROOT / env) if not Path(env).is_absolute() else Path(env)
        return p

    docx_files = [p for p in ROOT.glob("*.docx") if not is_generated_docx(p.name)]
    if not docx_files:
        raise SystemExit("No non-generated .docx files found in repo root.")

    # Best effort: prefer the newest file that looks like a copy
    copy_like = [p for p in docx_files if ("копия" in p.name.lower() or "copy" in p.name.lower())]
    if copy_like:
        copy_like.sort(key=lambda x: x.stat().st_mtime, reverse=True)
        return copy_like[0]

    space_like = [p for p in docx_files if " " in p.name]
    if space_like:
        space_like.sort(key=lambda x: x.stat().st_mtime, reverse=True)
        return space_like[0]

    exact = ROOT / "Отчет.docx"
    if exact.exists():
        return exact

    docx_files.sort(key=lambda x: x.stat().st_mtime, reverse=True)
    return docx_files[0]


def has_style(doc: Document, name: str) -> bool:
    try:
        _ = doc.styles[name]
        return True
    except Exception:
        return False


def choose_style(doc: Document, preferred: str, fallback: str = "Normal") -> str:
    if preferred and has_style(doc, preferred):
        return preferred
    if fallback and has_style(doc, fallback):
        return fallback
    return "Normal"


def remove_paragraph(p: Paragraph):
    p._element.getparent().remove(p._element)
    p._p = p._element = None  # type: ignore[attr-defined]


def insert_paragraph_after(paragraph: Paragraph, text: str = "", style: str | None = None) -> Paragraph:
    new_p = OxmlElement("w:p")
    paragraph._p.addnext(new_p)
    new_para = Paragraph(new_p, paragraph._parent)
    if style:
        try:
            new_para.style = style
        except Exception:
            pass
    if text:
        new_para.add_run(text)
    return new_para


def insert_paragraph_before(paragraph: Paragraph, text: str = "", style: str | None = None) -> Paragraph:
    new_p = OxmlElement("w:p")
    paragraph._p.addprevious(new_p)
    new_para = Paragraph(new_p, paragraph._parent)
    if style:
        try:
            new_para.style = style
        except Exception:
            pass
    if text:
        new_para.add_run(text)
    return new_para


def insert_block_after(anchor: Paragraph, lines: list[str], style: str) -> Paragraph:
    cur = anchor
    for ln in lines:
        cur = insert_paragraph_after(cur, ln, style=style)
    return cur


def insert_block_before(anchor: Paragraph, lines: list[str], style: str) -> Paragraph:
    # preserve order: insert before in reverse
    cur = anchor
    for ln in reversed(lines):
        cur = insert_paragraph_before(cur, ln, style=style)
    return cur


def find_paragraph(doc: Document, predicate) -> Paragraph | None:
    for p in doc.paragraphs:
        t = (p.text or "").strip()
        if not t:
            continue
        if predicate(p, t):
            return p
    return None


def replace_in_all_paragraphs(doc: Document, src: str, dst: str):
    if not src:
        return
    for p in doc.paragraphs:
        if src not in (p.text or ""):
            continue
        # Replace in full paragraph text: rebuild runs
        new_text = (p.text or "").replace(src, dst)
        # Clear runs
        for r in p.runs:
            r.text = ""
        p.add_run(new_text)


def add_code_block_at_end(doc: Document, code: str):
    """
    Minimal monospace block (avoid custom styles).
    """
    p = doc.add_paragraph()
    for i, line in enumerate(code.rstrip("\n").splitlines()):
        run = p.add_run(line)
        run.font.name = "Courier New"
        run.font.size = Pt(9)
        if i != len(code.rstrip("\n").splitlines()) - 1:
            p.add_run("\n")


def insert_code_block_before(anchor: Paragraph, code: str, style: str | None = None) -> Paragraph:
    """
    Insert a monospace block right before `anchor`.
    """
    p = insert_paragraph_before(anchor, "", style=style)
    lines = code.rstrip("\n").splitlines()
    for i, line in enumerate(lines):
        run = p.add_run(line)
        run.font.name = "Courier New"
        run.font.size = Pt(9)
        if i != len(lines) - 1:
            p.add_run("\n")
    return p


def parse_catalog_table(md: str) -> dict[str, dict[str, str]]:
    """
    Parse markdown tables from VULNERABILITY_CATALOG.md.
    Returns mapping: id -> {category, level, support, what, verify}
    """
    rows: dict[str, dict[str, str]] = {}
    for line in md.splitlines():
        line = line.strip()
        if not line.startswith("|"):
            continue
        if re.match(r"^\|\s*-+\s*\|", line):
            continue
        parts = [p.strip() for p in line.strip("|").split("|")]
        if len(parts) < 6:
            continue
        vuln_id = parts[0].strip()
        if not (vuln_id.startswith("`") and vuln_id.endswith("`")):
            continue
        vuln_id = vuln_id.strip("`")
        rows[vuln_id] = {
            "category": parts[1],
            "level": parts[2],
            "support": parts[3],
            "what": parts[4],
            "verify": parts[5],
        }
    return rows


def parse_scenarios(md: str) -> dict[str, dict[str, str]]:
    """
    Parse VULNERABILITY_SCENARIOS.md sections:
      ### `id`
      - **Что делает**: ...
      - **Учебный сценарий**: ...
      - **Проверка**: ...
    Returns mapping: id -> {what, scenario, verify}
    """
    out: dict[str, dict[str, str]] = {}
    current_id: str | None = None
    buf: list[str] = []

    def flush():
        nonlocal current_id, buf
        if not current_id:
            return
        text = "\n".join(buf)

        def grab(label: str) -> str:
            m = re.search(
                rf"-\s+\*\*{re.escape(label)}\*\*:\s*(.*?)(?=\n-\s+\*\*|\Z)",
                text,
                flags=re.S,
            )
            if not m:
                return ""
            return m.group(1).strip()

        out[current_id] = {
            "what": grab("Что делает"),
            "scenario": grab("Учебный сценарий"),
            "verify": grab("Проверка"),
        }
        current_id = None
        buf = []

    for line in md.splitlines():
        m = re.match(r"^###\s+`([^`]+)`\s*$", line.strip())
        if m:
            flush()
            current_id = m.group(1).strip()
            buf = []
            continue
        if current_id is not None:
            buf.append(line.rstrip())
    flush()
    return out


def ensure_spacing(doc: Document):
    """
    Best-effort: ensure there is at least one blank line between big blocks.
    """
    doc.add_paragraph("")


@dataclass
class Styles:
    normal: str
    h1: str
    h2: str
    h3: str
    special: str
    appendix: str


def main():
    target_path = pick_target_docx()
    doc = Document(str(target_path))

    styles = Styles(
        normal=choose_style(doc, "Обычный (отчет)", fallback="Normal"),
        h1=choose_style(doc, "Заголовок 1-го уровня (отчет)", fallback="Heading 1"),
        h2=choose_style(doc, "Заголовок 2-го уровня (отчет)", fallback="Heading 2"),
        h3=choose_style(doc, "Заголовок 3-го уровня (отчет)", fallback="Heading 3"),
        special=choose_style(doc, "Специальный заголовок (отчет)", fallback="Heading 1"),
        appendix=choose_style(doc, "Заголовок приложения", fallback="Heading 1"),
    )

    # 0) Quick cleanup: remove accidental filler like "фывафыва..."
    for p in list(doc.paragraphs):
        if "фывафыва" in (p.text or "").lower():
            remove_paragraph(p)

    # 0.1) Remove empty headings (appear after aggressive edits / copy-paste)
    for p in list(doc.paragraphs):
        if not (p.text or "").strip():
            s = p.style.name if p.style else ""
            if "Заголовок 2" in s or s.startswith("Heading 2"):
                remove_paragraph(p)

    # 1) Fix outdated references (repo cleanup)
    replace_in_all_paragraphs(
        doc,
        "build-example.sh",
        "Invoke-PackerBuildWithNextId.sh (или Invoke-PackerBuildWithNextId.ps1)",
    )

    # 2) Expand introduction
    intro_anchor = find_paragraph(
        doc,
        lambda p, t: t.upper() == "ВВЕДЕНИЕ",
    )
    intro_marker = "В рамках данной работы учебная площадка рассматривается как управляемый продукт"
    if intro_anchor and intro_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
        intro_extra = [
            "В рамках данной работы учебная площадка рассматривается как управляемый продукт: она должна быть воспроизводимой, "
            "переносимой между разными инсталляциями Proxmox VE и пригодной для многократного использования в учебном процессе.",
            "Актуальность темы обусловлена тем, что значительная доля инцидентов информационной безопасности связана не с «экзотическими» "
            "0‑day уязвимостями, а с типовыми ошибками администрирования: слабые пароли, лишние привилегии, отключение обновлений, "
            "небезопасные протоколы и отсутствие контроля изменений. Эти ошибки особенно характерны для небольших организаций, где "
            "администрирование часто совмещается с другими обязанностями и отсутствуют формализованные процессы hardening и аудита.",
            "С практической точки зрения обучение защите ОС требует среды, в которой студент может не только прочитать рекомендации, "
            "но и увидеть последствия неправильной настройки, собрать доказательства, предложить исправление и проверить результат. "
            "Поэтому в проекте сделан акцент на сценарии «аудит → фиксация доказательств → исправление → повторная проверка».",
            "Цель работы — разработка учебной площадки киберучений по защите операционных систем, включающей набор стендов, "
            "каталог типовых уязвимостей/ошибок администрирования и инструкции по развертыванию и сопровождению.",
            "Для достижения цели решались задачи: (1) определить типовые уязвимости и ошибки администрирования, "
            "(2) спроектировать учебные инфраструктуры, моделирующие конфигурационные ошибки и угрозы, "
            "(3) реализовать автоматизированное развертывание с использованием IaC, "
            "(4) подготовить документацию и методические материалы для преподавателей и обучающихся.",
            "Объект исследования — учебная инфраструктура для практикума по защите ОС. "
            "Предмет исследования — подходы к моделированию типовых уязвимостей и автоматизации развертывания и управления конфигурациями.",
            "В работе использованы методы: моделирование угроз, проектирование архитектуры, инфраструктурное программирование (IaC), "
            "конфигурационное управление (Ansible), а также экспериментальная проверка разворачиваемости и повторяемости стендов.",
            "Структура отчёта включает введение, главу 1 с классификацией типовых уязвимостей, главу 2 с проектированием учебной площадки, "
            "главу 3 с описанием реализации и эксплуатационных процедур, заключение и приложения.",
        ]
        insert_block_after(intro_anchor, intro_extra, style=styles.normal)

    # 3) Expand Chapter 1 rationale
    ch1_anchor = find_paragraph(
        doc,
        lambda p, t: "Пояснение по выбранным уязвимостям" in t,
    )
    ch1_marker = "Отбор уязвимостей проводился по принципу «обучаемости»"
    if ch1_anchor and ch1_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
        ch1_extra = [
            "Отбор уязвимостей проводился по принципу «обучаемости»: каждая уязвимость должна быть понятна студенту, "
            "иметь измеримый эффект и предсказуемо проверяться командами/инструментами аудита. "
            "Дополнительно учитывались критерии воспроизводимости (повторяемое включение/выключение), переносимости (Linux/Windows, "
            "Debian/Ubuntu и RHEL‑семейство) и ограничение по времени лабораторной работы.",
            "Важно подчеркнуть, что в учебном каталоге используются типовые ошибки администрирования, а не эксплуатация конкретных CVE. "
            "Это сделано сознательно: CVE быстро устаревают, требуют точных версий ПО и зачастую превращают занятие в «поиск эксплойта». "
            "Ошибки администрирования (weak policy, misconfiguration) остаются актуальными и напрямую связаны с практикой hardening.",
            "Категории уязвимостей сформированы так, чтобы покрывать наиболее частые классы проблем при аудите небольших инфраструктур: "
            "аутентификация/пароли, привилегии, удалённый доступ, права на файлы/секреты, обновления, небезопасные сервисы и протоколы, "
            "периметр/Firewall, логирование/аудит и базовые средства защиты. Такой набор обеспечивает связность учебного материала: "
            "студент учится связывать настройку ОС с последствиями (brute-force, privilege escalation, lateral movement, сокрытие следов).",
            "Отдельное внимание уделено доменной инфраструктуре (Active Directory) и групповым политикам (GPO). В реальных организациях "
            "ошибки в AD/GPO масштабируются быстрее всего: политика распространяется централизованно и влияет сразу на множество хостов. "
            "Поэтому в учебной площадке предусмотрены как «локальные» уязвимости хостов, так и доменные/политиковые уязвимости, "
            "которые проявляются на клиентах после применения GPO.",
            "Для каждой уязвимости задана процедура проверки (до/после). Это нужно не только для обучения, но и для эксплуатации стендов: "
            "администратор и преподаватель могут быстро убедиться, что профиль уязвимостей применился корректно, а повторный прогон Ansible "
            "не приводит к неожиданным изменениям (идемпотентность).",
            "В результате студент получает универсальный алгоритм работы с типовыми проблемами: "
            "(1) инвентаризировать настройки и собрать доказательства, "
            "(2) оценить риск и потенциальные последствия, "
            "(3) предложить исправление и применить изменения, "
            "(4) выполнить контрольную проверку и оформить отчёт по лабораторной работе.",
        ]
        insert_block_after(ch1_anchor, ch1_extra, style=styles.normal)

    # 3.1) Expand Chapter 1: categories (this is usually the biggest deficit for volume and understanding)
    ch1_groups = find_paragraph(doc, lambda p, t: t.strip() == "Группы типовых уязвимостей")
    if ch1_groups:
        ch1_groups_marker = "Ниже приведено расширенное описание категорий, выбранных для учебного каталога"
        if ch1_groups_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_groups,
                [
                    "Ниже приведено расширенное описание категорий, выбранных для учебного каталога. "
                    "Цель описания — показать, какие типовые ошибки входят в категорию, чем они опасны и как студент должен с ними работать.",
                    "1) Аутентификация и парольные политики. Категория включает слабые пароли, отключённый lockout, отсутствие требований к сложности пароля, "
                    "разрешение парольной аутентификации там, где должна быть ключевая (например, SSH). "
                    "Опасность этой категории в том, что она формирует «самый простой» путь атаки: подбор, использование утёкших учетных данных, "
                    "вход через плохо защищённые учётки. Практика аудита: проверить политики, параметры PAM/LSA, доменную password policy, "
                    "наличие MFA/ключей и ограничения по группам.",
                    "2) Привилегии и контроль доступа. Здесь рассматриваются лишние администраторы, `sudo NOPASSWD`, отключённый UAC, "
                    "небезопасные SUID/SGID файлы и другие упрощения повышения привилегий. "
                    "Категория важна, потому что компрометация обычной учётки в реальности часто неизбежна, а последствия определяются тем, "
                    "насколько быстро атакующий может стать администратором. Практика аудита: инвентаризация групп, анализ sudoers, поиск SUID, "
                    "проверка доменных групп (Domain Admins) и делегирования.",
                    "3) Удалённый доступ и удалённое администрирование. Категория включает небезопасные параметры SSH/RDP/WinRM: "
                    "слабая аутентификация, отсутствие ограничений по источникам, включение лишних служб удалённого управления. "
                    "Почему это важно: удалённый доступ — это «дверь» в систему, и неправильная настройка сильно увеличивает поверхность атаки. "
                    "Практика аудита: проверить, какие службы слушают сеть, какие политики доступа действуют, есть ли ограничения по группам и сегментам.",
                    "4) Файлы, права доступа и секреты. Сюда входят world-writable файлы, небезопасный PATH, хранение секретов в доступных местах, "
                    "ошибки прав на конфиги и ключи. В учебной практике эта категория учит студентов думать о последствиях «малых» ошибок: "
                    "один неверный chmod может привести к утечке пароля или локальной эскалации. Практика аудита: поиск world-writable, анализ прав, "
                    "поиск секретов и учетных данных в файлах.",
                    "5) Обновления и управление патчами. Категория включает отключённые обновления и устаревшие пакеты/компоненты. "
                    "В учебной среде важно показать компромисс между «стабильностью» и безопасностью: отключение обновлений снижает шанс «поломки», "
                    "но накапливает известные уязвимости. Практика аудита: статус автообновлений, политики WSUS/Windows Update, "
                    "репозитории Linux, контроль версий.",
                    "6) Сетевые службы и протоколы. Сюда относятся небезопасные/устаревшие протоколы и сервисы (LLMNR, SMB1, NTLMv1, telnet/ftp, RemoteRegistry). "
                    "Категория важна для понимания атак в локальной сети (MITM/relay) и принципов отключения наследия. Практика аудита: "
                    "проверка политик протоколов, списка сервисов, портов и правил firewall.",
                    "7) Сетевой периметр и firewall. Отключённый firewall или неверные правила приводят к тому, что сервисы становятся доступными из лишних сегментов. "
                    "В учебной площадке категория помогает показать, что безопасность — это не только настройки внутри ОС, но и границы доступа. "
                    "Практика аудита: проверка профилей firewall, открытых портов, принципа «минимально необходимых» правил.",
                    "8) Логирование, мониторинг и аудит. Категория включает отключённый аудит, слабую ретенцию журналов, отключение PowerShell логирования, "
                    "что затрудняет расследование и обнаружение атак. В учебной практике это позволяет объяснить студентам важность «наблюдаемости» системы. "
                    "Практика аудита: настройки eventlog/journald, auditd, GPO аудит, ретенция и доступность журналов.",
                    "9) Базовые средства защиты и политика безопасности. Сюда входят отключённый Defender/антивирус, ослабление защитных механизмов, "
                    "а также организационные настройки, влияющие на общую защищённость (например, отсутствие блокировки экрана). "
                    "Категория важна для демонстрации того, что даже базовые меры сильно повышают порог атаки, а их отключение быстро делает инфраструктуру уязвимой.",
                    "Таким образом категории охватывают как локальные настройки хостов, так и доменные политики, а также обеспечивают связность учебного сценария.",
                ],
                style=styles.normal,
            )

        ch1_groups_marker2 = "Ниже приведены примеры типовых учебных задач по каждой категории (на уровне сценария, а не конкретной уязвимости)"
        if ch1_groups_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_groups,
                [
                    "Ниже приведены примеры типовых учебных задач по каждой категории (на уровне сценария, а не конкретной уязвимости). "
                    "Такая подача помогает увеличить методическую ценность отчёта: студент получает понятный шаблон действий, а преподаватель — "
                    "возможность формировать задания под разные профили уязвимостей.",
                    "Категория 1 — Аутентификация и парольные политики (пример задачи):",
                    "Задание: выявить слабые политики паролей и отсутствие блокировок при подборе. "
                    "Доказательства: параметры password policy (локальной/доменной), успешные попытки входа при слабом пароле, отсутствие lockout. "
                    "Исправление: включить требования к сложности, задать минимальную длину, настроить lockout и ограничить парольную аутентификацию для SSH. "
                    "Проверка: повторить измерения политики и убедиться, что подбор/вход со слабым паролем невозможен.",
                    "Категория 2 — Привилегии и контроль доступа (пример задачи):",
                    "Задание: обнаружить, что обычный пользователь может получить admin/root из-за неверной настройки (NOPASSWD, лишние админы, SUID). "
                    "Доказательства: вывод `sudo -l`, список локальных администраторов, наличие SUID-бинарей. "
                    "Исправление: убрать NOPASSWD, минимизировать состав админ-групп, пересмотреть права на файлы. "
                    "Проверка: повторить команды и убедиться, что привилегии повышаются только по необходимости и с контролем.",
                    "Категория 3 — Удалённый доступ и администрирование (пример задачи):",
                    "Задание: найти небезопасный удалённый доступ (RDP/SSH) и показать, как он расширяет поверхность атаки. "
                    "Доказательства: включенный RDP без ограничений, SSH password_auth, отсутствие rate limiting. "
                    "Исправление: ограничить доступ по источникам/группам, включить ключевую аутентификацию, настроить rate limiting и audit. "
                    "Проверка: убедиться, что удалённый доступ остался управляемым, но стал ограниченным и контролируемым.",
                    "Категория 4 — Файлы, права доступа и секреты (пример задачи):",
                    "Задание: найти секреты/конфиги с небезопасными правами или небезопасный PATH. "
                    "Доказательства: world-writable файлы, наличие секретов в доступных каталогах, выполнение программы из текущего каталога из-за PATH. "
                    "Исправление: настроить права (минимально необходимые), убрать небезопасные пути из профилей, вынести секреты в защищённые места. "
                    "Проверка: повторить поиск и убедиться, что секреты недоступны обычному пользователю.",
                    "Категория 5 — Обновления и патчи (пример задачи):",
                    "Задание: показать последствия отключённых обновлений и оценить риск. "
                    "Доказательства: статус служб обновления, отключенные репозитории/WSUS, устаревшие версии. "
                    "Исправление: включить обновления или настроить контролируемый процесс обновления. "
                    "Проверка: убедиться, что обновления снова работают, и система получает патчи.",
                    "Категория 6 — Сетевые службы и протоколы (пример задачи):",
                    "Задание: обнаружить включённые устаревшие протоколы (LLMNR, SMB1, NTLMv1, telnet/ftp) и объяснить риск. "
                    "Доказательства: значения политик/реестра, список служб и открытых портов, сетевое поведение. "
                    "Исправление: отключить протоколы/службы или ограничить их использование в рамках минимально необходимого. "
                    "Проверка: повторить измерения и подтвердить закрытие/ограничение.",
                    "Категория 7 — Firewall и периметр (пример задачи):",
                    "Задание: показать, что отключённый firewall делает сервисы доступными из лишних сегментов. "
                    "Доказательства: статус firewall, сканирование портов из соседней машины/сегмента. "
                    "Исправление: включить firewall и задать минимально необходимые правила (например, разрешить SSH/AD/DNS только там, где нужно). "
                    "Проверка: повторить сканирование и убедиться, что доступ ограничен.",
                    "Категория 8 — Логирование и аудит (пример задачи):",
                    "Задание: обнаружить отсутствие журналов/аудита и объяснить, почему это препятствует расследованию. "
                    "Доказательства: настройки audit/eventlog, низкая ретенция, отключенное PowerShell логирование. "
                    "Исправление: включить аудит, настроить ретенцию, включить логирование команд. "
                    "Проверка: сгенерировать тестовое событие и убедиться, что оно попало в журнал.",
                    "Категория 9 — Базовые средства защиты и политика безопасности (пример задачи):",
                    "Задание: обнаружить отключённые базовые защиты (Defender, UAC) и небезопасные пользовательские политики (например отсутствие блокировки экрана). "
                    "Доказательства: состояние служб защиты, параметры политики блокировки, фактическое поведение. "
                    "Исправление: включить защиту и политики, обеспечить минимальные стандарты безопасности. "
                    "Проверка: подтвердить включение и корректную работу защитных механизмов.",
                    "Эти сценарии задают «каркас» практикума. Конкретные уязвимости в проекте подставляются как примеры внутри каждой категории, "
                    "а профили позволяют быстро менять сложность и наполнение занятий.",
                ],
                style=styles.normal,
            )

    ch1_explain = find_paragraph(doc, lambda p, t: t.strip() == "Пояснение по выбранным уязвимостям")
    if ch1_explain:
        ch1_explain_marker = "Выбор набора уязвимостей опирается на модель типовой атаки и учебные цели"
        if ch1_explain_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Выбор набора уязвимостей опирается на модель типовой атаки и учебные цели. "
                    "В небольших организациях атакующий чаще всего действует по цепочке: первичный доступ → закрепление → повышение привилегий → горизонтальное перемещение → "
                    "сокрытие следов. Ошибки администрирования напрямую поддерживают эту цепочку: слабые пароли дают вход, лишние привилегии дают root/admin, "
                    "небезопасные протоколы помогают перехвату, а выключенный аудит скрывает следы.",
                    "С педагогической точки зрения важно, чтобы уязвимость была:",
                    "- наблюдаемой (студент может увидеть её результат);",
                    "- проверяемой (есть команды/инструменты для доказательств);",
                    "- исправляемой (студент может применить корректное решение);",
                    "- сопоставимой по сложности (можно давать задания разным группам).",
                    "Поэтому в проект включены преимущественно конфигурационные уязвимости и ошибки политики. Они устойчивы во времени, "
                    "не зависят критически от конкретных версий ПО и хорошо подходят для формирования навыков аудита.",
                    "Отдельный блок уязвимостей связан с AD/GPO. Причина выбора — эффект масштабирования: одна неверная политика влияет сразу на все машины домена. "
                    "Это помогает студенту понять важность централизованного управления и контроля изменений в доменной среде.",
                    "Ключевой принцип: учебная уязвимость не должна полностью разрушать управляемость стенда. "
                    "Например, мы избегаем сценариев, где отключается SSH без альтернативного доступа, или где ломается сеть. "
                    "Это обеспечивает повторяемость и возможность проверки результата преподавателем.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Схема «цепочки атаки» и соответствие категорий уязвимостей этапам атаки (initial access → privilege escalation → defense evasion)]",
                ],
                style=styles.normal,
            )

        ch1_method_marker = "Методика аудита и исправления в учебном стенде строится вокруг цикла «проверка → доказательства → изменение → повторная проверка»"
        if ch1_method_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Методика аудита и исправления в учебном стенде строится вокруг цикла «проверка → доказательства → изменение → повторная проверка». "
                    "Этот цикл выбран как универсальный: он одинаково применим к Linux и Windows, а также к доменным настройкам через AD/GPO.",
                    "Этап 1. Первичная проверка. Студент формирует гипотезы на основе наблюдений (открытые порты, доступность сервисов, поведение системы) и "
                    "проверяет их командами/настройками. На этом этапе важно не «угадывать», а фиксировать конкретные факты.",
                    "Этап 2. Доказательная база. Для каждой найденной проблемы студент собирает артефакты: вывод команд, скриншоты, фрагменты конфигураций. "
                    "В отчёте это должно позволять третьей стороне воспроизвести проверку. Это приближает задание к реальной работе инженера ИБ.",
                    "Этап 3. План исправления. Исправление должно быть минимально достаточным (least privilege, минимум изменений) и не ломать управляемость стенда. "
                    "Например, нельзя просто «выключить всё»: нужно сохранить доступ администратора и работоспособность доменных сценариев.",
                    "Этап 4. Повторная проверка. Студент повторяет исходные проверки и демонстрирует, что проблема устранена. "
                    "Если исправление влияет на несколько машин (например через GPO), проверка должна охватывать и DC, и клиентов.",
                    "Типовые инструменты/проверки (примерный набор):",
                    "- Linux: `sudo -l`, проверка `/etc/sudoers.d`, `sshd -T`, `systemctl status`, проверка прав (`find`/`stat`), "
                    "проверка firewall (iptables/nft), проверка обновлений;",
                    "- Windows: PowerShell проверки политик/реестра, состояние служб, правила firewall, состояние Defender/Updates;",
                    "- AD/GPO: `Get-ADDefaultDomainPasswordPolicy`, проверки состава групп, `gpresult /r`, `gpupdate /force`, проверка линковки GPO и security filtering.",
                    "Важно подчеркнуть: в рамках учебного процесса цель — не «сделать идеальный CIS hardening», а научиться последовательно работать с конфигурациями, "
                    "понимать последствия и подтверждать результат проверками. Поэтому сценарии в проекте намеренно модульные и проверяемые.",
                ],
                style=styles.normal,
            )

        ch1_rationale_marker = "Выбранные категории отражают практику эксплуатации небольших организаций и типовые причины конфигурационных ошибок"
        if ch1_rationale_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Выбранные категории отражают практику эксплуатации небольших организаций и типовые причины конфигурационных ошибок. "
                    "В таких инфраструктурах часто отсутствуют формальные процессы управления изменениями, нет выделенного SOC/monitoring, "
                    "а ИТ‑персонал совмещает поддержку пользователей и администрирование. Это приводит к тому, что решения принимаются "
                    "по принципу «быстро восстановить работоспособность», даже если это снижает безопасность.",
                    "Типовые причины появления уязвимостей в малых организациях:",
                    "- дефицит времени и компетенций (настройки делаются один раз и «забываются»);",
                    "- отсутствие инвентаризации (никто не знает, какие службы реально включены и зачем);",
                    "- отсутствие контроля доступа (локальные админы по умолчанию, общие пароли, временные учётки остаются навсегда);",
                    "- страх «сломать» систему обновлениями и политиками безопасности (отсюда отключение updates/Defender/firewall);",
                    "- наследие (устаревшие протоколы и сервисы продолжают работать ради совместимости).",
                    "Для учебной площадки важно, чтобы эти причины были «видимыми» студенту. Поэтому уязвимости в проекте реализованы так, "
                    "чтобы студент мог проследить логику администратора: зачем включили, что это дало в удобстве и какой риск создало.",
                    "Отдельно выделены доменные уязвимости (AD/GPO). Это объясняется тем, что даже в небольших организациях домен часто становится "
                    "центральной точкой управления. Ошибка в одной GPO или слабая доменная политика паролей создаёт системный риск и масштабируется "
                    "на все рабочие станции и серверы. В учебном процессе это помогает показать эффект централизованной конфигурации.",
                    "Связь с моделью угроз: категории можно сопоставить этапам атаки и практикам MITRE ATT&CK. "
                    "Например, слабые пароли и отсутствие lockout поддерживают техники credential access, "
                    "NOPASSWD и лишние администраторы — privilege escalation, отключённый аудит — defense evasion, "
                    "а доменные политики и протоколы — lateral movement и persistence в доменной среде.",
                    "Почему не ограничиваться только CVE: уязвимости ПО важны, но они быстро устаревают и зависят от версии. "
                    "Конфигурационные ошибки более устойчивы во времени и лучше подходят для формирования навыка: "
                    "умения измерять текущее состояние, понимать риск, применять исправления и проверять результат.",
                    "Тем не менее, в реальной практике CVE и конфигурации взаимосвязаны: отключённые обновления повышают вероятность эксплуатации CVE, "
                    "а слабые политики доступа упрощают пост‑эксплуатацию. Поэтому в сценариях обучения логика сочетает оба аспекта: "
                    "студент видит, что безопасная конфигурация — это не одна «галочка», а система взаимосвязанных решений.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Диаграмма причин конфигурационных ошибок (время/наследие/процессы) и их связь с категориями]",
                ],
                style=styles.normal,
            )

        ch1_ad_marker = "Особенность доменных уязвимостей (AD/GPO) в том, что они меняют безопасность не одной машины, а всей группы"
        if ch1_ad_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Особенность доменных уязвимостей (AD/GPO) в том, что они меняют безопасность не одной машины, а всей группы. "
                    "Если локальная ошибка влияет на конкретный хост, то доменная политика способна одновременно изменить десятки рабочих станций. "
                    "Поэтому в учебной площадке AD рассматривается как обязательный элемент, а GPO‑уязвимости выделены в отдельный набор.",
                    "Типовые доменные ошибки администрирования, на которых строятся задания:",
                    "1) Ослабление password policy домена. Это ведёт к появлению слабых паролей и снижает эффективность защиты от подбора/утечек. "
                    "Важно, что доменная политика влияет на всех пользователей домена и не зависит от локальных настроек клиента.",
                    "2) Отключение account lockout через доменную политику. На практике это встречается как попытка уменьшить число обращений в поддержку "
                    "из‑за блокировок, но в результате резко упрощается перебор паролей и password spraying.",
                    "3) Разрешение LLMNR/NBNS, NTLMv1, ослабление SMB signing. Эти настройки создают условия для атак в локальной сети "
                    "(relay, MITM, перехват хэшей), особенно в сегментах, где много клиентских машин.",
                    "4) Отключение firewall/Defender/updates через GPO. Такая политика иногда применяется ради совместимости или «чтобы не мешало», "
                    "но фактически снимает базовый уровень защиты сразу со всей группы машин.",
                    "5) Отключение журналирования и аудита (включая PowerShell logging). Это не даёт атакующему «доступ», но значительно усложняет обнаружение и расследование. "
                    "В учебном процессе важно показать, что отсутствие логов — это тоже уязвимость управления.",
                    "Педагогический смысл доменных уязвимостей: студент учится отличать локальную настройку от доменной и понимать, где искать источник проблемы. "
                    "Например, локально на Windows 10 может выглядеть так, будто «включён LLMNR», но корень находится в GPO на DC. "
                    "Это подводит к идее управления изменениями и ответственности администраторов домена.",
                    "Как строится проверка в доменном сценарии:",
                    "- на DC: проверить настройки политики/объекты GPO и их применимость (линковка к OU, security filtering);",
                    "- на клиенте: выполнить `gpresult /r` и проверить фактические значения политик/реестра;",
                    "- после исправления: повторить `gpupdate /force` и подтвердить, что изменения пришли на клиент.",
                    "Таким образом AD/GPO‑часть дополняет локальные уязвимости и делает стенды более реалистичными: студент видит, что безопасность в домене "
                    "— это система, где ошибки централизованного управления критичнее локальных настроек.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Поток GPO (DC → OU → клиент) и точки проверки (линковка, gpresult, фактическое значение)]",
                ],
                style=styles.normal,
            )

        ch1_levels_marker = "Для управления сложностью практикума в проекте используется условный уровень уязвимости (low/medium/high)"
        if ch1_levels_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Для управления сложностью практикума в проекте используется условный уровень уязвимости (low/medium/high). "
                    "Это не «оценка CVSS», а методический инструмент: он помогает преподавателю формировать задания под разные группы и "
                    "планировать нагрузку на занятие.",
                    "Пример интерпретации уровней:",
                    "- low: уязвимость легко обнаруживается и исправляется базовыми средствами ОС; чаще всего затрагивает одну настройку "
                    "(например, включённый/выключенный firewall, политика блокировки экрана).",
                    "- medium: требует анализа нескольких параметров или понимания взаимодействия компонентов "
                    "(например, сочетание SSH настроек и политики пользователей, или проверка применимости GPO на клиенте).",
                    "- high: требует системного подхода и часто затрагивает доменную среду или несколько машин, "
                    "либо связано с повышением привилегий (например, доменные политики, эскалация привилегий, отключение аудита).",
                    "Зачем это нужно: в учебной группе часто разный уровень подготовки. "
                    "Профили уязвимостей позволяют собрать «набор на занятие», а уровень помогает быстро оценить, "
                    "сколько времени потребуется на аудит и исправление.",
                    "Баланс реализма и управляемости: слишком «жёсткие» уязвимости могут сделать стенд непригодным "
                    "(например, отключение SSH без альтернативы). Поэтому в проекте действует правило: уязвимость не должна разрушать управляемость, "
                    "а преподаватель должен иметь операторский доступ для проверки.",
                    "Рекомендуемая схема занятия по уровням:",
                    "- базовая часть: 2–3 уязвимости уровня low (разогрев, формирование навыка доказательств);",
                    "- основная часть: 2 уязвимости уровня medium (анализ причин/взаимосвязей);",
                    "- продвинутая часть: 1 уязвимость уровня high (доменная политика/эскалация/аудит) как итоговое задание.",
                    "Такой подход позволяет сохранить единый формат отчёта и критерии оценки, но варьировать сложность и объём работы.",
                ],
                style=styles.normal,
            )

        ch1_controls_marker = "Категории уязвимостей можно связать с практиками и контролями (CIS Benchmarks, NIST) — это повышает прикладную ценность обучения"
        if ch1_controls_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_explain,
                [
                    "Категории уязвимостей можно связать с практиками и контролями (например, CIS Benchmarks и рекомендации NIST) — это повышает прикладную ценность обучения. "
                    "Студент видит, что исправления не являются «частными хитростями», а соответствуют общепринятым направлениям hardening.",
                    "Примеры соответствий (в обобщённом виде):",
                    "- аутентификация/пароли: требования к сложности, lockout, запрет устаревших протоколов аутентификации;",
                    "- привилегии: минимизация администраторов, контроль sudo/UAC, разделение ролей;",
                    "- удалённый доступ: ограничение RDP/SSH по источникам, применение безопасных настроек и журналирование;",
                    "- обновления: управление патчами и контроль версий;",
                    "- протоколы/службы: отключение наследия, минимизация поверхности атаки;",
                    "- firewall: принцип «deny by default» и открытие только необходимых портов;",
                    "- логирование/аудит: включение журналов, ретенция, контроль доступа к логам;",
                    "- базовые средства защиты: включение антивируса/защитных механизмов и политики блокировки.",
                    "Практический смысл такого сопоставления: в итоговом отчёте студент может не только показать «что исправил», "
                    "но и объяснить, почему это исправление соответствует лучшим практикам. Это важно для формирования инженерного мышления.",
                    "Приоритизация исправлений в учебной работе также может быть риск‑ориентированной. "
                    "Например, в первую очередь исправляются настройки, которые дают атакующему первичный доступ или привилегии (пароли, sudo/UAC), "
                    "затем — настройки, расширяющие поверхность атаки (службы/протоколы), и затем — настройки, влияющие на обнаружение (логирование/аудит).",
                    "Такой подход помогает студентам планировать работу и не тратить всё время на «косметические» изменения, "
                    "не устраняя при этом ключевые риски.",
                    "[МЕСТО ДЛЯ ТАБЛИЦЫ: Приоритизация исправлений (быстрые победы/критичные/долгосрочные) и примеры по категориям]",
                ],
                style=styles.normal,
            )

    # 4) Expand Chapter 2 architecture section (before the existing bullet list)
    ch2_arch_anchor = find_paragraph(
        doc,
        lambda p, t: t.strip() == "Архитектура и компоненты",
    )
    ch2_arch_marker = "Архитектура платформы намеренно разделена на уровни"
    if ch2_arch_anchor and ch2_arch_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
        ch2_arch_extra = [
            "Архитектура платформы намеренно разделена на уровни (templates → provisioning → configuration), "
            "чтобы уменьшить связность и упростить сопровождение. Изменение шаблона ВМ не должно требовать правок в Terraform‑модулях, "
            "а изменение набора уязвимостей не должно влиять на процесс создания/клонирования ВМ.",
            "Уровень «templates» отвечает за базовый образ: включённый SSH, установленный/включённый QEMU Guest Agent (где требуется), "
            "корректный режим загрузки (UEFI/OVMF для cloud-init образов), стабильная консоль (vga=std) и минимальный набор пакетов. "
            "Такой подход снижает число «ручных» шагов и уменьшает вероятность, что стенд развалится из‑за различий базовых образов.",
            "Terraform используется как инструмент «provisioning»: он создаёт виртуальные машины из подготовленных шаблонов, "
            "привязывает сеть (bridge), диски и cloud-init, а также фиксирует инфраструктуру в виде состояния (state). "
            "Это важно для повторяемости и контроля изменений: Terraform позволяет видеть, что именно изменилось между запусками.",
            "Ansible отвечает за «configuration»: учетные записи и группы, доменное присоединение (опционально), организационная автоматизация "
            "(OU/группы/GPO) и включение уязвимостей по профилям. Разделение на роли делает систему расширяемой: новые уязвимости добавляются "
            "без переписывания плейбуков — достаточно добавить новый task‑файл и зарегистрировать ID в списке известных уязвимостей.",
            "Отдельно предусмотрены механизмы переносимости: сетевые параметры (bridge, DHCP/статический адрес, gateway, DNS) задаются "
            "переменными, а секреты (пароли/API‑токены) вынесены в локальные файлы, игнорируемые Git. Это позволяет разворачивать стенды "
            "в разных Proxmox‑лабораториях без переписывания исходного кода проекта.",
        ]
        insert_block_after(ch2_arch_anchor, ch2_arch_extra, style=styles.normal)

    # 5) Add missing Chapter 2 sections right before "Выводы по главе 2"
    ch2_conclusion = find_paragraph(doc, lambda p, t: t.strip() == "Выводы по главе 2")
    if ch2_conclusion:
        # 5.1 Tooling choice section
        tooling_marker = "В отличие от монолитного подхода «один инструмент на всё»"
        if tooling_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_paragraph_before(ch2_conclusion, "", style=styles.normal)
            insert_paragraph_before(ch2_conclusion, "Выбор и проектирование средств автоматизации", style=styles.h2)
            insert_block_before(
                ch2_conclusion,
                [
                    "В отличие от монолитного подхода «один инструмент на всё», в проекте используется связка Packer/Terraform/Ansible, "
                    "так как у этих инструментов разные сильные стороны: Packer формирует эталонный образ, Terraform отвечает за создание "
                    "объектов инфраструктуры и жизненный цикл ресурсов, Ansible — за идемпотентную конфигурацию внутри ОС.",
                    "Альтернативы, рассмотренные при проектировании:",
                    "1) «всё на Ansible»: удобно для конфигурации, но хуже для управления инфраструктурным состоянием и зависимостями Proxmox‑ресурсов;",
                    "2) «всё на Terraform»: неудобно для тонкой настройки ОС и доменной логики (GPO/OU), где требуется многоусловная логика;",
                    "3) «ручная сборка шаблонов и ручной деплой»: неприемлемо для учебного процесса из‑за высокой трудоёмкости и дрейфа конфигураций;",
                    "4) «облачный провайдер вместо Proxmox»: снижает контроль над средой, повышает стоимость и усложняет изоляцию в локальной лаборатории.",
                    "Выбор Proxmox VE обусловлен тем, что платформа широко используется в учебных/лабораторных средах, поддерживает API, "
                    "пулы ресурсов и ACL (RBAC), а также предоставляет удобные инструменты для клонов/шаблонов и консольного доступа.",
                    "Управление Windows через SSH (OpenSSH Server + PowerShell) выбрано по двум причинам: единый транспорт для Ansible "
                    "(SSH для Linux и Windows) и более предсказуемая работа в изолированных лабораторных сетях по сравнению с WinRM, "
                    "который требует дополнительной настройки и часто конфликтует с политиками безопасности и межсетевыми экранами.",
                ],
                style=styles.normal,
            )

        # 5.2 Repository structure section (place existing paragraphs under a named heading)
        repo_marker = "Репозиторий организован по принципу «стенд как единица поставки»"
        if repo_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_paragraph_before(ch2_conclusion, "", style=styles.normal)
            insert_paragraph_before(ch2_conclusion, "Структура репозитория и документации", style=styles.h2)
            repo_tree = "\n".join(
                [
                    "Структура репозитория:",
                    "├── stands/                         # стенды (Windows/Linux): terraform/ansible/templates/packer/scripts",
                    "│   ├── windows-stand/",
                    "│   └── linux-stand/",
                    "├── ansible/roles/                   # переиспользуемые роли (accounts, ad_join, vuln_*)",
                    "├── terraform/modules/               # общие Terraform-модули (сеть/ВМ), переиспользуемые в стендах",
                    "├── docs/guides/                     # руководства по эксплуатации и методические материалы",
                    "└── tools/                           # утилиты (генерация/обновление отчёта и пр.)",
                ]
            )
            insert_block_before(
                ch2_conclusion,
                [
                    "Репозиторий организован по принципу «стенд как единица поставки»: все файлы, необходимые для развертывания конкретного "
                    "стенда (Terraform‑конфигурации, Ansible‑плейбуки, скрипты деплоя и создание шаблонов), находятся в каталоге соответствующего стенда.",
                    "Такое разбиение выбрано для уменьшения порога входа администраторов: чтобы развернуть стенд, достаточно перейти в один каталог "
                    "и следовать инструкции, не «собирая» проект из разрозненных папок.",
                    "Общие Ansible‑роли вынесены в `ansible/roles/`, чтобы не дублировать код между стендами. "
                    "Аналогично, общие Terraform‑блоки вынесены в `terraform/modules/` — это позволяет унифицировать типовые настройки "
                    "(сетевые параметры, диски, агент, cloud-init) и уменьшить вероятность расхождений.",
                    "[МЕСТО ДЛЯ ЛИСТИНГА: Пример дерева директорий репозитория (полный вывод `tree`/`dir` для вставки в отчёт)]",
                ],
                style=styles.normal,
            )
            # Put tree as monospace block inside this section (right before the next sections)
            insert_paragraph_before(ch2_conclusion, "", style=styles.normal)
            insert_code_block_before(ch2_conclusion, repo_tree, style=styles.normal)

        # 5.3 Parameterization & portability
        param_marker = "Ключевая идея переносимости — отсутствие «зашитых» параметров площадки"
        if param_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_paragraph_before(ch2_conclusion, "", style=styles.normal)
            insert_paragraph_before(ch2_conclusion, "Модель параметризации и переносимости", style=styles.h2)
            insert_block_before(
                ch2_conclusion,
                [
                    "Ключевая идея переносимости — отсутствие «зашитых» параметров площадки (node/storage/bridge/IP‑план). "
                    "Все значения, зависящие от конкретной лаборатории Proxmox, задаются переменными и примерными файлами `*.example`.",
                    "На стороне Terraform переносимость достигается параметрами `proxmox_node`, `storage`, `proxmox_bridge`, "
                    "а также режимом сети DHCP/статический адрес. Это позволяет разворачивать стенды в других подсетях без правок `.tf` файлов.",
                    "На стороне Ansible переносимость обеспечивается профилями в `group_vars`: "
                    "администратор выбирает, какие уязвимости включить, какие учётные записи создать и какие хосты присоединять к домену.",
                    "Секреты (API‑токен Proxmox, пароли, ключи) не коммитятся: проект содержит `.gitignore` для `*.tfvars` и secrets‑файлов, "
                    "а также примеры (`*.example`). При необходимости может использоваться Ansible Vault, но базовый сценарий допускает "
                    "хранение секретов локально (вне Git) для упрощения внедрения в учебных лабораториях.",
                ],
                style=styles.normal,
            )

        # 5.4 Evaluation design
        eval_marker = "Система оценки строится вокруг измеримых артефактов"
        if eval_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_paragraph_before(ch2_conclusion, "", style=styles.normal)
            insert_paragraph_before(ch2_conclusion, "Проектирование системы оценки результатов", style=styles.h2)
            insert_block_before(
                ch2_conclusion,
                [
                    "Система оценки строится вокруг измеримых артефактов, которые студент обязан предоставить по итогам работы со стендом. "
                    "Подход выбран для того, чтобы проверка была объективной и одинаковой для разных вариантов профилей уязвимостей.",
                    "Рекомендуемый набор критериев (пример):",
                    "- корректно описаны найденные проблемы (минимум N уязвимостей из профиля);",
                    "- приведены доказательства (команды/скриншоты) до исправления;",
                    "- предложено исправление с обоснованием (почему именно так);",
                    "- выполнены изменения и повторная проверка (до/после);",
                    "- оформлен итоговый отчёт и выводы по рискам.",
                    "Отдельно может оцениваться качество hardening‑плана: приоритизация (что исправлять сначала), влияние на доступность сервиса "
                    "и корректность выбора компромиссов (например, отказ от NOPASSWD при сохранении минимально необходимых команд).",
                ],
                style=styles.normal,
            )

        # 5.5 Template requirements (expand existing short section if present)
        tmpl_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Требования к шаблонам и агентам (SSH, QEMU GA)")
        if tmpl_anchor:
            tmpl_marker = "Требования к шаблонам введены как отдельный раздел"
            if tmpl_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
                insert_block_after(
                    tmpl_anchor,
                    [
                        "Требования к шаблонам введены как отдельный раздел, потому что именно на уровне базовых образов чаще всего возникают "
                        "проблемы воспроизводимости: разная версия ОС, отличия в настройках загрузки, отсутствие гостевого агента или выключенный SSH "
                        "приводят к тому, что инфраструктурный код формально «правильный», но стенд не разворачивается в стабильном виде.",
                        "Для Linux-стенда в проекте выбран подход cloud-init + cloud-image, поскольку он обеспечивает быструю сборку и единообразие: "
                        "один подготовленный образ можно многократно клонировать, а первичная настройка (пользователь, ключи, сеть) задаётся декларативно. "
                        "Альтернатива (ручная установка из ISO или preseed/kickstart) требует больше времени и сложнее в сопровождении для учебной лаборатории.",
                        "UEFI/OVMF и машина q35 используются осознанно: многие современные cloud-images рассчитаны на UEFI, а явное указание режима загрузки "
                        "снижает число «неочевидных» ошибок при переносе стенда на другой Proxmox. Параметр vga=std фиксируется для стабильной работы noVNC-консоли.",
                        "QEMU Guest Agent нужен не для управления (Ansible работает по SSH), а для эксплуатационной удобства: определение IP-адреса ВМ в Proxmox, "
                        "корректное завершение/перезагрузка, а также диагностика состояния гостевой ОС. В учебной среде это ускоряет проверку стенда преподавателем.",
                        "Для Windows-шаблонов в проекте применяется Packer, так как Windows не имеет cloud-init в стандартном виде. Цель Packer — подготовить "
                        "унифицированный шаблон: включить OpenSSH Server, обеспечить наличие учётной записи для Ansible, установить virtio/guest tools (рекомендуется) "
                        "и задать базовые параметры безопасности/управляемости. Это снимает большую часть ручной работы при повторном создании стендов.",
                        "Критичные требования для управляемости стендов:",
                        "- SSH включён и доступен (Linux и Windows);",
                        "- ключ/пароль администратора задаётся до развертывания (cloud-init для Linux, bootstrap-подход для Windows);",
                        "- сетевые параметры задаются переменными (bridge, DHCP/статический адрес, DNS);",
                        "- гостевой агент включён в Proxmox и установлен в ВМ (по возможности).",
                    ],
                    style=styles.normal,
                )

    # 5.6) Expand "Цели и исходные условия..." (usually short, but important for "почему так")
    goals_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Цели и исходные условия проектирования учебной площадки")
    if goals_anchor:
        goals_marker = "При проектировании учебной площадки учитывались ограничения учебного процесса"
        if goals_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                goals_anchor,
                [
                    "При проектировании учебной площадки учитывались ограничения учебного процесса и особенности небольших организаций, "
                    "для которых чаще всего характерны смешанные роли (администратор = инженер поддержки) и отсутствие зрелых процессов безопасности. "
                    "Поэтому ключевой целью стало создание стендов, которые одновременно демонстрируют типовые риски и остаются управляемыми при массовом использовании.",
                    "Нефункциональные требования (почему они важны):",
                    "1) Воспроизводимость. Стенд должен разворачиваться «с нуля» одинаково, чтобы разные группы студентов получали сопоставимую среду. "
                    "Это снижает влияние случайных факторов и позволяет честно оценивать результаты.",
                    "2) Переносимость. В разных лабораториях Proxmox отличаются bridge, подсети, хранилища и политики доступа. "
                    "Если параметры «зашиты» в код, проект сложно внедрять. Поэтому все такие значения вынесены в переменные и примерные файлы.",
                    "3) Управляемость и минимизация ручного труда. При курсе на 2–4 группы ручная настройка превращается в узкое место. "
                    "Автоматизация через IaC позволяет тратить время не на «перекликивание», а на сопровождение сценариев и методические материалы.",
                    "4) Безопасность эксплуатации. Учебная среда содержит намеренно ослабленные настройки, поэтому важно ограничить их влияние: "
                    "изолировать сегменты, минимизировать права студентов в Proxmox, исключить коммит секретов и иметь возможность быстро пересоздать стенд.",
                    "Функциональные требования (какие возможности должны быть в проекте):",
                    "- наличие доменной инфраструктуры (DC + GPO) как обязательного элемента Windows-стенда;",
                    "- возможность включать/выключать присоединение к домену для отдельных ВМ (для разных сценариев занятий);",
                    "- единый способ управления хостами для Ansible (SSH и для Linux, и для Windows);",
                    "- конфигурируемые учетные записи/группы для администраторов и студентов;",
                    "- каталог уязвимостей, включаемый по профилям, чтобы быстро формировать разные варианты практикума.",
                    "[МЕСТО ДЛЯ ТАБЛИЦЫ: Таблица — свод требований (функциональные/нефункциональные) и как они реализованы в проекте]",
                ],
                style=styles.normal,
            )

    # 5.7) Expand stand composition & network topology (important, but currently short)
    topo_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Состав стендов и топология сети")
    if topo_anchor:
        topo_marker = "Сетевое проектирование в учебной площадке решает две задачи"
        if topo_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                topo_anchor,
                [
                    "Сетевое проектирование в учебной площадке решает две задачи: обеспечить реалистичность сценариев (AD, взаимодействие сервисов) "
                    "и одновременно ограничить влияние намеренно ослабленных конфигураций на остальную инфраструктуру лаборатории.",
                    "Состав стендов выбран так, чтобы моделировать «малую организацию» и покрывать ключевые роли:",
                    "- Windows-стенд: Domain Controller (AD DS + DNS) как центральный компонент, сервер (условный файловый/служебный) и рабочая станция (Windows 10);",
                    "- Linux-стенд: Linux Server (узел с сервисами/политиками) и Linux Workstation (рабочее место) для практики аудита и hardening.",
                    "Почему Domain Controller обязателен: в реальных организациях Active Directory является «центром управления» идентичностями и политиками. "
                    "Даже небольшие ошибки на DC (политика паролей, LLMNR/NTLM, firewall) масштабируются на всех клиентов через GPO. "
                    "Без DC невозможно полноценно отработать доменные сценарии и показать студентам эффект централизованной конфигурации.",
                    "При этом присоединение к домену сделано выбираемым по профилю. Это важно методически: иногда требуется показать различия "
                    "между локальной политикой и доменной, а иногда — отработать «изолированную» машину без доменных зависимостей.",
                    "Сетевая схема (рекомендуемая): каждый стенд размещается в выделенном L2/L3 сегменте (VLAN/подсеть) или хотя бы в отдельном диапазоне, "
                    "доступ к стендам обеспечивается через VPN/контролируемый шлюз. Это позволяет:",
                    "- ограничить сканирование и «шум» между группами;",
                    "- безопасно включать небезопасные протоколы в рамках одного стенда (SMB1, LLMNR, telnet/ftp) без риска для остальной сети;",
                    "- упростить сопровождение (понятный IP-план и правила доступа).",
                    "В проекте сеть параметризуется: администратор выбирает bridge, режим DHCP или статический адрес, шлюз и DNS. "
                    "Так стенды переносятся между лабораториями без переписывания Terraform. "
                    "Рекомендуемая практика — использовать DHCP для рабочих станций и статические адреса для DC/серверов (для стабильности DNS/AD).",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Топология стенда с указанием сегментов/VLAN, DC/DNS и точек доступа преподавателя/студента]",
                ],
                style=styles.normal,
            )
        topo_marker2 = "Дополнительные рекомендации по изоляции стендов нужны из-за намеренно ослабленных конфигураций"
        if topo_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                topo_anchor,
                [
                    "Дополнительные рекомендации по изоляции стендов нужны из-за намеренно ослабленных конфигураций. "
                    "Учебные уязвимости (например включённый LLMNR, SMB1, отключённый firewall) могут быть опасны для соседних сегментов, "
                    "если стенд не изолирован. Поэтому важно заранее продумать границы доступа и правила межсетевого взаимодействия.",
                    "Практические варианты изоляции (от простого к строгому):",
                    "1) Один общий сегмент на группу + ACL в Proxmox. Подходит для небольшого числа студентов, но повышает риск «шумного» взаимодействия между стендами.",
                    "2) Отдельный VLAN/подсеть на стенд. Удобно, если сеть лаборатории позволяет быстро создавать VLAN и маршрутизацию. "
                    "Так изоляция достигается на сетевом уровне, а не только через Proxmox.",
                    "3) Отдельный виртуальный маршрутизатор/фаервол на стенд (pfSense/RouterOS) как учебный элемент. "
                    "Это повышает реализм и позволяет учить сетевой hardening, но увеличивает сложность стенда.",
                    "Независимо от выбранного варианта рекомендуется ограничивать внешний доступ: студентам достаточно VPN + доступ к Proxmox, "
                    "а прямой доступ к ВМ по RDP/SSH стоит выдавать только по политике курса. "
                    "В частности, RDP лучше ограничивать по источникам или использовать jump-host, чтобы не открывать его «на весь VPN».",
                    "Также важно учитывать, что DC является DNS для домена. Если клиенты используют внешний DNS, доменные сценарии перестают работать. "
                    "Поэтому для доменных машин нужно либо задавать DNS=DC, либо включать автоматическую настройку DNS в роли `ad_join`.",
                    "В итоге правильно спроектированная сеть делает стенды безопасными для эксплуатации и предсказуемыми для обучения: "
                    "студент решает задачу по hardening, а не «борется» со случайными сетевыми эффектами.",
                ],
                style=styles.normal,
            )

    # 5.8) Expand automation tool choice (still short)
    auto_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Выбор и проектирование средств автоматизации")
    if auto_anchor:
        auto_marker = "Разделение на Terraform и Ansible снижает риск смешения ответственности"
        if auto_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                auto_anchor,
                [
                    "Разделение на Terraform и Ansible снижает риск смешения ответственности. Terraform описывает инфраструктурные объекты "
                    "(ВМ, диски, сетевые интерфейсы, cloud-init) и фиксирует их состояние. Ansible описывает конфигурацию внутри ОС (учётки, домен, политики, уязвимости). "
                    "Такой подход проще сопровождать: изменения в ОС не приводят к «дрифту» Terraform state, а инфраструктурные изменения не требуют переписывать плейбуки.",
                    "Почему в проекте оставлены скрипты `deploy.sh`, а не один «монолитный» плейбук: на практике развёртывание стенда состоит из стадий, "
                    "которые удобно запускать независимо (создать шаблоны → поднять ВМ → дождаться доступности SSH → применить Ansible). "
                    "Скрипт связывает эти стадии, обеспечивает порядок и добавляет эксплуатационные проверки (ожидание SSH).",
                    "Кроссплатформенность (PowerShell + bash) добавлена сознательно. Администратор может работать как с Windows, так и с Linux-хоста. "
                    "Это актуально для учебных лабораторий, где окружение преподавателя может отличаться. "
                    "При этом логика развёртывания сохраняется общей: одинаковые переменные, те же файлы конфигурации и одинаковые команды Terraform/Ansible.",
                    "Отдельно учитывалась практическая устойчивость: в реальных лабораториях часто встречаются проблемы с консолью Proxmox, загрузкой UEFI, "
                    "доступностью IP, QEMU агентом. Поэтому проект включает диагностические рекомендации и параметры, улучшающие стабильность (vga=std, agent=1, serial0).",
                ],
                style=styles.normal,
            )
        auto_marker2 = "Ещё одно проектное решение — унифицировать транспорт управления через SSH"
        if auto_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                auto_anchor,
                [
                    "Ещё одно проектное решение — унифицировать транспорт управления через SSH. "
                    "В типовой связке Ansible+Windows часто используют WinRM, однако в учебных лабораториях WinRM требует дополнительной настройки, "
                    "может конфликтовать с политиками безопасности и сложнее диагностируется при сетевых ограничениях.",
                    "Использование OpenSSH Server на Windows позволяет управлять и Linux, и Windows одинаково: SSH + команды PowerShell. "
                    "Это упрощает документацию и снижает количество частных случаев в плейбуках.",
                    "Компромисс такого подхода — необходимость заранее подготовить Windows шаблон (Packer) так, чтобы SSH был включён и работал корректно. "
                    "Однако это разовая стоимость, которая окупается при многократном развёртывании стендов.",
                    "В дополнение к инструментам IaC проект включает эксплуатационные руководства. Это важно, потому что технический стек сам по себе не гарантирует успех — "
                    "нужны регламенты: где хранить секреты, как переносить стенд, как выдавать доступ студентам, как проверять готовность.",
                ],
                style=styles.normal,
            )

    # 5.9) Expand assessment design (still short)
    assess_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Проектирование системы оценки результатов")
    if assess_anchor:
        assess_marker = "Для преподавателя важно отделить «нашёл уязвимость» от «правильно исправил»"
        if assess_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                assess_anchor,
                [
                    "Для преподавателя важно отделить «нашёл уязвимость» от «правильно исправил». В практикуме по защите ОС цель не в том, "
                    "чтобы студент перечислил проблемы, а в том, чтобы он показал причинно‑следственную связь и обосновал изменения. "
                    "Поэтому оценивание строится по нескольким осям: обнаружение → доказательства → исправление → повторная проверка → качество отчёта.",
                    "Пример рубрики (может быть адаптирован под занятие):",
                    "- 30%: обнаружение и корректная классификация проблем (категория, риск, где проявляется);",
                    "- 30%: доказательная база (команды/скриншоты/конфиги, воспроизводимость проверки);",
                    "- 30%: качество исправления (least privilege, минимальные изменения, отсутствие побочных эффектов);",
                    "- 10%: оформление и выводы (приоритизация, рекомендации, понимание компромиссов).",
                    "Важно, что часть критериев может проверяться автоматически: например, после «исправления» студент предоставляет команды проверки, "
                    "а преподаватель сравнивает результат с ожидаемым. Это снижает субъективность и ускоряет проверку работ.",
                    "Также учитывается методический принцип «не ломать стенд»: исправления должны сохранять управляемость (SSH доступ, доменное взаимодействие, "
                    "работоспособность сервисов). Это приближает задание к реальным условиям, где безопасность не должна уничтожать доступность.",
                ],
                style=styles.normal,
            )
        assess_marker2 = "При проектировании оценивания полезно учитывать уровни сложности уязвимостей и разные форматы занятий"
        if assess_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                assess_anchor,
                [
                    "При проектировании оценивания полезно учитывать уровни сложности уязвимостей и разные форматы занятий. "
                    "Например, базовые задания могут требовать исправления очевидных настроек (firewall, password policy), "
                    "а продвинутые — анализа доменных политик, сетевых протоколов и логов.",
                    "В проекте уровень уязвимости фиксируется в каталоге (low/medium/high). Это позволяет преподавателю:",
                    "- формировать задания под разный уровень группы;",
                    "- выдавать одинаковую структуру отчёта, но разную сложность наполнения;",
                    "- строить модульные занятия (сначала локальные настройки, затем доменные).",
                    "Форматы занятий также могут различаться: индивидуальная работа, работа в парах (blue team), или мини‑командные задания, "
                    "где часть студентов отвечает за аудит, часть — за исправление, часть — за документирование. "
                    "Такое разделение ролей повышает реализм и учит коммуникации, что важно для практики ИБ.",
                    "Наконец, оценивание можно усилить «контрольной проверкой»: преподаватель включает дополнительную уязвимость или меняет профиль, "
                    "и студент должен показать, что его процесс аудита работает, а не зависит от «знания ответа».",
                ],
                style=styles.normal,
            )

    # 5.10) Expand portability model (still very short)
    portability_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Модель параметризации и переносимости")
    if portability_anchor:
        portability_marker = "Переносимость достигается не «магией», а дисциплиной параметризации"
        if portability_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                portability_anchor,
                [
                    "Переносимость достигается не «магией», а дисциплиной параметризации: все значения, которые отличаются между лабораториями, "
                    "должны задаваться извне (через переменные и файлы конфигурации), а код должен оставаться неизменным. "
                    "В учебных проектах это особенно важно, потому что стенды часто разворачиваются на разных Proxmox-инсталляциях.",
                    "В проекте выделены четыре группы параметров:",
                    "1) Параметры Proxmox: URL API, node, storage, pool (если используется), network bridge. Это «платформенный» слой и он всегда индивидуален.",
                    "2) Сетевой слой: DHCP или статические адреса, шлюз, DNS. Здесь важно обеспечить два режима: быстрый (DHCP) и контролируемый (static) "
                    "для серверных ролей (DC, серверы).",
                    "3) Параметры доступа: административные учетные записи и ключи/пароли. Они должны задаваться до деплоя, но храниться вне Git. "
                    "В проекте поэтому используются `.example` и `.gitignore` для секретных файлов.",
                    "4) Учебное наполнение: профили уязвимостей и доменного присоединения. Это логический слой, который меняется чаще всего и должен быть простым для правки.",
                    "Типовые проблемы переносимости и как они закрываются:",
                    "- Разные схемы сети: решается переменной `proxmox_bridge` и переключателем DHCP/static (`use_dhcp`).",
                    "- Разные DNS/AD: решается вынесением доменных параметров в `ad.yml` и профили join (можно отключить join полностью).",
                    "- Разные требования к консоли/загрузке: решается фиксацией UEFI/OVMF, q35 и vga=std, а также наличием serial0 как запасного канала.",
                    "- Разные политики безопасности: проект не требует обязательного Ansible Vault, но допускает его. Это снижает барьер внедрения, "
                    "при этом секреты всё равно исключаются из репозитория.",
                    "Рекомендуемая практика для администратора: держать «профили» (уязвимости/учётки) в репозитории стенда, а «секреты» — локально. "
                    "Так можно открыто делиться кодом и методическими материалами, не раскрывая чувствительные данные.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Схема слоёв конфигурации (platform/network/access/training) и где они хранятся в репозитории]",
                ],
                style=styles.normal,
            )

    # 5.11) Expand repo/docs structure (still short)
    repo_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Структура репозитория и документации")
    if repo_anchor:
        repo_marker2 = "Структура репозитория должна помогать администратору, а не мешать"
        if repo_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                repo_anchor,
                [
                    "Структура репозитория должна помогать администратору, а не мешать. В учебных проектах типичная ошибка — разнести Terraform, Ansible, скрипты и шаблоны "
                    "по разным верхнеуровневым каталогам без явной связи. В результате новичку сложно понять: «что относится к какому стенду и где точка входа».",
                    "В проекте поэтому принят принцип: стенд — единица поставки. В каталоге стенда лежит всё, что нужно для развёртывания именно этого стенда: "
                    "Terraform, Ansible и скрипт `deploy.sh`. Общие части вынесены отдельно (общие роли Ansible и модули Terraform), чтобы не копировать код.",
                    "Документация разделена по назначению:",
                    "- эксплуатационные гайды для администратора (предпосылки, доступы, деплой, переносимость);",
                    "- методические материалы (сценарии занятий, каталог и сценарии уязвимостей, критерии оценки);",
                    "- технические заметки (пояснения по технологиям и проектным решениям).",
                    "Такое разделение важно, потому что аудитория документации разная: администратор хочет быстрый чек-лист, преподаватель — сценарий занятия и критерии, "
                    "а разработчик/сопровождающий — правила расширения каталога уязвимостей и структуры.",
                    "В качестве дальнейшего развития можно добавить версионирование профилей по «потокам/семестрам»: один и тот же стенд может иметь несколько наборов профилей "
                    "уязвимостей и учетных записей, что позволяет переиспользовать инфраструктуру в разных дисциплинах и на разных уровнях сложности.",
                ],
                style=styles.normal,
            )

    # 5.12) Expand vulnerability extensibility (short)
    ext_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Расширяемость каталога уязвимостей")
    if ext_anchor:
        ext_marker = "Расширение каталога уязвимостей рассматривается как разработка небольшого модуля"
        if ext_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ext_anchor,
                [
                    "Расширение каталога уязвимостей рассматривается как разработка небольшого модуля. Это сделано намеренно: уязвимость должна быть изолированной, "
                    "предсказуемой и обратимой (в учебном смысле), иначе она ломает стенд и усложняет сопровождение.",
                    "Правила добавления новой уязвимости (почему именно так):",
                    "1) Единый идентификатор (ID) по схеме `<scope>.<domain>.<name>`. Это облегчает навигацию, поиск по репозиторию и группировку в документации.",
                    "2) Идемпотентность. Роль должна применять изменение так, чтобы повторный запуск не создавал «снежный ком» из правок. "
                    "В IaC это критично: повторный прогон — нормальный режим работы.",
                    "3) Контроль влияния. Уязвимость должна изменять минимально необходимый набор настроек, а все дополнительные действия должны быть best-effort. "
                    "Это снижает риск, что уязвимость «сломает» доступ (например, отключит SSH) и сделает стенд непригодным.",
                    "4) Проверяемость. Для каждой уязвимости нужно описать простой способ проверки (команда/файл/политика), чтобы преподаватель мог быстро убедиться, "
                    "что профиль применился, а студент — собрать доказательства.",
                    "5) Документирование учебного сценария. Уязвимость ценна только тогда, когда из неё получается задание: найти → доказать → исправить → проверить. "
                    "Поэтому сценарии ведутся рядом с каталогом.",
                    "Поддержка разных дистрибутивов Linux (Debian/Ubuntu и RHEL-семейство) реализуется через условия по `ansible_os_family`. "
                    "Так одна и та же уязвимость может иметь разные реализации (разные файлы PAM, разные firewall), но единый ID и единый способ включения.",
                    "В результате каталог становится расширяемым без переписывания стенда: преподаватель может добавлять новые модули по мере обновления курса.",
                ],
                style=styles.normal,
            )

    # 5.13) Expand "Примеры реализации уязвимостей" (short, but should be explanatory, not just code)
    examples_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Примеры реализации уязвимостей")
    if examples_anchor:
        examples_marker = "В этом подразделе важно показать принцип реализации, а не перечислить весь каталог"
        if examples_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                examples_anchor,
                [
                    "В этом подразделе важно показать принцип реализации, а не перечислить весь каталог. Полный перечень уязвимостей вынесен в каталог и приложения, "
                    "а ниже приводится объяснение того, как именно «уязвимость» превращается в управляемый модуль в инфраструктуре.",
                    "Пример 1 (Linux): `linux.sudo.nopasswd`. Смысл уязвимости — показать, что компрометация обычной учётной записи может привести к root, "
                    "если администратор оставил `NOPASSWD:ALL`. В реализации Ansible создаётся отдельный файл в `/etc/sudoers.d/`, чтобы изменение было изолировано "
                    "и легко обнаруживалось при аудите. Проверка студентом: `sudo -l` и попытка выполнить команду без запроса пароля.",
                    "Пример 2 (Windows): `windows.network.llmnr_enabled`. Уязвимость демонстрирует риски локальных сетевых атак и перехвата учётных данных "
                    "при наличии LLMNR/NBNS. Реализация выполняется через изменение политик/реестра. Проверка: значения ключей политики и сетевое поведение в сегменте.",
                    "Пример 3 (AD/GPO): `ad.gpo.password_policy_weak`. Уязвимость показывает, как доменная политика паролей влияет на всех пользователей. "
                    "В реализации используется PowerShell на DC для изменения доменной password policy (best-effort). Проверка: `Get-ADDefaultDomainPasswordPolicy` "
                    "и подтверждение применения политики на клиентах.",
                    "Почему примеры именно такие: они покрывают три уровня управления — локальная ОС Linux, локальная ОС Windows и централизованное управление через AD/GPO. "
                    "Это помогает студенту увидеть, где именно живёт настройка и как она распространяется.",
                ],
                style=styles.normal,
            )

    # 5.14) Expand "Реализация уязвимостей как модулей" (still too short)
    vuln_modules_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Реализация уязвимостей как модулей")
    # Insert a missing but important section on the training scenario (adds meaningful volume, not listings).
    if vuln_modules_anchor:
        scenario_marker = "Учебный сценарий организован как управляемый поток «VPN → Proxmox → ВМ стенда»"
        if scenario_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            h = insert_paragraph_before(vuln_modules_anchor, "Проектирование учебного сценария", style=styles.h2)
            insert_block_after(
                h,
                [
                    "Учебный сценарий организован как управляемый поток «VPN → Proxmox → ВМ стенда». "
                    "Такой формат выбран, потому что он близок к реальной практике: специалисты часто работают с удалённой инфраструктурой, "
                    "включают/выключают ресурсы, подключаются по консоли или по сети и выполняют аудит/исправление конфигураций.",
                    "Роли в сценарии:",
                    "- администратор киберучений: разворачивает стенды, задаёт профили уязвимостей, выдаёт доступы и проверяет готовность;",
                    "- обучающийся: управляет только «своими» ВМ стенда (Power + Console) и выполняет задания внутри машин;",
                    "- преподаватель/проверяющий: принимает отчёт и проверяет по критериям и контрольным командам.",
                    "Модель доступа обучающегося специально ограничена. Студент получает доступ в Proxmox только к pool своего стенда. "
                    "Это позволяет ему самостоятельно включать нужные ВМ (например DC → Server → WS) и работать с ними, но исключает влияние на чужие стенды "
                    "и на инфраструктуру лаборатории.",
                    "Почему управление ВМ вынесено в Proxmox, а не в Terraform/Ansible: Terraform/Ansible — инструменты администратора, они требуют повышенных прав "
                    "и доступа к секретам (API token, SSH ключи). В учебном процессе это недопустимо выдавать студентам. "
                    "Поэтому студент взаимодействует только с «готовым» стендом, а изменения инфраструктуры выполняются централизованно.",
                    "Поток действий обучающегося (типовой):",
                    "1) подключиться к VPN лаборатории;",
                    "2) зайти в Proxmox Web UI под ограниченной учётной записью и увидеть только ВМ своего стенда;",
                    "3) включить необходимые ВМ и дождаться загрузки;",
                    "4) выполнять аудит (команды/скриншоты/конфиги) и фиксировать доказательства «до»;",
                    "5) выполнить исправления (hardening), затем повторить проверки и зафиксировать «после».",
                    "Структура заданий строится вокруг категорий уязвимостей: парольные политики, привилегии, удалённый доступ, логирование, обновления и т.д. "
                    "В доменной части задания дополняются проверкой GPO и доменных настроек (policy-level), чтобы студент понимал разницу между локальной и доменной конфигурацией.",
                    "Ожидаемые артефакты (что сдаёт студент):",
                    "- список обнаруженных проблем с привязкой к категории и риску;",
                    "- доказательства (вывод команд/скриншоты/фрагменты конфигурации) «до»;",
                    "- описание исправлений с обоснованием (почему именно так);",
                    "- доказательства «после» (повторная проверка).",
                    "Сценарий может быть адаптирован по сложности: преподаватель включает разные профили уязвимостей или меняет параметры учётных записей/домена. "
                    "Это позволяет использовать одну и ту же инфраструктуру как для базового курса (поиск и исправление очевидных ошибок), так и для продвинутого (доменные политики, "
                    "сетевые протоколы, аудит журналов и расследование).",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Схема ролей и потоков доступа (VPN, Proxmox pool, SSH/RDP, роль администратора IaC)]",
                ],
                style=styles.normal,
            )

    if vuln_modules_anchor:
        vuln_modules_marker = "Подсистема уязвимостей построена по принципу «уязвимость = отдельная задача»"
        if vuln_modules_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                vuln_modules_anchor,
                [
                    "Подсистема уязвимостей построена по принципу «уязвимость = отдельная задача». Это означает, что каждая уязвимость оформлена "
                    "как отдельный task‑файл в Ansible, который можно подключить по ID. Такой подход упрощает сопровождение: изменения в одной уязвимости "
                    "не затрагивают остальные, а преподаватель может комбинировать уязвимости в профили под разные занятия.",
                    "Структура реализации:",
                    "- `ansible/roles/vuln_linux`, `ansible/roles/vuln_windows`, `ansible/roles/vuln_ad` — роли по платформам;",
                    "- `defaults/main.yml` содержит список известных ID (`vuln_*_known`) и параметры, влияющие на реализацию (например тестовый пароль);",
                    "- `tasks/main.yml` валидирует входной список и подключает нужные уязвимости через `include_tasks` по ID;",
                    "- `tasks/vulns/<id>.yml` — конкретная реализация уязвимости.",
                    "Зачем нужен список известных ID и проверка: это защитный механизм от ошибок администратора. "
                    "Если в профиле опечатка (например `linux.ssh.passwrod_auth`), роль должна явно остановиться и сообщить об ошибке, "
                    "а не «молча» пропустить уязвимость. Это важно в обучении: иначе стенд будет отличаться от ожидаемого, и студент получит неправильный опыт.",
                    "Включение уязвимостей организовано через профили в `group_vars/all/vulnerabilities.yml`. "
                    "Playbook для конкретной ВМ подставляет нужный список ID (например `vuln_profiles.linux_server`) в переменную `vuln_enabled`. "
                    "Так достигается разделение ответственности: стенд описывает учебное наполнение, роль — механизм применения, а уязвимость — конкретное изменение.",
                    "Поддержка нескольких семейств Linux (Debian/Ubuntu и RHEL/CentOS) реализуется через условия по `ansible_os_family` внутри task‑файлов. "
                    "Это позволяет сохранить единый ID уязвимости и единый способ включения, но выполнить разные действия (разные файлы PAM, разные firewall).",
                    "Поскольку стенд учебный, часть операций выполняется best-effort (например, если конкретный пакет отсутствует или служба называется иначе). "
                    "Важно, что best-effort используется там, где ошибка не должна ломать стенд полностью; при этом проверки и сценарии всё равно фиксируются в документации.",
                ],
                style=styles.normal,
            )

    # 6) Expand Chapter 3: troubleshooting + test plan
    post_deploy_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Чек-лист администратора после деплоя")
    if post_deploy_anchor:
        tr_marker = "Ниже приведены типовые проблемы развертывания и способы их устранения"
        if tr_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                post_deploy_anchor,
                [
                    "Ниже приведены типовые проблемы развертывания и способы их устранения. Раздел включён в отчёт, так как при эксплуатации "
                    "учебных стендов важна не только «идеальная» схема, но и практические знания о диагностике в Proxmox/OS.",
                    "1) ВМ не загружается («No bootable device»): обычно причина в неправильной привязке диска/boot order или отсутствии cloud-init диска. "
                    "Решение: проверить конфигурацию дисков в Terraform (scsi0/ide2 cloudinit) и корректность boot‑порядка в Proxmox.",
                    "2) Консоль noVNC «чёрный экран»/переподключение: часто связано с режимом VGA/serial. "
                    "Решение: использовать Display `Standard VGA (std)` и, при необходимости, xterm.js (serial0), либо явно задавать `vga=std` в шаблоне/TF.",
                    "3) Нет логина/пароля в консоли Linux cloud-init: по умолчанию доступ рассчитан на SSH‑ключи. "
                    "Решение: задать пароль через cloud-init или заранее указать `cipassword`/пользователя в Terraform (для учебных целей).",
                    "4) Не определяется IP/не работает ожидание SSH: часто причина в неустановленном QEMU Guest Agent или неправильном bridge. "
                    "Решение: включить agent=1 и установить агент внутри ВМ, проверить `proxmox_bridge` и сетевые настройки (DHCP/статический IP).",
                    "5) Клиент не входит в домен: причины — DNS (клиент не использует DNS DC), неверные учётные данные join, "
                    "а также блокировки политиками/временем. Решение: проверить `ad_dc_ip`, `ad_join_user`, доступность DC и выполнить повторный прогон роли `ad_join`.",
                ],
                style=styles.normal,
            )

        tr_marker2 = "Чек-лист полезно дополнять проверками учебных требований"
        if tr_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                post_deploy_anchor,
                [
                    "Чек-лист полезно дополнять проверками учебных требований, а не только технической доступности. "
                    "Цель деплоя — подготовить стенд к занятию, поэтому нужно проверять, что сценарий действительно «проявляется» на ВМ.",
                    "Пример проверок (минимальный набор):",
                    "- доступ администратора по SSH на все ВМ;",
                    "- наличие нужных пользователей/групп (accounts профили);",
                    "- доменное присоединение клиентов (если включено) и применимость GPO;",
                    "- включение ключевых уязвимостей профиля (выборочно 3–5 уязвимостей на стенд);",
                    "- работоспособность консоли Proxmox (noVNC/xterm.js) для аварийного доступа;",
                    "- корректность прав студента в Proxmox (видит только свой pool, может только power/console).",
                    "Такая проверка снижает риск, что на занятии студент «не найдёт» уязвимость просто потому, что она не применилась. "
                    "Кроме того, чек-лист превращается в повторяемую процедуру качества, которую можно использовать в каждом семестре.",
                    "[МЕСТО ДЛЯ ТАБЛИЦЫ: Чек-лист готовности стенда (пункты/команда проверки/ожидаемый результат)]",
                ],
                style=styles.normal,
            )

        tr_marker3 = "Часть проверок готовности можно автоматизировать и превратить в регламент, чтобы ускорить подготовку стендов"
        if tr_marker3 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                post_deploy_anchor,
                [
                    "Часть проверок готовности можно автоматизировать и превратить в регламент, чтобы ускорить подготовку стендов. "
                    "Например, преподаватель может иметь набор контрольных команд (verify), которые выполняются после деплоя и дают быстрый ответ: "
                    "профиль применён или нет.",
                    "Автоматизация возможна несколькими способами:",
                    "- отдельные Ansible playbook-ы/теги для проверки (без изменения системы);",
                    "- скрипты «smoke tests» на машине администратора, которые проверяют SSH доступность и ключевые параметры;",
                    "- контрольные команды внутри стенда (например `sudo -n id` для NOPASSWD, `gpresult` для GPO).",
                    "Почему это важно: при большой группе стендов ручная проверка каждого пункта становится трудозатратной. "
                    "Автоматизация позволяет уменьшить влияние человеческого фактора и обеспечить одинаковый уровень качества подготовки занятий.",
                    "При этом важно не превращать обучение в «прогон тестов»: автоматизация нужна администратору/преподавателю для контроля готовности, "
                    "а студент выполняет аудит и исправление вручную, формируя навыки анализа.",
                ],
                style=styles.normal,
            )

    # 6.1) Expand Proxmox preparation (short section in current copy)
    prox_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Подготовка Proxmox")
    if prox_anchor:
        maintain_marker = "Сопровождение стендов в течение семестра требует управляемого процесса изменений"
        if maintain_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            h = insert_paragraph_before(
                prox_anchor,
                "Сопровождение стендов и управление изменениями",
                style=styles.h2,
            )
            insert_block_after(
                h,
                [
                    "Сопровождение стендов в течение семестра требует управляемого процесса изменений. "
                    "Даже если стенд развёрнут успешно один раз, в процессе обучения возникают типовые задачи: "
                    "поменять набор уязвимостей, выдать новую учетную запись преподавателю, изменить IP-план, "
                    "обновить шаблон или восстановить стенд после действий студентов.",
                    "В проекте изменения разделяются на классы (это упрощает сопровождение):",
                    "1) Изменения учебного сценария (профили уязвимостей). Обычно достаточно изменить `group_vars/all/vulnerabilities.yml` и повторно запустить Ansible. "
                    "Terraform трогать не требуется. Это самый частый тип изменений в курсе.",
                    "2) Изменения доступа (accounts). Меняются профили пользователей/групп в `accounts.yml`, затем повторно применяется роль `accounts`. "
                    "Так можно быстро добавить «операторскую» учетку для проверки или изменить ключи/пароли.",
                    "3) Изменения доменной логики (ad_join/ad_org). Меняются параметры `ad.yml` и профили join. Затем выполняется повторный прогон Ansible: "
                    "сначала клиенты (join), затем DC (организационные действия).",
                    "4) Инфраструктурные изменения (сеть/ресурсы/диски). Это зона Terraform. Обычно корректируются `terraform.tfvars` и выполняется `terraform apply`. "
                    "Изменения инфраструктуры следует делать осторожно в середине семестра, потому что они могут повлиять на уже выданные стенды.",
                    "5) Изменения шаблонов (templates). Это самый «дорогой» класс. Шаблон пересобирается (cloud-init/Packer), после чего стенд чаще всего "
                    "проще пересоздать заново, чем пытаться «прикрутить» изменения на существующие ВМ.",
                    "Рекомендуемый операционный процесс:",
                    "- все изменения фиксируются в Git (кроме секретов);",
                    "- для каждого занятия/группы используется стабильный профиль уязвимостей (можно вести теги/ветки);",
                    "- перед выдачей студентам выполняется чек-лист готовности;",
                    "- после занятия стенд либо откатывается (снапшот/бэкап), либо пересоздаётся конвейером.",
                    "Такой процесс делает площадку управляемой и снижает риск «накопления» ручных правок, которые сложно воспроизвести и проверить.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Диаграмма классов изменений и какие стадии pipeline затрагиваются (templates/terraform/ansible)]",
                ],
                style=styles.normal,
            )

        maintain_marker2 = "Для практического сопровождения важно ввести соглашения по именованию стендов и идентификаторам (stand-id)"
        if maintain_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            maint_heading = find_paragraph(doc, lambda p, t: t.strip() == "Сопровождение стендов и управление изменениями")
            insert_block_after(
                maint_heading or prox_anchor,
                [
                    "Для практического сопровождения важно ввести соглашения по именованию стендов и идентификаторам (`stand-id`). "
                    "Идентификатор используется в нескольких местах: в названии pool в Proxmox, в OU/группах на DC (организационная автоматизация), "
                    "а также в документации и отчётности.",
                    "Рекомендуемая практика: один стенд = один `stand-id` (например `stand-01`) и один pool `/pool/stand-01`. "
                    "Далее все ВМ стенда получают согласованное именование (например `stand-01-dc`, `stand-01-ws`, `stand-01-srv`). "
                    "Это упрощает поиск ресурсов в Proxmox и на стороне AD (объекты компьютеров).",
                    "В роли `ad_org` отдельное внимание уделяется `ad_stand_computers`: это должны быть именно COMPUTERNAME в домене, "
                    "иначе перемещение объектов и фильтрация GPO не сработают. "
                    "В отчёте рекомендуется фиксировать эти значения как часть конфигурации стенда, чтобы при пересоздании не возникало несоответствий.",
                    "Если стенд используется повторно (новая группа/новый семестр), самый надёжный вариант — пересоздать ВМ конвейером. "
                    "Это гарантирует, что «следы» студентов (изменённые политики, установленные пакеты, добавленные учётки) не перейдут на следующий поток. "
                    "Альтернатива — снапшоты/бэкапы и откат, если это поддерживается политикой лаборатории.",
                ],
                style=styles.normal,
            )

        prox_marker = "Подготовка Proxmox в учебной лаборатории отличается"
        if prox_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                prox_anchor,
                [
                    "Подготовка Proxmox в учебной лаборатории отличается от «боевой» эксплуатации тем, что администратору нужно обеспечить "
                    "масштабируемое управление (много стендов/групп), изоляцию ресурсов и удобство для обучающихся. Поэтому в проекте "
                    "закладывается не только возможность создать ВМ, но и управлять доступами через Pools/ACL.",
                    "Минимальный набор действий администратора перед первым деплоем:",
                    "1) Сеть: создать bridge (например vmbr0) и убедиться, что он подключён к нужному L2-сегменту. "
                    "Если стенды разводятся по VLAN, bridge может быть trunk, а разделение выполняется на уровне tagged интерфейсов ВМ.",
                    "2) Хранилища: подготовить storage для дисков и cloud-init (например local-lvm). Важно, чтобы storage был доступен на выбранном node "
                    "и имел достаточно места под шаблоны и клонирование стендов.",
                    "3) Пользователи и токены: создать пользователя/группу Proxmox для Terraform, выпустить API Token и выдать минимально достаточные права "
                    "(Datacenter/Node/Storage/Pool — в зависимости от модели). Это снижает риск утечки «root» доступа.",
                    "4) Pools для студентов: для каждого стенда (или группы) создать pool и добавить в него ВМ стенда. Затем выдать студенту ACL только на этот pool "
                    "с ролью, позволяющей включать/выключать ВМ и открывать консоль, но не менять конфигурацию инфраструктуры.",
                    "5) Бэкапы и снапшоты: в учебном процессе удобно иметь возможность «откатить» стенд. Поэтому рекомендуется настроить резервное копирование Proxmox "
                    "или хотя бы предусмотреть шаблоны, из которых быстро пересоздать стенд при необходимости.",
                    "Почему это важно: при массовых занятиях ключевые риски — «дрейф» конфигураций (студенты меняют настройки), случайное удаление ВМ "
                    "и неконтролируемый доступ к чужим стендам. Pool+ACL и воспроизводимый деплой минимизируют эти проблемы.",
                    "[МЕСТО ДЛЯ СКРИНШОТА: Proxmox — создание pool и назначение ACL студенту]",
                ],
                style=styles.normal,
            )
        # add more about RBAC + minimal privileges, not just concept
        prox_marker2 = "Минимальная роль студента в Proxmox должна позволять только Power/Console"
        if prox_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                prox_anchor,
                [
                    "Минимальная роль студента в Proxmox должна позволять только Power/Console, иначе обучающийся сможет менять конфигурацию ВМ "
                    "и тем самым влиять на результаты обучения (или случайно нарушить стенд).",
                    "Рекомендуемый набор привилегий на уровне pool (пример):",
                    "- VM.Audit (видеть ВМ и состояние);",
                    "- VM.Console (открывать консоль);",
                    "- VM.PowerMgmt (включить/выключить/перезагрузить);",
                    "- (опционально) VM.Monitor (просмотр метрик).",
                    "Не рекомендуется выдавать: `VM.Config.*`, `Datastore.*`, `Sys.*`, `Permissions.Modify`. "
                    "Это позволяет студенту работать со своим стендом (включить ВМ, открыть консоль), но не менять параметры CPU/RAM/дисков/сети.",
                    "Сочетание с IaC: Terraform/Ansible остаются только у администратора (API token и SSH ключи), студент в IaC не участвует. "
                    "Это повышает управляемость: стенды разворачиваются централизованно и единообразно.",
                ],
                style=styles.normal,
            )

        prox_marker3 = "Практическая процедура выдачи доступа студенту сводится к созданию pool и назначению ACL на /pool/<stand-id>"
        if prox_marker3 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                prox_anchor,
                [
                    "Практическая процедура выдачи доступа студенту сводится к созданию pool и назначению ACL на `/pool/<stand-id>`. "
                    "Это удобно тем, что администратор мыслит «стендом» как единицей обучения: добавил ВМ в pool — студент видит их; убрал — не видит.",
                    "Рекомендуемый порядок действий (через UI):",
                    "1) Datacenter → Pools → Create: создать pool для стенда (например `stand-windows-01`).",
                    "2) Добавить VMID стенда в pool (после развёртывания).",
                    "3) Datacenter → Permissions → Roles: создать роль с минимальными правами (VM.Audit, VM.Console, VM.PowerMgmt).",
                    "4) Datacenter → Permissions → Users: создать пользователя (или подключить realm LDAP/AD, если используется).",
                    "5) Datacenter → Permissions → Add → Pool permission: выдать права на `/pool/<stand-id>` с propagate.",
                    "Почему propagate важно: это гарантирует, что права распространятся на все ВМ внутри pool и не придётся назначать ACL на каждую ВМ отдельно.",
                    "Рекомендации по безопасности Proxmox в учебном процессе:",
                    "- доступ к Proxmox выдавать только через VPN;",
                    "- включить 2FA (если позволяет политика);",
                    "- включить аудит действий и хранить журналы, чтобы разбирать инциденты «студент случайно выключил ВМ/сбросил»;",
                    "- не выдавать студентам доступ к storage и конфигурации ВМ.",
                    "Такая модель доступа обеспечивает контролируемость: студент может управлять своей средой, не влияя на инфраструктуру и другие группы, "
                    "а администратор сохраняет полный контроль над IaC и секретами.",
                    "[МЕСТО ДЛЯ СКРИНШОТА: Proxmox — создание роли, назначение pool permission и видимость ВМ под студентом]",
                ],
                style=styles.normal,
            )

    # 6.2) Expand vulnerability profiles control (short section)
    prof_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Управление уязвимостями через профили")
    if prof_anchor:
        prof_marker = "Профильный подход выбран как компромисс между гибкостью"
        if prof_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                prof_anchor,
                [
                    "Профильный подход выбран как компромисс между гибкостью и управляемостью. В учебной практике часто требуется быстро менять "
                    "содержимое стенда: сегодня группа отрабатывает удалённый доступ и политики паролей, завтра — аудит логирования и обновлений. "
                    "Если включать уязвимости «вручную» на каждой ВМ, администратор тратит много времени, а результат становится плохо воспроизводимым.",
                    "В проекте профиль — это список ID уязвимостей, привязанный к роли машины в стенде (например linux_server, windows_workstation). "
                    "Так администратор мыслит категориями учебного сценария («что должен увидеть студент на этой машине»), а не низкоуровневыми настройками.",
                    "Преимущества профилей:",
                    "- воспроизводимость: один и тот же профиль даёт одинаковый результат на разных развертываниях;",
                    "- управляемость: изменения фиксируются в одном файле group_vars и легко ревьюятся;",
                    "- расширяемость: добавление новой уязвимости не требует изменения профилей по умолчанию;",
                    "- безопасность: секреты отделены от уязвимостей (уязвимость — модуль, пароль/ключ — конфигурация).",
                    "Недостатки и как они учитываются:",
                    "- риск «конфликта» уязвимостей (например одна включает сервис, другая его отключает). Поэтому в ролях принят принцип: "
                    "уязвимость изменяет минимум параметров и имеет явную проверку, а несовместимые комбинации документируются.",
                    "- необходимость контроля версий профилей. Практика: хранить профили в репозитории стенда (без секретов) и вести историю изменений, "
                    "чтобы можно было восстановить конфигурацию для конкретной группы/семестра.",
                    "Таким образом профили превращают набор уязвимостей в «учебные пакеты», а Ansible обеспечивает повторяемое применение и проверяемость.",
                ],
                style=styles.normal,
            )

    # 6.3) Expand conclusions for Chapter 1/2/3 (currently ~0-100 words)
    for title, marker, extra in [
        (
            "Выводы по главе 1",
            "В главе 1 сформирована классификация типовых уязвимостей",
            [
                "В главе 1 сформирована классификация типовых уязвимостей и ошибок администрирования, которые наиболее часто встречаются "
                "в небольших инфраструктурах и при этом пригодны для обучения. Показано, что практический эффект уязвимостей важнее привязки "
                "к конкретным CVE, так как обучение ориентировано на развитие навыков аудита и hardening, а не на поиск эксплойтов.",
                "Выбранные категории покрывают основные этапы типовой атаки: получение первичного доступа (пароли/удалённый доступ), "
                "повышение привилегий (sudo/UAC/SUID), закрепление и развитие (службы/протоколы), сокрытие следов (логирование/аудит) и "
                "масштабирование воздействия в доменной среде (AD/GPO).",
                "Результатом главы является методическая основа: для каждой категории задана логика проверки и критерии успешного исправления, "
                "что позволяет строить лабораторные занятия по единому стандарту.",
            ],
        ),
        (
            "Выводы по главе 2",
            "В главе 2 обоснована архитектура учебной площадки",
            [
                "В главе 2 обоснована архитектура учебной площадки и принятые проектные решения. Показано, что разделение на уровни "
                "(шаблоны → создание инфраструктуры → конфигурация) снижает связность и упрощает сопровождение.",
                "Сформулирована модель переносимости: сетевые и платформенные параметры вынесены в переменные, секреты отделены от кода и не коммитятся, "
                "а учебное наполнение управляется профилями. Это позволяет развернуть стенды на другом Proxmox без переписывания логики.",
                "Также задана модель методических материалов и оценки: студент работает по циклу «аудит → доказательства → исправление → проверка», "
                "а результаты проверяются по измеримым критериям.",
            ],
        ),
        (
            "Выводы по главе 3",
            "В главе 3 описана реализация учебной площадки",
            [
                "В главе 3 описана реализация учебной площадки и подтверждена работоспособность ключевых сценариев: создание ВМ из шаблонов, "
                "применение Terraform-модулей, конфигурация через Ansible и включение уязвимостей по профилям.",
                "Показано, что автоматизированный деплой снижает трудозатраты администратора и уменьшает вероятность ошибок при подготовке занятий. "
                "Отдельно отражены практические аспекты эксплуатации: диагностические шаги при проблемах загрузки/консоли/сети и чек-листы готовности.",
                "Таким образом реализованная система позволяет формировать разные учебные варианты стендов из единой базы и обеспечивать "
                "повторяемость и контроль изменений в течение семестра.",
            ],
        ),
    ]:
        a = find_paragraph(doc, lambda p, t: t.strip() == title)
        if a and marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(a, extra, style=styles.normal)

    # 6.3.1) Add extra depth to chapter conclusions (to improve flow and volume)
    ch1_concl = find_paragraph(doc, lambda p, t: t.strip() == "Выводы по главе 1")
    if ch1_concl:
        ch1_concl_marker2 = "Итог главы 1 также задаёт требования к архитектуре стендов"
        if ch1_concl_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch1_concl,
                [
                    "Итог главы 1 также задаёт требования к архитектуре стендов. Если уязвимость должна быть проверяемой и исправляемой, "
                    "то инфраструктура должна обеспечивать управляемость (SSH доступ, стабильная сеть, предсказуемая консоль), а также "
                    "возможность масштабирования (несколько стендов для разных студентов).",
                    "Практически это означает, что учебная площадка не может быть набором «ручных» машин. "
                    "Требуется конвейер развертывания и единая модель конфигурации, где уязвимости включаются декларативно и фиксируются в профилях. "
                    "Именно это является переходом от теоретического описания уязвимостей к инженерной реализации учебной среды, "
                    "что и раскрывается в главах 2 и 3.",
                ],
                style=styles.normal,
            )

    ch2_concl = find_paragraph(doc, lambda p, t: t.strip() == "Выводы по главе 2")
    if ch2_concl:
        ch2_concl_marker2 = "С точки зрения эксплуатации, ключевой результат главы 2 — это управляемая модель изменений"
        if ch2_concl_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                ch2_concl,
                [
                    "С точки зрения эксплуатации, ключевой результат главы 2 — это управляемая модель изменений. "
                    "Администратор может менять параметры площадки (bridge/IP/DNS), учебное наполнение (профили уязвимостей) и учетные записи "
                    "независимо друг от друга и без переписывания кода стенда.",
                    "Это снижает стоимость сопровождения: при обновлении курса добавляются новые уязвимости как модули, "
                    "а при переносе на другую лабораторию меняются только `tfvars` и `group_vars` файлы. "
                    "Таким образом достигается основной эффект IaC — контролируемое развитие инфраструктуры и методических материалов.",
                ],
                style=styles.normal,
            )

    # 6.4) Expand deployment sections in Chapter 3 (currently too short)
    deploy_stands = find_paragraph(doc, lambda p, t: t.strip() == "Развертывание стендов")
    if deploy_stands:
        # Add detailed implementation sections BEFORE the deployment pipeline (this adds meaningful volume in the main text).
        tf_impl_marker = "В этом подразделе описана реализация Terraform-модулей и создание ВМ в Proxmox"
        if tf_impl_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            h_tf = insert_paragraph_before(
                deploy_stands,
                "Реализация Terraform и создание виртуальных машин в Proxmox",
                style=styles.h2,
            )
            last = insert_block_after(
                h_tf,
                [
                    "В этом подразделе описана реализация Terraform-модулей и создание ВМ в Proxmox. "
                    "Terraform выбран как инструмент provisioning, потому что он хорошо описывает ресурсы и их жизненный цикл: "
                    "создание, изменение и удаление ВМ, а также контроль того, что именно изменилось между запусками.",
                    "Ключевой ресурс провайдера Proxmox — `proxmox_vm_qemu`. В нём фиксируются параметры вычислительных ресурсов (CPU/RAM), "
                    "дисковая подсистема, сетевые интерфейсы, а также настройки загрузки и интеграции (cloud-init, guest agent). "
                    "Важно, что часть параметров критична для стабильности в учебной среде.",
                    "Дисковая схема для Linux cloud-init образов обычно включает два диска: основной диск (например `scsi0`) и cloud-init диск (например `ide2`). "
                    "Если cloud-init диск не подключён, первичная настройка не применится, и ВМ будет недоступна по SSH. "
                    "Поэтому в проекте диск cloud-init задаётся явно, а порядок загрузки фиксируется через `boot`/`bootdisk`.",
                    "Сетевая часть параметризована. Для переносимости предусмотрен выбор bridge (например `vmbr0`) и два режима адресации: DHCP или статический IP. "
                    "Это позволяет переносить стенд в другую лабораторию без правки `.tf` файлов: меняются только `terraform.tfvars`.",
                    "Для Linux ВМ важным элементом является cloud-init конфигурация: `ciuser`, `sshkeys` и (опционально) `cipassword`. "
                    "Ключевой доступ (SSH key) — базовый вариант для Ansible, а пароль может быть задан для удобства входа через консоль в учебных аудитах.",
                    "Особое внимание уделено режиму загрузки и консоли. В cloud-image часто ожидается UEFI, поэтому в проекте фиксируются параметры UEFI/OVMF и q35. "
                    "Параметр `vga=std` используется для стабильной работы noVNC. Дополнительно используется `serial0`, чтобы при проблемах с отображением "
                    "можно было подключиться через xterm.js (serial console).",
                    "QEMU guest agent включается через `agent=1`. Это не замена SSH, а механизм интеграции с гипервизором: "
                    "получение IP, корректное выключение и диагностика состояния. В учебной эксплуатации это заметно ускоряет подготовку стендов.",
                    "Наконец, Terraform-модули разбиты по ролям ВМ (domain-controller, windows-10, linux-server и т.д.). "
                    "Это повышает читаемость: у каждой роли свой набор переменных, а администратор заполняет только те параметры, которые относятся к конкретной ВМ.",
                    "[МЕСТО ДЛЯ ЛИСТИНГА: Пример `terraform.tfvars` (без секретов) и объяснение ключевых переменных переноса: bridge/DHCP/DNS]",
                ],
                style=styles.normal,
            )

            h_ans = insert_paragraph_after(
                last,
                "Реализация Ansible: конфигурация, доменная интеграция и профили уязвимостей",
                style=styles.h2,
            )
            insert_block_after(
                h_ans,
                [
                    "Ansible используется как слой конфигурации (configuration management). Его задача — сделать так, чтобы после создания ВМ "
                    "они попадали в заданное состояние: нужные пользователи/группы, доменное членство (если включено), организационные действия на DC "
                    "и включение учебных уязвимостей по профилю.",
                    "Архитектура Ansible построена на ролях. Это снижает связность и упрощает переиспользование: один и тот же набор ролей применяется "
                    "в разных стендах, а конкретные параметры задаются через `group_vars`.",
                    "Роль `accounts` отвечает за пользователей и группы. Она применяется первой, потому что в учебной эксплуатации важно иметь предсказуемый "
                    "набор учётных записей для администратора/преподавателя. Это также позволяет выдавать студенту ограниченные учётки внутри стенда, "
                    "не изменяя базовые образы.",
                    "Роль `ad_join` выполняет присоединение к домену, но только если это включено в профиле `ad_join_profiles`. "
                    "Так достигается методическая гибкость: можно сравнивать локальные и доменные политики, а также строить занятия без доменных зависимостей.",
                    "Роль `ad_org` автоматизирует организационную часть: создание OU, групп, перемещение компьютерных объектов и линковку/фильтрацию GPO. "
                    "Это важно для учебной модели, где каждая группа студентов работает со своим набором машин и политик.",
                    "Роли `vuln_linux`, `vuln_windows`, `vuln_ad` применяют учебные уязвимости. Включение происходит через `vuln_profiles` — "
                    "списки ID для каждой роли ВМ. Такой подход позволяет быстро менять сценарий занятия без изменения плейбуков.",
                    "Порядок применения ролей важен: сначала учётки, затем домен (если нужен), затем уязвимости. "
                    "В Windows-стенде дополнительно важен порядок playbook-ов: DC → клиенты → DC, чтобы GPO и организационные действия применялись корректно.",
                    "Проверяемость обеспечивается тем, что для каждой уязвимости и для доменных действий описаны команды проверки. "
                    "Это позволяет преподавателю быстро убедиться в готовности стенда и снижает риск расхождения между группами.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Схема последовательности Ansible ролей (accounts → ad_join → vuln_*) и отдельный контур DC (ad_org/vuln_ad)]",
                ],
                style=styles.normal,
            )

        stand_ext_marker = "Расширение проекта новым стендом должно быть предсказуемым и не требовать переписывать существующие роли"
        if stand_ext_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            h_ext = insert_paragraph_before(
                deploy_stands,
                "Расширение проекта: добавление нового стенда и сопровождение структуры",
                style=styles.h2,
            )
            insert_block_after(
                h_ext,
                [
                    "Расширение проекта новым стендом должно быть предсказуемым и не требовать переписывать существующие роли. "
                    "Именно поэтому в репозитории принят принцип: роли Ansible и общие подходы Terraform переиспользуются, "
                    "а «стенд» задаёт только состав машин, профили и параметры платформы.",
                    "Процесс добавления нового стенда (рекомендуемая последовательность):",
                    "1) Сформулировать цель стенда и роли ВМ. Например: «стенд для аудита доменной среды и локальной политики безопасности» "
                    "или «стенд для практики сетевых протоколов и hardening». На этом шаге определяется, нужен ли DC и какие клиенты входят в домен.",
                    "2) Создать каталог `stands/<new-stand>/` и внутри — `infrastructure/terraform/`, `infrastructure/ansible/`, `infrastructure/scripts/`. "
                    "Это обеспечивает единый «вход» в стенд и упрощает обучение администраторов: структура повторяется.",
                    "3) Terraform: либо переиспользовать существующие модули, либо создать новые, если роль ВМ отличается. "
                    "В любом случае рекомендуется сохранять одинаковую модель переменных: node/storage/bridge/DHCP/static/DNS. "
                    "Это гарантирует переносимость на другой Proxmox и совместимость с существующими скриптами деплоя.",
                    "4) Ansible: для каждой роли ВМ создать playbook, который последовательно применяет `accounts` → `ad_join` (опционально) → `vuln_*`. "
                    "Затем добавить профили в `group_vars/all/` нового стенда: учётки, домен, уязвимости. "
                    "Важно, что playbook не должен содержать «жёстких» паролей и IP — всё задаётся через переменные.",
                    "5) Если стенд использует AD: определить `ad_stand_id`, `ad_stand_ou` и список `ad_stand_computers` (COMPUTERNAME), "
                    "чтобы организационная автоматизация могла корректно перемещать объекты и применять GPO только к нужной группе.",
                    "6) `deploy.sh`: добавить этапы (templates/terraform/ansible) и ожидание SSH. "
                    "Рекомендуется поддерживать флаги пропуска стадий, чтобы сопровождение было удобным (например, повторить только Ansible).",
                    "7) Документация: обновить README и каталоги сценариев/уязвимостей. "
                    "Если добавлены новые уязвимости, их нужно отразить в каталоге и сценариях, чтобы преподаватель мог использовать их в занятии.",
                    "Контроль качества при добавлении нового стенда:",
                    "- проверка переносимости (смена bridge/подсети не должна ломать деплой);",
                    "- проверка управляемости (SSH доступ, консоль, гостевой агент по возможности);",
                    "- проверка профилей (Ansible должен падать на неизвестных ID и давать понятную ошибку);",
                    "- проверка доменной части (если включена): join, OU/GPO scope, `gpresult`.",
                    "Следование этому процессу позволяет поддерживать репозиторий в «читаемом» виде и развивать проект без накопления технического долга.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Шаблон структуры нового стенда (дерево каталогов) и точки входа `deploy.sh`]",
                ],
                style=styles.normal,
            )

        deploy_marker = "Развёртывание стендов организовано как конвейер"
        if deploy_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                deploy_stands,
                [
                    "Развёртывание стендов организовано как конвейер (pipeline), потому что в IaC важно фиксировать порядок действий и точки контроля. "
                    "В противном случае администратор вынужден «догадываться», что запускать первым, и как проверить успешность шага.",
                    "Стадии конвейера:",
                    "1) Подготовка шаблонов (templates). Для Linux это cloud-init шаблон на основе cloud-image. Для Windows — шаблон через Packer. "
                    "Эта стадия выполняется редко, но критична: шаблон определяет управляемость стенда (SSH, агент, UEFI/консоль).",
                    "2) Terraform apply (provisioning). На этом шаге создаются ВМ из шаблонов, настраиваются диски, сеть, cloud-init, а также (где нужно) "
                    "включается QEMU guest agent. Результат — поднятые ВМ в нужном составе.",
                    "3) Ожидание готовности (wait-for-ssh). В учебных сетях загрузка может занимать разное время, поэтому скрипт ожидает SSH доступность, "
                    "чтобы Ansible не падал из-за «гонки» между созданием ВМ и готовностью ОС.",
                    "4) Ansible (configuration). На этом шаге применяются учетные записи/группы, доменное присоединение (если включено), организационные действия "
                    "(OU/группы/GPO) и профиль уязвимостей. Повторный запуск Ansible должен быть безопасным (идемпотентным).",
                    "Скрипты деплоя сделаны без интерактива, чтобы процесс был воспроизводим и пригоден для автоматизации (например, при подготовке стендов накануне занятия). "
                    "При необходимости отдельные стадии можно пропускать (например, повторно применить только Ansible после изменения профиля).",
                    "Почему такой подход лучше ручного: при ручном деплое неизбежны расхождения (drift) между группами и занятиями, а также сложно восстановить стенд после ошибок. "
                    "Конвейер позволяет быстро пересоздать стенд и документирует шаги в коде.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Диаграмма конвейера деплоя (templates → terraform → wait_for_ssh → ansible)]",
                ],
                style=styles.normal,
            )

        deploy_marker2 = "Практические аспекты деплоя включают логирование и повторяемость"
        if deploy_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                deploy_stands,
                [
                    "Практические аспекты деплоя включают логирование и повторяемость. В учебной лаборатории важно, чтобы при ошибке администратор мог быстро понять, "
                    "на каком шаге возникла проблема: шаблон не создался, Terraform не смог клонировать ВМ, сеть не поднялась, SSH недоступен или Ansible упал на задаче.",
                    "Рекомендуемый подход — сохранять логи выполнения (Terraform/Ansible) и фиксировать версии инструментов. "
                    "Это позволяет воспроизвести проблему и не тратить время на «угадывание» различий окружения.",
                    "Повторяемость также требует контроля состояния: Terraform state фиксирует созданные ресурсы, а Ansible обеспечивает идемпотентность конфигурации. "
                    "Именно поэтому повторный запуск не должен восприниматься как «ошибка» — наоборот, это нормальный режим сопровождения стенда.",
                    "Для подготовки к занятию полезно иметь «эталонный прогон»: администратор разворачивает стенд, выполняет чек-лист готовности, "
                    "а затем выдаёт студентам только доступ к Proxmox pool. Это отделяет этап подготовки от этапа обучения и снижает число сбоев на занятии.",
                ],
                style=styles.normal,
            )

        deploy_marker3 = "Перед первым запуском стендов важно подготовить окружение администратора и Proxmox так, чтобы pipeline был воспроизводимым"
        if deploy_marker3 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                deploy_stands,
                [
                    "Перед первым запуском стендов важно подготовить окружение администратора и Proxmox так, чтобы pipeline был воспроизводимым. "
                    "Это включает не только установку инструментов, но и проверку сетевой доступности, ключей, токенов и требований к шаблонам.",
                    "Требования к машине администратора (почему они важны):",
                    "- Terraform 1.x — создаёт/изменяет ВМ через Proxmox API и фиксирует инфраструктуру в state;",
                    "- Ansible (рекомендуется 2.15+) — применяет конфигурацию внутри ОС и профили уязвимостей;",
                    "- SSH клиент — транспорт управления для Linux и Windows (Windows управляется по SSH + PowerShell);",
                    "- Python 3 — необходим на машине администратора для Ansible и вспомогательных утилит.",
                    "Дополнительно (опционально): Packer, если администратор пересобирает Windows шаблоны. "
                    "Если шаблоны уже подготовлены, стадия Packer может не использоваться в повседневной эксплуатации.",
                    "Требования к Proxmox: доступность API, наличие node/storage/bridge и API Token с правами на создание/клонирование ВМ. "
                    "Практическая рекомендация — выдавать токену минимальные права, чтобы снизить риск при утечке.",
                    "Сеть/VPN: машина администратора должна иметь L3-доступ к IP ВМ (как минимум SSH на 22). "
                    "Для домена критично, чтобы клиенты видели DC по сети, а DNS клиентов указывал на DC (иначе domain join и GPO работать не будут).",
                    "Шаблоны ВМ: для Linux требуется cloud-init шаблон и доступ по SSH (ключ/пароль). Для Windows требуется OpenSSH Server и пользователь для Ansible. "
                    "Для DC в текущей версии проекта предполагается «готовый» контроллер домена (AD DS + DNS), а Ansible применяет уязвимости/орг.настройки поверх.",
                    "Параметры и секреты: `terraform.tfvars` и `group_vars/all/*.yml` заполняются на основе `.example`. "
                    "Секреты (токен Proxmox, пароли join, пароли админа) не должны попадать в Git; это обеспечивается `.gitignore` и организационными правилами.",
                    "Такая подготовка снижает количество «случайных» сбоев. В результате администратор тратит время на содержание сценариев, "
                    "а не на разовые проблемы окружения.",
                    "[МЕСТО ДЛЯ СКРИНШОТА: Пример заполненных файлов `terraform.tfvars` и `group_vars` (без секретов)]",
                ],
                style=styles.normal,
            )

    deploy_one = find_paragraph(doc, lambda p, t: t.strip() == "Развертывание стенда")
    if deploy_one:
        deploy_one_marker = "На практике развёртывание одного стенда удобно описывать как последовательность команд"
        if deploy_one_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                deploy_one,
                [
                    "На практике развёртывание одного стенда удобно описывать как последовательность команд и ожидаемых результатов. "
                    "Это снижает количество ошибок администраторов, которые впервые используют проект.",
                    "Рекомендуемый порядок (общий):",
                    "- заполнить `terraform.tfvars` для каждой ВМ стенда на основе `terraform.tfvars.example` (node/storage/bridge/IP);",
                    "- заполнить `group_vars/all/*.yml` (accounts, vulnerabilities, ad) на основе `.example` файлов;",
                    "- убедиться, что секреты не попали в Git (проверить `.gitignore` и локальные файлы);",
                    "- запустить `deploy.sh` из каталога стенда и дождаться завершения стадий;",
                    "- выполнить чек-лист после деплоя (SSH, домен, GPO, уязвимости).",
                    "Отдельное внимание уделяется Windows-стенду: Domain Controller должен быть настроен первым, затем клиенты присоединяются к домену, "
                    "после чего на DC выполняются организационные действия (OU/GPO scope) и на клиентах применяется `gpupdate /force`. "
                    "Так обеспечивается корректная применимость доменных политик в учебном сценарии.",
                    "Результатом успешного деплоя является не просто наличие ВМ, а готовность к занятию: студенты могут включать свои машины, "
                    "преподаватель может проверить профиль уязвимостей, а доменные сценарии работают предсказуемо.",
                ],
                style=styles.normal,
            )
        deploy_one_marker2 = "Практика эксплуатации показала, что полезно фиксировать параметры запуска и типовые флаги"
        if deploy_one_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                deploy_one,
                [
                    "Практика эксплуатации показала, что полезно фиксировать параметры запуска и типовые флаги деплоя. "
                    "Это связано с тем, что администратор часто выполняет развёртывание накануне занятия и времени на ручную отладку мало.",
                    "В скриптах деплоя предпочтительно использовать неинтерактивный режим Terraform (`-auto-approve`, `-input=false`), "
                    "чтобы исключить зависимость от ручного ввода и обеспечить повторяемость. "
                    "Если требуется планирование изменений, можно выполнять `terraform plan` отдельно как контрольный этап.",
                    "Ожидание SSH после `terraform apply` не является «косметикой»: cloud-init и загрузка Windows могут занимать разное время, "
                    "а попытка запустить Ansible слишком рано приводит к ложным ошибкам. Поэтому `wait_for_ssh` — обязательная часть pipeline.",
                    "Для удобства сопровождения предусмотрены флаги пропуска стадий (`--skip-templates`, `--skip-terraform`, `--skip-ansible`). "
                    "Это позволяет, например, поменять только профиль уязвимостей и повторно применить Ansible без пересоздания ВМ.",
                    "Ещё один практический момент — определение IP адресов для Ansible. В проекте допускается задавать IP через переменные окружения, "
                    "чтобы не «зашивать» адреса в код и упростить перенос на другую сеть. "
                    "В сочетании с QEMU guest agent это позволяет администратору быстрее диагностировать проблемы с сетевой доступностью.",
                ],
                style=styles.normal,
            )

    # 6.6) Expand conclusion (currently extremely short)
    concl_anchor = find_paragraph(doc, lambda p, t: t.strip() == "ЗАКЛЮЧЕНИЕ")
    if concl_anchor:
        concl_marker = "В ходе работы достигнута цель разработки учебной площадки"
        if concl_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                concl_anchor,
                [
                    "В ходе работы достигнута цель разработки учебной площадки киберучений по защите операционных систем на базе Proxmox VE с использованием IaC. "
                    "Площадка реализует два стенда (Windows и Linux), включает доменную инфраструктуру Active Directory и предоставляет механизм включения "
                    "типовых уязвимостей/ошибок администрирования по профилям.",
                    "Результаты работы можно сформулировать следующим образом:",
                    "1) Определены и классифицированы типовые уязвимости и конфигурационные ошибки, характерные для небольших организаций. "
                    "Категории ориентированы на практическое обучение аудиту и hardening.",
                    "2) Спроектирована архитектура учебной площадки, разделяющая ответственность между шаблонами ВМ, Terraform и Ansible. "
                    "Это повышает воспроизводимость, упрощает сопровождение и снижает вероятность дрейфа конфигураций.",
                    "3) Реализовано автоматизированное развёртывание: стенды поднимаются по конвейеру (templates → terraform → ansible) и могут переноситься "
                    "между разными Proxmox/сетевыми схемами за счёт параметризации и разделения конфигурации и секретов.",
                    "4) Подготовлен каталог уязвимостей и методические материалы: сценарий занятия, правила расширения каталога, инструкции администратора и чек-листы готовности.",
                    "Ограничения текущей версии связаны в основном с зависимостью от подготовленных шаблонов (особенно Windows) и с тем, что некоторые уязвимости "
                    "реализуются best-effort из-за различий дистрибутивов и политик. Тем не менее архитектура проекта позволяет развивать каталог и сценарии без "
                    "изменения базового пайплайна развёртывания.",
                    "Направления дальнейшего развития:",
                    "- добавить больше профилей уязвимостей по уровням сложности (базовый/средний/продвинутый);",
                    "- расширить доменные сценарии (GPO фильтрация, моделирование делегирования прав, сценарии lateral movement);",
                    "- автоматизировать часть проверки результатов (скрипты проверки «до/после»), чтобы ускорить оценивание лабораторных работ;",
                    "- интегрировать централизованное логирование/мониторинг как отдельный учебный модуль.",
                    "В целом реализованная площадка обеспечивает базу для практических занятий по защите ОС и может использоваться как основа "
                    "для расширения курса и проведения киберучений в условиях учебной лаборатории.",
                ],
                style=styles.normal,
            )
        concl_marker2 = "Практическая апробация показала, что основные риски связаны не с IaC как таковым, а с качеством шаблонов и сетевой связностью"
        if concl_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                concl_anchor,
                [
                    "Практическая апробация показала, что основные риски связаны не с IaC как таковым, а с качеством шаблонов и сетевой связностью. "
                    "Если шаблон ВМ не обеспечивает управляемость (SSH/агент/правильный режим загрузки), то дальнейшая автоматизация становится хрупкой: "
                    "Terraform создаёт ВМ, но Ansible не может к ним подключиться, а преподаватель тратит время на ручную отладку.",
                    "Поэтому в проекте особое внимание уделено базовым параметрам шаблонов: UEFI/OVMF и q35 для cloud-images, "
                    "включение `vga=std` для стабильной консоли и `serial0` как альтернативного канала, включение QEMU guest agent. "
                    "Эти решения напрямую возникли из практического опыта развёртывания стендов и направлены на повышение устойчивости.",
                    "Также важен сетевой слой: доменная среда чувствительна к DNS и времени. "
                    "Даже корректно развёрнутый DC не позволит присоединить клиентов, если они используют внешний DNS или имеют сильный рассинхрон времени. "
                    "В отчёте поэтому выделены рекомендации по изоляции сегментов и настройке DNS через роль `ad_join`.",
                    "Показательная проверка результата — возможность включить уязвимость профилем и подтвердить её проявление проверочной командой. "
                    "Например, `linux.sudo.nopasswd` проверяется через `sudo -n id`, доменные политики — через `gpresult /r` и `Get-ADDefaultDomainPasswordPolicy`. "
                    "Наличие таких проверок делает учебную площадку управляемой и снижает риск «непонятных» расхождений между группами.",
                    "В результате проект решает не только задачу создания «лабораторных машин», но и задачу управляемого учебного процесса: "
                    "стенды можно быстро пересоздавать, менять сценарии через профили, выдавать студентам безопасный доступ к Proxmox и проверять готовность по регламенту.",
                ],
                style=styles.normal,
            )
        concl_marker3 = "Практическая значимость проекта состоит в снижении порога для проведения киберучений в учебной лаборатории"
        if concl_marker3 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                concl_anchor,
                [
                    "Практическая значимость проекта состоит в снижении порога для проведения киберучений в учебной лаборатории. "
                    "Администратор получает воспроизводимый конвейер и набор методических материалов, а преподаватель — управляемый механизм "
                    "формирования заданий через профили уязвимостей.",
                    "Для образовательного процесса это важно по нескольким причинам. Во‑первых, уменьшается время подготовки занятий: "
                    "если раньше стенды могли собираться вручную, то теперь они пересоздаются автоматизированно и одинаково для разных групп. "
                    "Во‑вторых, повышается качество проверок: наличие критериев и verify‑команд снижает субъективность и облегчает контроль результата.",
                    "Проект также решает организационную проблему доступа студентов. "
                    "Ограниченный доступ к Proxmox по pool позволяет студентам самостоятельно включать свои машины, "
                    "не влияя на чужие стенды и не получая доступ к секретам IaC. "
                    "Таким образом соблюдается принцип разделения ролей и минимально достаточных привилегий.",
                    "В инженерном смысле проект демонстрирует подход к построению «конфигурационных уязвимостей как модулей». "
                    "Это позволяет развивать каталог по мере обновления курса: добавлять новые уязвимости и сценарии без изменения базового механизма развёртывания. "
                    "Такая архитектура поддерживает долгосрочное сопровождение и снижает технический долг.",
                    "Потенциал масштабирования: структура стендов и профили позволяют создавать несколько вариантов практикума "
                    "(например, базовый для начального курса и расширенный для продвинутого) и использовать одну и ту же платформу в разных дисциплинах "
                    "(защита ОС, основы AD, аудит и hardening, сетевые протоколы).",
                    "Таким образом, полученный результат представляет собой полноценную основу для проведения практических занятий и киберучений "
                    "по тематике безопасности операционных систем и доменной среды в условиях учебной лаборатории.",
                ],
                style=styles.normal,
            )

    cfg_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Файлы конфигурации")
    if cfg_anchor:
        cfg_marker = "Конфигурация стенда разделена на несколько слоёв"
        if cfg_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                cfg_anchor,
                [
                    "Конфигурация стенда разделена на несколько слоёв, чтобы разные типы изменений не мешали друг другу:",
                    "1) Параметры площадки (Proxmox/сеть) — переменные Terraform (`terraform.tfvars`): URL API, node, storage, bridge, IP-план. "
                    "Эти значения зависят от конкретной лаборатории и обычно меняются при переносе на другой Proxmox.",
                    "2) Учётные записи и доступ — Ansible `accounts.yml`: список групп и пользователей, где можно задать административные права и ключи. "
                    "Так преподаватель/администратор заранее имеет доступ для проверки стенда.",
                    "3) Доменные параметры — Ansible `ad.yml`: имя домена, IP DC, учётка для join, а также профили, определяющие, какие машины входят в домен. "
                    "Это позволяет включать доменные сценарии без изменения плейбуков.",
                    "4) Учебное наполнение — `vulnerabilities.yml`: профили уязвимостей по ролям машин. Изменяя этот файл, администратор меняет «сюжет» занятия.",
                    "Секреты (пароли, токены) принципиально не коммитятся. В проекте для этого расширен `.gitignore`, а рядом с файлами размещены `.example` шаблоны. "
                    "Такой подход проще для внедрения в лаборатории, где не всегда готова инфраструктура Ansible Vault, но при необходимости Vault можно добавить.",
                    "Рекомендуемый процесс изменений: сначала правится конфигурация, затем выполняется повторный прогон только нужной стадии (например, только Ansible) "
                    "и проводится контрольная проверка. Это дисциплинирует сопровождение и упрощает поиск причин при ошибках.",
                ],
                style=styles.normal,
            )

        cfg_marker2 = "Рекомендуется разделять конфигурацию на «публичную» и «секретную» части"
        if cfg_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                cfg_anchor,
                [
                    "Рекомендуется разделять конфигурацию на «публичную» и «секретную» части. "
                    "Публичная часть (структура стенда, профили уязвимостей, сценарии занятий) может храниться в Git и ревьюиться. "
                    "Секретная часть (API token, пароли, приватные ключи) хранится локально или в защищённом хранилище организации.",
                    "В проекте для этого предусмотрены файлы-примеры (`*.example`) и расширенный `.gitignore`. "
                    "Это не только защита от утечки секретов, но и удобство: новый администратор видит, какие параметры нужно заполнить, "
                    "не читая весь код Terraform/Ansible.",
                    "Для крупных внедрений рекомендуется централизовать секреты (например, Ansible Vault или внешний секрет-хранилище), "
                    "но в учебной лаборатории часто достаточно локального хранения при строгом контроле доступа к машине администратора.",
                    "[МЕСТО ДЛЯ СХЕМЫ/РИСУНКА: Поток секретов — где хранится токен Proxmox, где ключи SSH, и кто имеет доступ]",
                ],
                style=styles.normal,
            )

    tmpl_vm_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Подготовка шаблонов ВМ")
    if tmpl_vm_anchor:
        tmpl_vm_marker = "Подготовка шаблонов ВМ — самая «тяжёлая» часть жизненного цикла"
        if tmpl_vm_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                tmpl_vm_anchor,
                [
                    "Подготовка шаблонов ВМ — самая «тяжёлая» часть жизненного цикла, но она выполняется редко и окупается при масштабировании. "
                    "Если шаблон подготовлен корректно, создание стенда сводится к клонированию и пост-настройке, что критично для учебных занятий.",
                    "Linux cloud-init шаблон в проекте строится на cloud-image (qcow2). Это даёт преимущества:",
                    "- минимальное время установки (нет интерактивной инсталляции из ISO);",
                    "- единая базовая конфигурация для всех стендов;",
                    "- декларативная первичная настройка (пользователь/ключи/сеть).",
                    "Ключевые практические параметры шаблона (почему они фиксируются):",
                    "- UEFI/OVMF + q35: совместимость с современными образами и предсказуемость загрузки;",
                    "- vga=std: стабильная работа noVNC-консоли (иначе возможен «чёрный экран»);",
                    "- serial0: возможность использовать xterm.js консоль как альтернативу noVNC при проблемах отображения;",
                    "- sshd включён: Ansible требует управляемости по SSH;",
                    "- (по возможности) qemu-guest-agent: удобство диагностики и получения IP.",
                    "Windows шаблоны через Packer используются для стандартизации: один раз «правильно» собранный образ затем клонируется многократно. "
                    "Это особенно важно для Windows, где ручная установка и доведение до управляемого состояния (SSH, драйверы, обновления, политики) занимает много времени.",
                    "В методическом смысле шаблон должен быть «нейтральным»: он обеспечивает управляемость и базовую работоспособность, а учебные уязвимости "
                    "включаются позже через Ansible по профилю. Это упрощает обновление сценариев без пересборки образов.",
                    "[МЕСТО ДЛЯ СКРИНШОТА: Proxmox — параметры шаблона (UEFI/Display/QEMU agent) и пример клонирования]",
                ],
                style=styles.normal,
            )

        tmpl_vm_marker2 = "Отдельный практический момент — драйверы VirtIO и гостевые инструменты"
        if tmpl_vm_marker2 not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                tmpl_vm_anchor,
                [
                    "Отдельный практический момент — драйверы VirtIO и гостевые инструменты. "
                    "Для Windows-шаблонов при использовании virtio устройств (сеть/disk) обычно требуется установка драйверов. "
                    "Если драйверы не установлены, возможны проблемы с производительностью или недоступностью диска/сети после клонирования.",
                    "Также рекомендуется установить/включить гостевой агент (в Windows это может быть пакет virtio-tools, в Linux — qemu-guest-agent). "
                    "Хотя Ansible управляет по SSH, гостевой агент улучшает интеграцию с Proxmox (IP, корректное выключение, диагностика).",
                    "Ещё одна важная настройка — синхронизация времени. В доменной среде рассинхронизация времени может привести к проблемам Kerberos "
                    "и ошибкам присоединения к домену. Поэтому в шаблонах и на хостах нужно обеспечить корректную настройку времени (NTP/службы времени).",
                    "Наконец, шаблон должен быть «чистым»: без учебных уязвимостей и без специфичных профилей. "
                    "Это позволяет пересобирать сценарии через Ansible профили без пересоздания образов и делает сопровождение существенно проще.",
                ],
                style=styles.normal,
            )

    # 6.5) Expand step-by-step Linux deployment (still short)
    linux_step_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Пошаговое развертывание Linux-стенда")
    if linux_step_anchor:
        linux_step_marker = "Пошаговое развертывание Linux-стенда полезно описывать как чек-лист действий"
        if linux_step_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                linux_step_anchor,
                [
                    "Пошаговое развертывание Linux-стенда полезно описывать как чек-лист действий, потому что в учебной лаборатории развёртывание часто выполняют "
                    "разные люди (администратор, преподаватель, лаборант). Чек-лист снижает зависимость от «личного опыта» конкретного человека.",
                    "Шаг 1. Подготовить Linux cloud-init шаблон в Proxmox: убедиться, что загрузка настроена на UEFI/OVMF, присутствует cloud-init диск, "
                    "Display установлен в `std`, а SSH включён. После создания шаблона рекомендуется выполнить быстрый тест: клонировать ВМ, получить IP и зайти по SSH.",
                    "Шаг 2. Заполнить `terraform.tfvars` для Linux Server и Linux WS. Важно задать bridge и режим сети (DHCP или static), а также пользователя/ключи. "
                    "Если используется статическая адресация, заранее проверить, что адреса не конфликтуют с DHCP пулом.",
                    "Шаг 3. Выполнить `terraform apply` в каталогах модулей Linux стенда. После создания ВМ убедиться, что cloud-init применился: есть нужный пользователь, "
                    "SSH ключ установлен, сеть поднялась.",
                    "Шаг 4. Подготовить Ansible конфигурацию: задать профили учетных записей, уязвимостей и (при необходимости) доменного присоединения. "
                    "Затем запустить плейбуки. При проблемах с доступом — проверить SSH, DNS и сетевые правила.",
                    "Шаг 5. Контрольная проверка: убедиться, что включены именно те уязвимости, что указаны в профиле. "
                    "Это можно сделать через команды аудита (sudo -l, sshd -T, systemctl status, проверка firewall/логов).",
                    "Шаг 6. Подготовка к занятию: назначить студенту доступ в Proxmox только на его pool, подготовить методические указания и критерии оценки.",
                    "Отдельно рекомендуется вести журнал изменений профилей: если в середине семестра меняется набор уязвимостей, это должно быть задокументировано, "
                    "чтобы результаты разных групп были сопоставимы.",
                ],
                style=styles.normal,
            )

    # 6.5.1) Expand step-by-step Windows deployment (usually needs more detail)
    windows_step_anchor = find_paragraph(doc, lambda p, t: t.strip() == "Пошаговое развертывание Windows-стенда")
    if windows_step_anchor:
        win_step_marker = "Windows-стенд сложнее Linux-стенда из-за доменной зависимости и порядка применения политик"
        if win_step_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                windows_step_anchor,
                [
                    "Windows-стенд сложнее Linux-стенда из-за доменной зависимости и порядка применения политик. "
                    "Если в Linux большинство настроек локальные, то в Windows значительная часть поведения определяется доменом и GPO, "
                    "а значит важен порядок: сначала DC, затем клиенты, затем снова DC (организационные действия и политики), затем обновление политик на клиентах.",
                    "Шаг 1. Убедиться в готовности Windows шаблонов (Packer). В шаблоне должны быть: включён OpenSSH Server, создан пользователь для Ansible, "
                    "и (рекомендуется) установлены гостевые инструменты/virtio-tools. "
                    "Если используется bootstrap-пароль для смены кредов, он должен быть известен администратору и храниться вне Git.",
                    "Шаг 2. Заполнить `terraform.tfvars` для `domain-controller`, `windows-server`, `windows-10`. "
                    "Критичные параметры: bridge, IP-план, параметры доступа (admin_user / bootstrap_admin_password / admin_password или SSH ключ).",
                    "Шаг 3. Выполнить Terraform apply. После создания ВМ проверить: сеть поднялась, SSH доступен на всех ВМ, "
                    "а на DC включён агент (если используется) и корректно установлены службы AD DS (в зависимости от того, как подготовлен шаблон).",
                    "Шаг 4. Запустить Ansible в правильном порядке:",
                    "- сначала playbook DC (подготовка AD/GPO/базовые доменные настройки);",
                    "- затем playbook клиентов (windows-10 и windows-server), где выполняется join (если включён) и локальные уязвимости;",
                    "- затем снова playbook DC для организационной автоматизации (OU/группы/GPO scope) после появления компьютерных объектов клиентов в домене.",
                    "Шаг 5. Применить политики на клиентах. В доменной среде изменения могут применяться с задержкой, поэтому в учебной лаборатории целесообразно "
                    "выполнить `gpupdate /force` и затем проверить `gpresult /r`, чтобы убедиться, что нужные GPO действительно действуют.",
                    "Шаг 6. Контрольная проверка сценария. Для DC: проверить доменную password policy, состав Domain Admins, наличие и линковку GPO. "
                    "Для клиентов: проверить, что политика влияет на настройки (LLMNR/SMB signing/firewall/Defender), и что локальные уязвимости включены по профилю.",
                    "Шаг 7. Подготовка студенческого доступа. Студенту выдаётся доступ в Proxmox на уровне pool (только его стенд), "
                    "после чего он сам включает нужные ВМ по заданию. Это разделяет ответственность: инфраструктуру готовит администратор, "
                    "а исследование/исправление выполняет студент внутри стенда.",
                    "Типовые проблемы и диагностика:",
                    "- Join не проходит: чаще всего ошибка в DNS (клиент смотрит не на DC). Проверить DNS на интерфейсе и достижимость DC;",
                    "- GPO не применяются: проверить OU, scope (security filtering) и выполнить `gpresult /r`;",
                    "- SSH недоступен на Windows: проверить, что OpenSSH Server включён и firewall не блокирует порт 22 (особенно если включены уязвимости firewall).",
                    "[МЕСТО ДЛЯ СКРИНШОТА: Проверка доменного членства и применённых GPO (System Properties / gpresult)]",
                ],
                style=styles.normal,
            )

    acc_anchor = find_paragraph(doc, lambda p, t: t.strip().startswith("Точки контроля"))
    if acc_anchor:
        acc_marker = "План тестирования рекомендуется разделять на функциональные и эксплуатационные проверки"
        if acc_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
            insert_block_after(
                acc_anchor,
                [
                    "План тестирования рекомендуется разделять на функциональные и эксплуатационные проверки, так как стенд является одновременно "
                    "программным продуктом (инфраструктура как код) и учебным инструментом (методическая среда).",
                    "Функциональные проверки (пример):",
                    "- развёртывание с нуля проходит без ручного вмешательства (`deploy.sh`),",
                    "- ВМ создаются с корректными дисками/сетью и доступны по SSH,",
                    "- профили учётных записей применяются (созданы пользователи/группы),",
                    "- доменное присоединение срабатывает там, где включено, и не выполняется там, где выключено,",
                    "- уязвимости включаются ровно по спискам профилей.",
                    "Эксплуатационные проверки (пример):",
                    "- повторный запуск Ansible идемпотентен (изменений минимум, дрейф не накапливается),",
                    "- можно безопасно обновить профиль уязвимостей и повторно применить конфигурацию,",
                    "- журналирование/лог выполнения (Ansible/Terraform) позволяет диагностировать проблемы.",
                    "Для контроля качества обучения вводится шкала оценивания: "
                    "часть баллов — за нахождение и доказательство уязвимостей, часть — за корректность исправлений, "
                    "часть — за качество документации (структурность, аргументация, повторяемость проверки).",
                ],
                style=styles.normal,
            )

    # 7) Expand sources list (insert before Appendix A if present)
    appendix_a = find_paragraph(doc, lambda p, t: t.strip().startswith("ПРИЛОЖЕНИЕ А"))
    sources_anchor = find_paragraph(doc, lambda p, t: t.strip().upper() == "СПИСОК ИСПОЛЬЗОВАННЫХ ИСТОЧНИКОВ")
    sources_marker = "Verizon. Data Breach Investigations Report"
    if appendix_a and sources_anchor and sources_marker not in "\n".join(pp.text or "" for pp in doc.paragraphs):
        extra_sources = [
            "HashiCorp. Packer Documentation [Электронный ресурс]. — URL: https://developer.hashicorp.com/packer/docs",
            "cloud-init documentation [Электронный ресурс]. — URL: https://cloudinit.readthedocs.io/",
            "MITRE. ATT&CK® Framework [Электронный ресурс]. — URL: https://attack.mitre.org/",
            "Center for Internet Security. CIS Benchmarks [Электронный ресурс]. — URL: https://www.cisecurity.org/cis-benchmarks",
            "NIST. SP 800‑53: Security and Privacy Controls [Электронный ресурс]. — URL: https://csrc.nist.gov/publications/",
            "Verizon. Data Breach Investigations Report (DBIR) [Электронный ресурс]. — URL: https://www.verizon.com/business/resources/reports/dbir/",
            "Microsoft. Digital Defense Report [Электронный ресурс]. — URL: https://www.microsoft.com/security/business/security-intelligence-reports/",
        ]
        insert_paragraph_before(appendix_a, "", style=styles.normal)
        insert_block_before(appendix_a, extra_sources, style=styles.normal)

    # 8) Add Appendix B: vulnerability catalog table (at end)
    appendix_b_exists = any((p.text or "").strip().startswith("ПРИЛОЖЕНИЕ B") for p in doc.paragraphs)
    if not appendix_b_exists:
        doc.add_page_break()
        doc.add_paragraph(
            "ПРИЛОЖЕНИЕ B\nКаталог типовых уязвимостей (сводная таблица)",
            style=styles.appendix,
        )
        doc.add_paragraph(
            "В приложении приведён сводный каталог реализованных уязвимостей. "
            "ID используется для включения уязвимости в профиле стенда, категория и уровень — для навигации и планирования занятий.",
            style=styles.normal,
        )
        doc.add_paragraph(
            "Источник данных: `docs/guides/VULNERABILITY_CATALOG.md` (репозиторий проекта).",
            style=styles.normal,
        )

        catalog_md = read_text("docs/guides/VULNERABILITY_CATALOG.md")
        catalog = parse_catalog_table(catalog_md)

        def by_prefix(prefix: str) -> list[str]:
            return sorted([k for k in catalog.keys() if k.startswith(prefix)])

        groups = [
            ("Linux", by_prefix("linux.")),
            ("Windows", by_prefix("windows.")),
            ("Active Directory / GPO", by_prefix("ad.")),
        ]

        for title, ids in groups:
            doc.add_paragraph(title, style=styles.h3)
            if not ids:
                doc.add_paragraph("[В каталоге нет записей для данного раздела.]", style=styles.normal)
                continue
            table = doc.add_table(rows=1, cols=5)
            hdr = table.rows[0].cells
            hdr[0].text = "ID"
            hdr[1].text = "Категория"
            hdr[2].text = "Уровень"
            hdr[3].text = "Что делает"
            hdr[4].text = "Как проверить"
            for vid in ids:
                row = table.add_row().cells
                row[0].text = vid
                row[1].text = catalog[vid]["category"]
                row[2].text = catalog[vid]["level"]
                row[3].text = catalog[vid]["what"]
                row[4].text = catalog[vid]["verify"]

            ensure_spacing(doc)

    # 8.1) Add Appendix C: short training scenarios (at end)
    # If Appendix C already exists (older runs could add big tables), rewrite it to a small, illustrative appendix.
    appendix_c_anchor = find_paragraph(doc, lambda p, t: t.strip().startswith("ПРИЛОЖЕНИЕ C"))
    removed_c = False
    if appendix_c_anchor:
        try:
            body = doc._element.body  # python-docx internal XML
            children = list(body.iterchildren())
            idx = children.index(appendix_c_anchor._p)
            for child in children[idx:]:
                body.remove(child)
            removed_c = True
        except Exception:
            # best-effort: if we cannot surgically remove, we keep the existing appendix
            removed_c = False

    appendix_c_exists = bool(appendix_c_anchor) and not removed_c
    if not appendix_c_exists:
        doc.add_page_break()
        doc.add_paragraph(
            "ПРИЛОЖЕНИЕ C\nПримеры учебных карточек (3 примера)",
            style=styles.appendix,
        )
        doc.add_paragraph(
            "Примечание: полный набор сценариев поддерживается в репозитории в `docs/guides/VULNERABILITY_SCENARIOS.md`. "
            "В отчёте приведены только несколько примеров, чтобы показать формат методических карточек, не перегружая основной текст.",
            style=styles.normal,
        )

        scen_md = read_text("docs/guides/VULNERABILITY_SCENARIOS.md")
        scen = parse_scenarios(scen_md)

        examples = [
            "linux.sudo.nopasswd",
            "windows.network.llmnr_enabled",
            "ad.gpo.password_policy_weak",
        ]

        def compact(text: str, max_lines: int) -> str:
            lines = [ln.strip() for ln in (text or "").splitlines() if ln.strip()]
            out = []
            for ln in lines:
                ln = ln.lstrip("- ").strip()
                out.append(ln)
                if len(out) >= max_lines:
                    break
            return "\n".join(out)

        for vid in examples:
            doc.add_paragraph(f"Карточка: {vid}", style=styles.h3)
            s = scen.get(vid, {})
            doc.add_paragraph("Учебный сценарий (кратко):", style=styles.normal)
            doc.add_paragraph(compact(s.get("scenario", ""), 10) or "[нет данных]", style=styles.normal)
            doc.add_paragraph("Проверка (кратко):", style=styles.normal)
            doc.add_paragraph(compact(s.get("verify", ""), 8) or "[нет данных]", style=styles.normal)
            ensure_spacing(doc)

    # 9) Save (handle file locks)
    try:
        doc.save(target_path)
        out_path = target_path
    except PermissionError:
        out_path = target_path.with_name(f"{target_path.stem}__expanded{target_path.suffix}")
        doc.save(out_path)

    print(f"OK: saved -> {out_path}")


if __name__ == "__main__":
    main()

