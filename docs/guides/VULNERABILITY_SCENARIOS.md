## Сценарии уязвимостей (что включаем и как обучаем)

Документ дополняет:
- `docs/guides/VULNERABILITY_CATALOG.md` (что делает/как проверить),
- `docs/guides/TRAINING_SCENARIO.md` (общий сценарий занятия).

Здесь для каждой уязвимости описано:
- **как включить** (ID в `vuln_profiles`),
- **что делает Ansible** (по факту реализации в `ansible/roles/vuln_*`),
- **учебный сценарий**: что студент должен найти/доказать/исправить,
- **проверка до/после**.

### Где включать/выключать

- Linux: `stands/linux-stand/infrastructure/ansible/group_vars/all/vulnerabilities.yml`
- Windows: `stands/windows-stand/infrastructure/ansible/group_vars/all/vulnerabilities.yml`

Включение — добавлением ID в список группы, например:

```yaml
vuln_profiles:
  linux_server:
    - linux.ssh.password_auth
    - linux.sudo.nopasswd
```

---

## Linux (роль `vuln_linux`)

### `linux.auth.lockout_disabled`
- **Что делает**: отключает/ослабляет блокировку при переборе (останавливает fail2ban, убирает pam_faillock/pam_tally2 best-effort).
- **Учебный сценарий**:
  - обнаружить отсутствие lockout/ban механизма,
  - описать риск brute-force,
  - исправить: включить `pam_faillock` (RHEL) или настроить fail2ban, задокументировать параметры (deny/unlock_time).
- **Проверка**:
  - `systemctl status fail2ban`,
  - поиск `pam_faillock`/`pam_tally2` в `/etc/pam.d/*`.

### `linux.auth.weak_root_password`
- **Что делает**: ставит слабый пароль для `root`.
- **Как включить**: добавьте в `vuln_profiles.<linux_*>`.
- **Учебный сценарий**:
  - найти, что у `root` установлен слабый пароль (политика/факты),
  - доказать риск (показать возможность входа/подбора в изолированной среде),
  - исправить: запретить `root` логин по SSH + сильный пароль/disable password login.
- **Проверка до/после**:
  - до: (опционально) вход `root` в консоли/SSH (если разрешено другими уязвимостями),
  - после: `PermitRootLogin no`, смена пароля, `passwd -S root`.

### `linux.auth.no_password_policy`
- **Что делает**: ослабляет требования к паролям (pwquality/PAM) до `minlen=0` (best-effort).
- **Учебный сценарий**:
  - найти, что политика паролей ослаблена,
  - создать тестового пользователя/пароль “a” (в учебной среде) как доказательство,
  - исправить: включить минимальные требования и документировать параметры.
- **Проверка**:
  - файлы: `/etc/security/pwquality.conf`, PAM (`/etc/pam.d/common-password` или `password-auth/system-auth`).

### `linux.auth.extra_admin_user`
- **Что делает**: создаёт лишнюю привилегированную учётку в группе `sudo` со слабым паролем.
- **Учебный сценарий**:
  - найти “лишнюю” учётку (инвентаризация пользователей и групп),
  - доказать повышенные привилегии (`sudo -l`),
  - исправить: удалить/заблокировать учётку и почистить права.
- **Проверка**: `getent passwd`, `getent group sudo`, `sudo -l -U <user>`.

### `linux.sudo.nopasswd`
- **Что делает**: добавляет правило `NOPASSWD:ALL` для `%sudo`.
- **Учебный сценарий**:
  - обнаружить “sudo без пароля”,
  - показать риск (эскалация привилегий при компрометации обычной учётки),
  - исправить: убрать `NOPASSWD` и оставить нужные команды по принципу least privilege.
- **Проверка**: `sudo -l`, содержимое `/etc/sudoers.d/99-vkr-nopasswd`.

### `linux.priv.suid_bash_backdoor`
- **Что делает**: кладёт SUID-root bash `/usr/local/bin/vkrbash` (локальная эскалация).
- **Учебный сценарий**:
  - найти SUID/SGID файлы, обнаружить “нештатный” SUID bash,
  - доказать риск (показать, что `vkrbash -p` даёт root в учебной среде),
  - исправить: убрать SUID бит/удалить бинарник, добавить контроль SUID в аудит.
- **Проверка**:
  - `ls -l /usr/local/bin/vkrbash` (бит `s`),
  - `"/usr/local/bin/vkrbash -p -c id"`.

### `linux.ssh.root_login`
- **Что делает**: `PermitRootLogin yes`.
- **Учебный сценарий**:
  - обнаружить, что root разрешён по SSH,
  - исправить: `PermitRootLogin no` (или `prohibit-password`) + рестарт sshd.
- **Проверка**: `sshd -T | grep -i permitrootlogin`.

### `linux.ssh.password_auth`
- **Что делает**: `PasswordAuthentication yes`.
- **Учебный сценарий**:
  - обнаружить, что включена парольная аутентификация,
  - показать риск (bruteforce/credential stuffing),
  - исправить: `PasswordAuthentication no`, ключи, ограничение по группе/пользователю.
- **Проверка**: `sshd -T | grep -i passwordauthentication`.

### `linux.ssh.no_rate_limit`
- **Что делает**: ослабляет параметры защиты SSH (`MaxAuthTries 100`, `LoginGraceTime 120`).
- **Учебный сценарий**:
  - найти слабые параметры аутентификации,
  - исправить: понизить `MaxAuthTries`, сократить `LoginGraceTime`, добавить ограничение по пользователям/группам.
- **Проверка**: `sshd -T | egrep -i 'maxauthtries|logingracetime'`.

### `linux.firewall.disabled`
- **Что делает**: отключает `ufw`/`firewalld` (best-effort).
- **Учебный сценарий**:
  - обнаружить, что хост без firewall,
  - исправить: включить firewall и открыть только нужные порты (SSH/RDP и т.д.).
- **Проверка**: `ufw status`, `systemctl status ufw firewalld`.

### `linux.services.insecure_telnet`
- **Что делает**: ставит и пытается включить telnetd (best-effort).
- **Учебный сценарий**:
  - обнаружить сервис без шифрования,
  - показать риск (учётные данные в открытом виде),
  - исправить: отключить telnet, оставить SSH.
- **Проверка**: `ss -lntp | grep ':23'`, пакет/служба.

### `linux.services.insecure_ftp`
- **Что делает**: ставит `vsftpd` и включает insecure-настройки (anon + write).
- **Учебный сценарий**:
  - обнаружить FTP + опасные параметры конфигурации,
  - показать риск (anonymous upload / data exfil),
  - исправить: выключить anonymous, включить TLS (или удалить FTP и оставить SFTP).
- **Проверка**: `ss -lntp | grep ':21'`, `grep` по `/etc/vsftpd.conf`.

### `linux.files.world_writable_secrets`
- **Что делает**: создаёт `/opt/secret` и файл “credentials” с правами `0777`.
- **Учебный сценарий**:
  - найти “секреты” с world‑writable правами,
  - показать риск (любой пользователь может читать/менять),
  - исправить: `chmod/chown`, перенос в защищённое хранилище, минимизация прав.
- **Проверка**: `stat -c '%a %n' /opt/secret /opt/secret/credentials.txt`.

### `linux.files.unsafe_path_in_profile`
- **Что делает**: добавляет `/tmp` в начало `PATH` через `/etc/profile.d` (подмена бинарников).
- **Учебный сценарий**:
  - обнаружить, что в `PATH` впереди world-writable каталог,
  - показать риск (подмена исполняемого файла),
  - исправить: убрать `/tmp` из PATH, добавить контроль целостности профилей.
- **Проверка**:
  - `cat /etc/profile.d/vkr-unsafe-path.sh`,
  - `echo $PATH`.

### `linux.updates.disabled`
- **Что делает**: отключает авто‑обновления (apt timers / dnf-automatic / yum-cron), best-effort.
- **Учебный сценарий**:
  - обнаружить, что обновления выключены,
  - исправить: включить авто‑апдейты или регламент обновления,
  - зафиксировать политику (как часто/что обновляется).
- **Проверка**: `systemctl status apt-daily*.timer` / `dnf-automatic.timer`.

### `linux.logging.disabled`
- **Что делает**: отключает `rsyslog` и `auditd` (и journald на RHEL — best-effort).
- **Учебный сценарий**:
  - обнаружить отсутствие логирования/аудита,
  - исправить: включить сервисы, настроить retention и базовую фильтрацию.
- **Проверка**: `systemctl status rsyslog auditd systemd-journald`.

### `linux.cron.world_writable_cron`
- **Что делает**: world-writable cron (`/etc/cron.d/vkr-insecure`) запускает world-writable скрипт `/tmp/backup.sh`.
- **Учебный сценарий**:
  - обнаружить опасный cron (права + выполнение root),
  - показать риск (подмена `/tmp/backup.sh` → выполнение от root),
  - исправить: права 0644/0755, скрипт в защищённом каталоге, контроль владельца.
- **Проверка**: `stat -c '%a %n' /etc/cron.d/vkr-insecure /tmp/backup.sh`.

---

## Windows (роль `vuln_windows`)

### `windows.auth.lockout_disabled`
- **Что делает**: отключает lockout policy (через `net accounts`).
- **Учебный сценарий**:
  - обнаружить отсутствие блокировки при переборе,
  - исправить: включить lockout threshold/duration/window согласно политике.
- **Проверка**: `net accounts` (Lockout threshold = 0 до исправления).

### `windows.auth.weak_admin_password`
- **Что делает**: ставит слабый пароль `Administrator`.
- **Учебный сценарий**:
  - обнаружить слабую политику/пароль (косвенно),
  - исправить: сильный пароль + политика + запрет интерактивного входа где нужно.
- **Проверка**: практическая проверка входа (пароль напрямую не выводится).

### `windows.auth.no_password_policy`
- **Что делает**: ослабляет policy через `net accounts` (minpwlen=0, maxpwage=unlimited и т.п.).
- **Учебный сценарий**:
  - обнаружить слабую password policy,
  - исправить на разумные значения (min length/age/history).
- **Проверка**: `net accounts`.

### `windows.auth.guest_enabled`
- **Что делает**: включает `Guest`.
- **Учебный сценарий**:
  - обнаружить включённого Guest,
  - исправить: отключить, проверить локальные политики.
- **Проверка**: `net user guest`.

### `windows.priv.testadmin_in_admins`
- **Что делает**: создаёт лишнюю учётку и добавляет в `Administrators`.
- **Учебный сценарий**:
  - найти лишнего локального админа,
  - исправить: удалить/disable, провести ревизию.
- **Проверка**: `net localgroup Administrators`.

### `windows.remote.rdp_enabled`
- **Что делает**: включает RDP и пытается включить FW правила.
- **Учебный сценарий**:
  - обнаружить доступность RDP,
  - исправить: отключить или ограничить (NLA, группы, firewall, only VPN).
- **Проверка**: реестр `fDenyTSConnections=0`, порт `3389`.

### `windows.firewall.disabled`
- **Что делает**: выключает firewall для Domain/Public/Private.
- **Учебный сценарий**:
  - обнаружить отключенный firewall,
  - исправить: включить и задать минимальные правила.
- **Проверка**: `Get-NetFirewallProfile`.

### `windows.updates.disabled`
- **Что делает**: отключает сервисы Windows Update (best-effort).
- **Учебный сценарий**:
  - обнаружить отключенные обновления,
  - исправить: вернуть сервисы и регламент обновления.
- **Проверка**: `Get-Service wuauserv,usosvc,WaaSMedicSvc`.

### `windows.defender.disabled`
- **Что делает**: отключает Defender realtime и пытается отключить сервис (best-effort).
- **Учебный сценарий**:
  - обнаружить отключенную защиту,
  - исправить: вернуть Defender/политику.
- **Проверка**: `Get-MpPreference`, `Get-Service WinDefend`.

### `windows.network.smb1_enabled`
- **Что делает**: включает SMBv1 (best-effort).
- **Учебный сценарий**:
  - обнаружить SMBv1,
  - исправить: отключить SMBv1, проверить совместимость.
- **Проверка**: `Get-WindowsOptionalFeature ... SMB1Protocol` (или фича сервера).

### `windows.network.ntlmv1_enabled`
- **Что делает**: ослабляет NTLM/LM (`LmCompatibilityLevel=0`).
- **Учебный сценарий**:
  - обнаружить слабый режим аутентификации,
  - исправить: поднять LmCompatibilityLevel, запретить LM/NTLMv1.
- **Проверка**: `Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa`.

### `windows.network.llmnr_enabled`
- **Что делает**: включает LLMNR (policy-level).
- **Учебный сценарий**:
  - обнаружить включённый LLMNR,
  - исправить: отключить LLMNR через политику.
- **Проверка**: `Get-ItemProperty HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient`.

### `windows.network.smb_signing_disabled`
- **Что делает**: отключает SMB signing (Server/Workstation).
- **Учебный сценарий**:
  - обнаружить отключённый signing,
  - исправить: включить signing (особенно в домене).
- **Проверка**:
  - `Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters`,
  - `Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters`.

### `windows.services.remote_registry_enabled`
- **Что делает**: включает RemoteRegistry.
- **Учебный сценарий**:
  - обнаружить лишний сервис,
  - исправить: отключить/удалить при отсутствии необходимости.
- **Проверка**: `Get-Service RemoteRegistry`.

### `windows.uac.disabled`
- **Что делает**: отключает UAC (`EnableLUA=0`, с reboot).
- **Учебный сценарий**:
  - обнаружить отключенный UAC,
  - исправить: включить UAC и проверить политики.
- **Проверка**: `Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System`.

### `windows.desktop.no_lock_on_idle`
- **Что делает**: выключает блокировку/пароль при простое (policy-level screen saver).
- **Учебный сценарий**:
  - обнаружить, что auto-lock не настроен,
  - исправить: включить screen lock + password on resume, задать таймаут.
- **Проверка**: ключи `HKLM:\SOFTWARE\Policies\Microsoft\Windows\Control Panel\Desktop`.

### `windows.power.sleep_disabled`
- **Что делает**: выключает sleep/hibernate таймауты (Never).
- **Учебный сценарий**:
  - обнаружить, что рабочее место не уходит в сон/гибернацию,
  - исправить: задать таймауты и требование пароля при пробуждении.
- **Проверка**: `powercfg /query`.

---

## Active Directory / Domain Controller (роль `vuln_ad`)

### `ad.priv.user_in_domain_admins`
- **Что делает**: создаёт тестового доменного пользователя и добавляет его в `Domain Admins` (best-effort).
- **Учебный сценарий**:
  - обнаружить “лишнего” Domain Admin,
  - исправить: убрать из DA, пересмотреть делегирование прав, включить аудит изменений групп.
- **Проверка**: `Get-ADGroupMember "Domain Admins"`.

### `ad.auth.asrep_roastable_user`
- **Что делает**: создаёт пользователя с `DoesNotRequirePreAuth` (AS-REP roast) (best-effort).
- **Учебный сценарий**:
  - найти аккаунты без preauth,
  - исправить: включить preauth, пересмотреть сервисные аккаунты/пароли.
- **Проверка**: `Get-ADUser <user> -Properties DoesNotRequirePreAuth`.

### `ad.network.ldap_signing_disabled`
- **Что делает**: отключает требование LDAP signing (LDAPServerIntegrity=0) (best-effort).
- **Учебный сценарий**:
  - обнаружить слабые LDAP настройки,
  - исправить: включить signing/канал, проверить совместимость клиентов.
- **Проверка**: `Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters`.

### `ad.gpo.password_policy_weak`
- **Что делает**: делает доменную политику паролей “слабой” (minlen=0, complexity off, history=0, maxage=unlimited) (best-effort).
- **Учебный сценарий**:
  - проверить текущую доменную password policy,
  - оценить риски (слабые пароли, подбор),
  - исправить: включить разумные значения и задокументировать политику.
- **Проверка**: `Get-ADDefaultDomainPasswordPolicy`.

### `ad.gpo.account_lockout_disabled`
- **Что делает**: отключает доменный lockout (LockoutThreshold=0) (best-effort).
- **Учебный сценарий**:
  - обнаружить отсутствие блокировки,
  - исправить: включить lockout threshold/duration/window.
- **Проверка**: `Get-ADDefaultDomainPasswordPolicy` (LockoutThreshold).

### `ad.gpo.llmnr_enabled`
- **Что делает**: включает LLMNR через GPO на OU Training (best-effort).
- **Учебный сценарий**:
  - обнаружить, что LLMNR включён доменно,
  - объяснить риск spoofing/relay в доменной сети,
  - исправить: отключить LLMNR через GPO.
- **Проверка**: политика DNSClient `EnableMulticast=1` (после применения GPO).

### `ad.gpo.smb_signing_disabled`
- **Что делает**: отключает SMB signing доменно через GPO (best-effort).
- **Учебный сценарий**:
  - обнаружить отключенный signing,
  - объяснить риск NTLM relay/MITM,
  - исправить: включить signing (особенно для Domain профиль).
- **Проверка**: параметры LanmanServer/LanmanWorkstation (после применения GPO).

### `ad.gpo.ntlmv1_allowed`
- **Что делает**: разрешает слабый NTLM/LM (`LmCompatibilityLevel=0`) через GPO (best-effort).
- **Учебный сценарий**:
  - обнаружить слабые настройки NTLM,
  - исправить: запретить LM/NTLMv1, поднять уровень совместимости.
- **Проверка**: `Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa`.

### `ad.gpo.firewall_disabled`
- **Что делает**: выключает Windows Firewall (Domain/Public/Private) через GPO (best-effort).
- **Учебный сценарий**:
  - подтвердить, что FW выключен,
  - исправить: включить FW, оставить только нужные правила.
- **Проверка**: `Get-NetFirewallProfile`.

### `ad.gpo.defender_disabled`
- **Что делает**: пытается отключить Defender через политики (best-effort).
- **Учебный сценарий**:
  - проверить статус защиты,
  - исправить: включить Defender, включить tamper protection (если применимо).
- **Проверка**: `Get-MpPreference` / policy keys.

### `ad.gpo.updates_disabled`
- **Что делает**: отключает авто‑обновления Windows через GPO (NoAutoUpdate=1) (best-effort).
- **Учебный сценарий**:
  - обнаружить, что авто‑обновления выключены,
  - исправить: вернуть обновления/регламент/WSUS.
- **Проверка**: policy keys WindowsUpdate\AU.

### `ad.gpo.powershell_logging_disabled`
- **Что делает**: выключает PowerShell ScriptBlock/Module/Transcription logging через GPO (best-effort).
- **Учебный сценарий**:
  - оценить уровень видимости действий администратора,
  - исправить: включить logging и проверить события.
- **Проверка**: policy keys `...\\PowerShell\\*Logging`.

### `ad.gpo.audit_disabled`
- **Что делает**: выключает auditpol на DC (локально) (best-effort).
- **Учебный сценарий**:
  - проверить аудит,
  - исправить: включить необходимые категории и хранение логов.
- **Проверка**: `auditpol /get /category:*`.

### `ad.gpo.eventlog_retention_low`
- **Что делает**: уменьшает размер журналов и ускоряет перезапись через GPO (best-effort).
- **Учебный сценарий**:
  - проверить параметры журналов,
  - исправить: увеличить размер/retention, централизовать сбор.
- **Проверка**: policy keys `HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\*`.

### `ad.gpo.rdp_open_to_all`
- **Что делает**: включает RDP через GPO (best-effort).
- **Учебный сценарий**:
  - обнаружить, что RDP открыт,
  - исправить: ограничить доступ (группа, NLA, firewall, только VPN).
- **Проверка**: policy key `fDenyTSConnections=0`, порт 3389 доступен после gpupdate.

### `ad.gpo.winrm_insecure`
- **Что делает**: включает небезопасные настройки WinRM (AllowUnencrypted + Basic) через GPO (best-effort).
- **Учебный сценарий**:
  - обнаружить небезопасный WinRM,
  - исправить: запретить unencrypted/basic, оставить Kerberos/HTTPS.
- **Проверка**: policy keys `...\\WinRM\\Service` и `...\\WinRM\\Service\\Auth`.

### `ad.gpo.no_lock_on_idle`
- **Что делает**: отключает auto‑lock/пароль при простое через политики screen saver (best-effort).
- **Учебный сценарий**:
  - обнаружить отсутствие auto‑lock,
  - исправить: включить блокировку по таймауту и пароль при разблокировке.
- **Проверка**: policy keys `HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop`.
### `windows.audit.disabled`
- **Что делает**: отключает auditpol (best-effort).
- **Учебный сценарий**:
  - обнаружить, что аудит выключен,
  - исправить: включить базовые категории, настроить логирование.
- **Проверка**: `auditpol /get /category:*`.

